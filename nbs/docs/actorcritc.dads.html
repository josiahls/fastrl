---

title: DADS


keywords: fastai
sidebar: home_sidebar



nb_path: "nbs/17_actorcritc.dads.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: nbs/17_actorcritc.dads.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;CUDA_LAUNCH_BLOCKING&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;1&quot;</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<blockquote><p>Notes:Temporarily here. goal is convertion into pytorch</p>
</blockquote>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1">#</span>
<span class="c1"># Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<span class="c1"># you may not use this file except in compliance with the License.</span>
<span class="c1"># You may obtain a copy of the License at</span>
<span class="c1">#</span>
<span class="c1">#      http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="c1">#</span>
<span class="c1"># Unless required by applicable law or agreed to in writing, software</span>
<span class="c1"># distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span class="c1"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="c1"># See the License for the specific language governing permissions and</span>
<span class="c1"># limitations under the License.</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>
<span class="kn">import</span> <span class="nn">tensorflow_probability</span> <span class="k">as</span> <span class="nn">tfp</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_text output_error">
<pre>
<span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">ModuleNotFoundError</span>                       Traceback (most recent call last)
<span class="ansi-green-fg">&lt;ipython-input-10-2e3e83c0ea91&gt;</span> in <span class="ansi-cyan-fg">&lt;module&gt;</span>
<span class="ansi-green-intense-fg ansi-bold">     14</span> <span class="ansi-green-fg">import</span> os
<span class="ansi-green-intense-fg ansi-bold">     15</span> <span class="ansi-green-fg">import</span> numpy <span class="ansi-green-fg">as</span> np
<span class="ansi-green-fg">---&gt; 16</span><span class="ansi-red-fg"> </span><span class="ansi-green-fg">import</span> tensorflow <span class="ansi-green-fg">as</span> tf
<span class="ansi-green-intense-fg ansi-bold">     17</span> <span class="ansi-green-fg">import</span> tensorflow_probability <span class="ansi-green-fg">as</span> tfp
<span class="ansi-green-intense-fg ansi-bold">     18</span> 

<span class="ansi-red-fg">ModuleNotFoundError</span>: No module named &#39;tensorflow&#39;</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># TODO(architsh): Implement the dynamics with last K step input</span>
<span class="k">class</span> <span class="nc">SkillDynamics</span><span class="p">:</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
      <span class="n">observation_size</span><span class="p">,</span>
      <span class="n">action_size</span><span class="p">,</span>
      <span class="n">restrict_observation</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
      <span class="n">normalize_observations</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
      <span class="c1"># network properties</span>
      <span class="n">fc_layer_params</span><span class="o">=</span><span class="p">(</span><span class="mi">256</span><span class="p">,</span> <span class="mi">256</span><span class="p">),</span>
      <span class="n">network_type</span><span class="o">=</span><span class="s1">&#39;default&#39;</span><span class="p">,</span>
      <span class="n">num_components</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
      <span class="n">fix_variance</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
      <span class="n">reweigh_batches</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
      <span class="n">graph</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
      <span class="n">scope_name</span><span class="o">=</span><span class="s1">&#39;skill_dynamics&#39;</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_observation_size</span> <span class="o">=</span> <span class="n">observation_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_action_size</span> <span class="o">=</span> <span class="n">action_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_normalize_observations</span> <span class="o">=</span> <span class="n">normalize_observations</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_restrict_observation</span> <span class="o">=</span> <span class="n">restrict_observation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_reweigh_batches</span> <span class="o">=</span> <span class="n">reweigh_batches</span>

        <span class="c1"># tensorflow requirements</span>
        <span class="k">if</span> <span class="n">graph</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_graph</span> <span class="o">=</span> <span class="n">graph</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_graph</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">compat</span><span class="o">.</span><span class="n">v1</span><span class="o">.</span><span class="n">get_default_graph</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_scope_name</span> <span class="o">=</span> <span class="n">scope_name</span>

        <span class="c1"># dynamics network properties</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fc_layer_params</span> <span class="o">=</span> <span class="n">fc_layer_params</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_network_type</span> <span class="o">=</span> <span class="n">network_type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_num_components</span> <span class="o">=</span> <span class="n">num_components</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fix_variance</span> <span class="o">=</span> <span class="n">fix_variance</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fix_variance</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_std_lower_clip</span> <span class="o">=</span> <span class="mf">0.3</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_std_upper_clip</span> <span class="o">=</span> <span class="mf">10.0</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_use_placeholders</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_probability</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dyn_max_op</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dyn_min_op</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_session</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_use_modal_mean</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># saving/restoring variables</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_saver</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">_get_distribution</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">out</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_num_components</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logits</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">compat</span><span class="o">.</span><span class="n">v1</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">dense</span><span class="p">(</span>
              <span class="n">out</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_num_components</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;logits&#39;</span><span class="p">,</span> <span class="n">reuse</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">compat</span><span class="o">.</span><span class="n">v1</span><span class="o">.</span><span class="n">AUTO_REUSE</span><span class="p">)</span>
            <span class="n">means</span><span class="p">,</span> <span class="n">scale_diags</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">component_id</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_num_components</span><span class="p">):</span>
                <span class="n">means</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">tf</span><span class="o">.</span><span class="n">compat</span><span class="o">.</span><span class="n">v1</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">dense</span><span class="p">(</span>
                    <span class="n">out</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_observation_size</span><span class="p">,</span>
                    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;mean_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">component_id</span><span class="p">),</span>
                    <span class="n">reuse</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">compat</span><span class="o">.</span><span class="n">v1</span><span class="o">.</span><span class="n">AUTO_REUSE</span><span class="p">))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fix_variance</span><span class="p">:</span>
                <span class="n">scale_diags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                  <span class="n">tf</span><span class="o">.</span><span class="n">clip_by_value</span><span class="p">(</span>
                      <span class="n">tf</span><span class="o">.</span><span class="n">compat</span><span class="o">.</span><span class="n">v1</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">dense</span><span class="p">(</span>
                          <span class="n">out</span><span class="p">,</span>
                          <span class="bp">self</span><span class="o">.</span><span class="n">_observation_size</span><span class="p">,</span>
                          <span class="n">activation</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">softplus</span><span class="p">,</span>
                          <span class="n">name</span><span class="o">=</span><span class="s1">&#39;stddev_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">component_id</span><span class="p">),</span>
                          <span class="n">reuse</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">compat</span><span class="o">.</span><span class="n">v1</span><span class="o">.</span><span class="n">AUTO_REUSE</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_std_lower_clip</span><span class="p">,</span>
                      <span class="bp">self</span><span class="o">.</span><span class="n">_std_upper_clip</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">scale_diags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                  <span class="n">tf</span><span class="o">.</span><span class="n">fill</span><span class="p">([</span><span class="n">tf</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">out</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_observation_size</span><span class="p">],</span> <span class="mf">1.0</span><span class="p">))</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">means</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">means</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scale_diags</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">scale_diags</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">tfp</span><span class="o">.</span><span class="n">distributions</span><span class="o">.</span><span class="n">MixtureSameFamily</span><span class="p">(</span>
              <span class="n">mixture_distribution</span><span class="o">=</span><span class="n">tfp</span><span class="o">.</span><span class="n">distributions</span><span class="o">.</span><span class="n">Categorical</span><span class="p">(</span>
                  <span class="n">logits</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">logits</span><span class="p">),</span>
              <span class="n">components_distribution</span><span class="o">=</span><span class="n">tfp</span><span class="o">.</span><span class="n">distributions</span><span class="o">.</span><span class="n">MultivariateNormalDiag</span><span class="p">(</span>
                  <span class="n">loc</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">means</span><span class="p">,</span> <span class="n">scale_diag</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">scale_diags</span><span class="p">))</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">mean</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">compat</span><span class="o">.</span><span class="n">v1</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">dense</span><span class="p">(</span>
              <span class="n">out</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_observation_size</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="n">reuse</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">compat</span><span class="o">.</span><span class="n">v1</span><span class="o">.</span><span class="n">AUTO_REUSE</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fix_variance</span><span class="p">:</span>
                <span class="n">stddev</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">clip_by_value</span><span class="p">(</span>
                <span class="n">tf</span><span class="o">.</span><span class="n">compat</span><span class="o">.</span><span class="n">v1</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">dense</span><span class="p">(</span>
                    <span class="n">out</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_observation_size</span><span class="p">,</span>
                    <span class="n">activation</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">softplus</span><span class="p">,</span>
                    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;stddev&#39;</span><span class="p">,</span>
                    <span class="n">reuse</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">compat</span><span class="o">.</span><span class="n">v1</span><span class="o">.</span><span class="n">AUTO_REUSE</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_std_lower_clip</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_std_upper_clip</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">stddev</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">fill</span><span class="p">([</span><span class="n">tf</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">out</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_observation_size</span><span class="p">],</span> <span class="mf">1.0</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">tfp</span><span class="o">.</span><span class="n">distributions</span><span class="o">.</span><span class="n">MultivariateNormalDiag</span><span class="p">(</span>
              <span class="n">loc</span><span class="o">=</span><span class="n">mean</span><span class="p">,</span> <span class="n">scale_diag</span><span class="o">=</span><span class="n">stddev</span><span class="p">)</span>

    <span class="c1"># dynamics graph with separate pipeline for skills and timesteps</span>
    <span class="k">def</span> <span class="nf">_graph_with_separate_skill_pipe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timesteps</span><span class="p">,</span> <span class="n">actions</span><span class="p">):</span>
        <span class="n">skill_out</span> <span class="o">=</span> <span class="n">actions</span>
        <span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">compat</span><span class="o">.</span><span class="n">v1</span><span class="o">.</span><span class="n">variable_scope</span><span class="p">(</span><span class="s1">&#39;action_pipe&#39;</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">layer_size</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">_fc_layer_params</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,)):</span>
                <span class="n">skill_out</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">compat</span><span class="o">.</span><span class="n">v1</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">dense</span><span class="p">(</span>
                  <span class="n">skill_out</span><span class="p">,</span>
                  <span class="n">layer_size</span><span class="p">,</span>
                  <span class="n">activation</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">relu</span><span class="p">,</span>
                  <span class="n">name</span><span class="o">=</span><span class="s1">&#39;hid_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">idx</span><span class="p">),</span>
                  <span class="n">reuse</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">compat</span><span class="o">.</span><span class="n">v1</span><span class="o">.</span><span class="n">AUTO_REUSE</span><span class="p">)</span>

        <span class="n">ts_out</span> <span class="o">=</span> <span class="n">timesteps</span>
        <span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">compat</span><span class="o">.</span><span class="n">v1</span><span class="o">.</span><span class="n">variable_scope</span><span class="p">(</span><span class="s1">&#39;ts_pipe&#39;</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">layer_size</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">_fc_layer_params</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,)):</span>
                <span class="n">ts_out</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">compat</span><span class="o">.</span><span class="n">v1</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">dense</span><span class="p">(</span>
                  <span class="n">ts_out</span><span class="p">,</span>
                  <span class="n">layer_size</span><span class="p">,</span>
                  <span class="n">activation</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">relu</span><span class="p">,</span>
                  <span class="n">name</span><span class="o">=</span><span class="s1">&#39;hid_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">idx</span><span class="p">),</span>
                  <span class="n">reuse</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">compat</span><span class="o">.</span><span class="n">v1</span><span class="o">.</span><span class="n">AUTO_REUSE</span><span class="p">)</span>

        <span class="c1"># out = tf.compat.v1.layers.flatten(tf.einsum(&#39;ai,aj-&gt;aij&#39;, ts_out, skill_out))</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">ts_out</span><span class="p">,</span> <span class="n">skill_out</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">compat</span><span class="o">.</span><span class="n">v1</span><span class="o">.</span><span class="n">variable_scope</span><span class="p">(</span><span class="s1">&#39;joint&#39;</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">layer_size</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fc_layer_param</span><span class="p">[</span><span class="mi">1</span><span class="p">:]):</span>
                <span class="n">out</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">compat</span><span class="o">.</span><span class="n">v1</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">dense</span><span class="p">(</span>
                  <span class="n">out</span><span class="p">,</span>
                  <span class="n">layer_size</span><span class="p">,</span>
                  <span class="n">activation</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">relu</span><span class="p">,</span>
                  <span class="n">name</span><span class="o">=</span><span class="s1">&#39;hid_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">idx</span><span class="p">),</span>
                  <span class="n">reuse</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">compat</span><span class="o">.</span><span class="n">v1</span><span class="o">.</span><span class="n">AUTO_REUSE</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_distribution</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>

    <span class="c1"># simple dynamics graph</span>
    <span class="k">def</span> <span class="nf">_default_graph</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timesteps</span><span class="p">,</span> <span class="n">actions</span><span class="p">):</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">timesteps</span><span class="p">,</span> <span class="n">actions</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">layer_size</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fc_layer_params</span><span class="p">):</span>
            <span class="n">out</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">compat</span><span class="o">.</span><span class="n">v1</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">dense</span><span class="p">(</span>
                <span class="n">out</span><span class="p">,</span>
                <span class="n">layer_size</span><span class="p">,</span>
                <span class="n">activation</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">relu</span><span class="p">,</span>
                <span class="n">name</span><span class="o">=</span><span class="s1">&#39;hid_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">idx</span><span class="p">),</span>
                <span class="n">reuse</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">compat</span><span class="o">.</span><span class="n">v1</span><span class="o">.</span><span class="n">AUTO_REUSE</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_distribution</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                <span class="n">input_data</span><span class="p">,</span>
                <span class="n">input_actions</span><span class="p">,</span>
                <span class="n">target_data</span><span class="p">,</span>
                <span class="n">batch_size</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
                <span class="n">batch_weights</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">batch_norm</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">noise_targets</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">noise_std</span><span class="o">=</span><span class="mf">0.5</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">batch_size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">shuffled_batch</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">permutation</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">input_data</span><span class="p">))[:</span><span class="n">batch_size</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">shuffled_batch</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">input_data</span><span class="p">))</span>

        <span class="c1"># if we are noising the input, it is better to create a new copy of the numpy arrays</span>
        <span class="n">batched_input</span> <span class="o">=</span> <span class="n">input_data</span><span class="p">[</span><span class="n">shuffled_batch</span><span class="p">,</span> <span class="p">:]</span>
        <span class="n">batched_skills</span> <span class="o">=</span> <span class="n">input_actions</span><span class="p">[</span><span class="n">shuffled_batch</span><span class="p">,</span> <span class="p">:]</span>
        <span class="n">batched_targets</span> <span class="o">=</span> <span class="n">target_data</span><span class="p">[</span><span class="n">shuffled_batch</span><span class="p">,</span> <span class="p">:]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reweigh_batches</span> <span class="ow">and</span> <span class="n">batch_weights</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">example_weights</span> <span class="o">=</span> <span class="n">batch_weights</span><span class="p">[</span><span class="n">shuffled_batch</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">noise_targets</span><span class="p">:</span>
            <span class="n">batched_targets</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="o">*</span><span class="n">batched_targets</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">*</span> <span class="n">noise_std</span>

        <span class="n">return_dict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">timesteps_pl</span><span class="p">:</span> <span class="n">batched_input</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">actions_pl</span><span class="p">:</span> <span class="n">batched_skills</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">next_timesteps_pl</span><span class="p">:</span> <span class="n">batched_targets</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_normalize_observations</span><span class="p">:</span>
            <span class="n">return_dict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">is_training_pl</span><span class="p">]</span> <span class="o">=</span> <span class="n">batch_norm</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reweigh_batches</span> <span class="ow">and</span> <span class="n">batch_weights</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">return_dict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_weights</span><span class="p">]</span> <span class="o">=</span> <span class="n">example_weights</span>

        <span class="k">return</span> <span class="n">return_dict</span>

    <span class="k">def</span> <span class="nf">_get_run_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_data</span><span class="p">,</span> <span class="n">input_actions</span><span class="p">):</span>
        <span class="n">return_dict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">timesteps_pl</span><span class="p">:</span> <span class="n">input_data</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">actions_pl</span><span class="p">:</span> <span class="n">input_actions</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_normalize_observations</span><span class="p">:</span>
            <span class="n">return_dict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">is_training_pl</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">return</span> <span class="n">return_dict</span>

    <span class="k">def</span> <span class="nf">make_placeholders</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_use_placeholders</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_graph</span><span class="o">.</span><span class="n">as_default</span><span class="p">(),</span> <span class="n">tf</span><span class="o">.</span><span class="n">compat</span><span class="o">.</span><span class="n">v1</span><span class="o">.</span><span class="n">variable_scope</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_scope_name</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">timesteps_pl</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">compat</span><span class="o">.</span><span class="n">v1</span><span class="o">.</span><span class="n">placeholder</span><span class="p">(</span>
              <span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_observation_size</span><span class="p">),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;timesteps_pl&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">actions_pl</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">compat</span><span class="o">.</span><span class="n">v1</span><span class="o">.</span><span class="n">placeholder</span><span class="p">(</span>
              <span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_action_size</span><span class="p">),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;actions_pl&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">next_timesteps_pl</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">compat</span><span class="o">.</span><span class="n">v1</span><span class="o">.</span><span class="n">placeholder</span><span class="p">(</span>
              <span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span>
              <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_observation_size</span><span class="p">),</span>
              <span class="n">name</span><span class="o">=</span><span class="s1">&#39;next_timesteps_pl&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_normalize_observations</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">is_training_pl</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">compat</span><span class="o">.</span><span class="n">v1</span><span class="o">.</span><span class="n">placeholder</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">bool</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;batch_norm_pl&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reweigh_batches</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">batch_weights</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">compat</span><span class="o">.</span><span class="n">v1</span><span class="o">.</span><span class="n">placeholder</span><span class="p">(</span>
                    <span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="kc">None</span><span class="p">,),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;importance_sampled_weights&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">set_session</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">initialize_or_restore_variables</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">session</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_session</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">Session</span><span class="p">(</span><span class="n">graph</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_graph</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_session</span> <span class="o">=</span> <span class="n">session</span>

        <span class="c1"># only initialize uninitialized variables</span>
        <span class="k">if</span> <span class="n">initialize_or_restore_variables</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">tf</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">gfile</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_save_prefix</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">restore_variables</span><span class="p">()</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_graph</span><span class="o">.</span><span class="n">as_default</span><span class="p">():</span>
                <span class="n">var_list</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">compat</span><span class="o">.</span><span class="n">v1</span><span class="o">.</span><span class="n">global_variables</span><span class="p">(</span>
                <span class="p">)</span> <span class="o">+</span> <span class="n">tf</span><span class="o">.</span><span class="n">compat</span><span class="o">.</span><span class="n">v1</span><span class="o">.</span><span class="n">local_variables</span><span class="p">()</span>
                <span class="n">is_initialized</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_session</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
                    <span class="p">[</span><span class="n">tf</span><span class="o">.</span><span class="n">compat</span><span class="o">.</span><span class="n">v1</span><span class="o">.</span><span class="n">is_variable_initialized</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">var_list</span><span class="p">])</span>
                <span class="n">uninitialized_vars</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">flag</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">is_initialized</span><span class="p">,</span> <span class="n">var_list</span><span class="p">):</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">flag</span><span class="p">:</span>
                        <span class="n">uninitialized_vars</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">uninitialized_vars</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_session</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
                      <span class="n">tf</span><span class="o">.</span><span class="n">compat</span><span class="o">.</span><span class="n">v1</span><span class="o">.</span><span class="n">variables_initializer</span><span class="p">(</span><span class="n">uninitialized_vars</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">build_graph</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                  <span class="n">timesteps</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                  <span class="n">actions</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                  <span class="n">next_timesteps</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                  <span class="n">is_training</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_graph</span><span class="o">.</span><span class="n">as_default</span><span class="p">(),</span> <span class="n">tf</span><span class="o">.</span><span class="n">compat</span><span class="o">.</span><span class="n">v1</span><span class="o">.</span><span class="n">variable_scope</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_scope_name</span><span class="p">,</span> <span class="n">reuse</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">compat</span><span class="o">.</span><span class="n">v1</span><span class="o">.</span><span class="n">AUTO_REUSE</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_use_placeholders</span><span class="p">:</span>
                <span class="n">timesteps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">timesteps_pl</span>
                <span class="n">actions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">actions_pl</span>
                <span class="n">next_timesteps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">next_timesteps_pl</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_normalize_observations</span><span class="p">:</span>
                <span class="n">is_training</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_training_pl</span>

            <span class="c1"># predict deltas instead of observations</span>
            <span class="n">next_timesteps</span> <span class="o">-=</span> <span class="n">timesteps</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_restrict_observation</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">timesteps</span> <span class="o">=</span> <span class="n">timesteps</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_restrict_observation</span><span class="p">:]</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_normalize_observations</span><span class="p">:</span>
                <span class="n">timesteps</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">compat</span><span class="o">.</span><span class="n">v1</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">batch_normalization</span><span class="p">(</span>
                <span class="n">timesteps</span><span class="p">,</span>
                <span class="n">training</span><span class="o">=</span><span class="n">is_training</span><span class="p">,</span>
                <span class="n">name</span><span class="o">=</span><span class="s1">&#39;input_normalization&#39;</span><span class="p">,</span>
                <span class="n">reuse</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">compat</span><span class="o">.</span><span class="n">v1</span><span class="o">.</span><span class="n">AUTO_REUSE</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">output_norm_layer</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">compat</span><span class="o">.</span><span class="n">v1</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">BatchNormalization</span><span class="p">(</span>
                <span class="n">scale</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;output_normalization&#39;</span><span class="p">)</span>
                <span class="n">next_timesteps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_norm_layer</span><span class="p">(</span>
                <span class="n">next_timesteps</span><span class="p">,</span> <span class="n">training</span><span class="o">=</span><span class="n">is_training</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_network_type</span> <span class="o">==</span> <span class="s1">&#39;default&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">base_distribution</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_default_graph</span><span class="p">(</span><span class="n">timesteps</span><span class="p">,</span> <span class="n">actions</span><span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_network_type</span> <span class="o">==</span> <span class="s1">&#39;separate&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">base_distribution</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_graph_with_separate_skill_pipe</span><span class="p">(</span>
                <span class="n">timesteps</span><span class="p">,</span> <span class="n">actions</span><span class="p">)</span>

            <span class="c1"># if building multiple times, be careful about which log_prob you are optimizing</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log_probability</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_distribution</span><span class="o">.</span><span class="n">log_prob</span><span class="p">(</span><span class="n">next_timesteps</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mean</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_distribution</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_probability</span>

    <span class="k">def</span> <span class="nf">increase_prob_op</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">learning_rate</span><span class="o">=</span><span class="mf">3e-4</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_graph</span><span class="o">.</span><span class="n">as_default</span><span class="p">():</span>
            <span class="n">update_ops</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">compat</span><span class="o">.</span><span class="n">v1</span><span class="o">.</span><span class="n">get_collection</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">compat</span><span class="o">.</span><span class="n">v1</span><span class="o">.</span><span class="n">GraphKeys</span><span class="o">.</span><span class="n">UPDATE_OPS</span><span class="p">)</span>
            <span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">control_dependencies</span><span class="p">(</span><span class="n">update_ops</span><span class="p">):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reweigh_batches</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">dyn_max_op</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">compat</span><span class="o">.</span><span class="n">v1</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">AdamOptimizer</span><span class="p">(</span>
                      <span class="n">learning_rate</span><span class="o">=</span><span class="n">learning_rate</span><span class="p">,</span>
                      <span class="n">name</span><span class="o">=</span><span class="s1">&#39;adam_max&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span><span class="o">-</span><span class="n">tf</span><span class="o">.</span><span class="n">reduce_mean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">log_probability</span> <span class="o">*</span>
                                                                <span class="bp">self</span><span class="o">.</span><span class="n">batch_weights</span><span class="p">))</span>
                <span class="k">elif</span> <span class="n">weights</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">dyn_max_op</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">compat</span><span class="o">.</span><span class="n">v1</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">AdamOptimizer</span><span class="p">(</span>
                      <span class="n">learning_rate</span><span class="o">=</span><span class="n">learning_rate</span><span class="p">,</span>
                      <span class="n">name</span><span class="o">=</span><span class="s1">&#39;adam_max&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span><span class="o">-</span><span class="n">tf</span><span class="o">.</span><span class="n">reduce_mean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">log_probability</span> <span class="o">*</span>
                                                                <span class="n">weights</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">dyn_max_op</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">compat</span><span class="o">.</span><span class="n">v1</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">AdamOptimizer</span><span class="p">(</span>
                      <span class="n">learning_rate</span><span class="o">=</span><span class="n">learning_rate</span><span class="p">,</span>
                      <span class="n">name</span><span class="o">=</span><span class="s1">&#39;adam_max&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span><span class="o">-</span><span class="n">tf</span><span class="o">.</span><span class="n">reduce_mean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">log_probability</span><span class="p">))</span>

                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dyn_max_op</span>

    <span class="k">def</span> <span class="nf">decrease_prob_op</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">learning_rate</span><span class="o">=</span><span class="mf">3e-4</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_graph</span><span class="o">.</span><span class="n">as_default</span><span class="p">():</span>
            <span class="n">update_ops</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">compat</span><span class="o">.</span><span class="n">v1</span><span class="o">.</span><span class="n">get_collection</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">compat</span><span class="o">.</span><span class="n">v1</span><span class="o">.</span><span class="n">GraphKeys</span><span class="o">.</span><span class="n">UPDATE_OPS</span><span class="p">)</span>
            <span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">control_dependencies</span><span class="p">(</span><span class="n">update_ops</span><span class="p">):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reweigh_batches</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">dyn_min_op</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">compat</span><span class="o">.</span><span class="n">v1</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">AdamOptimizer</span><span class="p">(</span>
                      <span class="n">learning_rate</span><span class="o">=</span><span class="n">learning_rate</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;adam_min&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span>
                          <span class="n">tf</span><span class="o">.</span><span class="n">reduce_mean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">log_probability</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_weights</span><span class="p">))</span>
                <span class="k">elif</span> <span class="n">weights</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">dyn_min_op</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">compat</span><span class="o">.</span><span class="n">v1</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">AdamOptimizer</span><span class="p">(</span>
                      <span class="n">learning_rate</span><span class="o">=</span><span class="n">learning_rate</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;adam_min&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span>
                          <span class="n">tf</span><span class="o">.</span><span class="n">reduce_mean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">log_probability</span> <span class="o">*</span> <span class="n">weights</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">dyn_min_op</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">compat</span><span class="o">.</span><span class="n">v1</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">AdamOptimizer</span><span class="p">(</span>
                      <span class="n">learning_rate</span><span class="o">=</span><span class="n">learning_rate</span><span class="p">,</span>
                      <span class="n">name</span><span class="o">=</span><span class="s1">&#39;adam_min&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">reduce_mean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">log_probability</span><span class="p">))</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dyn_min_op</span>

    <span class="k">def</span> <span class="nf">create_saver</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">save_prefix</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_saver</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_saver</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_graph</span><span class="o">.</span><span class="n">as_default</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_variable_list</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">tf</span><span class="o">.</span><span class="n">compat</span><span class="o">.</span><span class="n">v1</span><span class="o">.</span><span class="n">get_collection</span><span class="p">(</span>
                    <span class="n">tf</span><span class="o">.</span><span class="n">compat</span><span class="o">.</span><span class="n">v1</span><span class="o">.</span><span class="n">GraphKeys</span><span class="o">.</span><span class="n">GLOBAL_VARIABLES</span><span class="p">,</span> <span class="n">scope</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_scope_name</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_variable_list</span><span class="p">[</span><span class="n">var</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">var</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_saver</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">compat</span><span class="o">.</span><span class="n">v1</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">Saver</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_variable_list</span><span class="p">,</span> <span class="n">save_relative_paths</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_save_prefix</span> <span class="o">=</span> <span class="n">save_prefix</span>

    <span class="k">def</span> <span class="nf">save_variables</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">global_step</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">tf</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">gfile</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_save_prefix</span><span class="p">):</span>
            <span class="n">tf</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">gfile</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_save_prefix</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_saver</span><span class="o">.</span><span class="n">save</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_session</span><span class="p">,</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_save_prefix</span><span class="p">,</span> <span class="s1">&#39;ckpt&#39;</span><span class="p">),</span>
            <span class="n">global_step</span><span class="o">=</span><span class="n">global_step</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">restore_variables</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_saver</span><span class="o">.</span><span class="n">restore</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_session</span><span class="p">,</span>
                            <span class="n">tf</span><span class="o">.</span><span class="n">compat</span><span class="o">.</span><span class="n">v1</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">latest_checkpoint</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_save_prefix</span><span class="p">))</span>

    <span class="c1"># all functions here-on require placeholders----------------------------------</span>
    <span class="k">def</span> <span class="nf">train</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
            <span class="n">timesteps</span><span class="p">,</span>
            <span class="n">actions</span><span class="p">,</span>
            <span class="n">next_timesteps</span><span class="p">,</span>
            <span class="n">batch_weights</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">batch_size</span><span class="o">=</span><span class="mi">512</span><span class="p">,</span>
            <span class="n">num_steps</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">increase_probs</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_use_placeholders</span><span class="p">:</span><span class="k">return</span>

        <span class="k">if</span> <span class="n">increase_probs</span><span class="p">:</span> <span class="n">run_op</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dyn_max_op</span>
        <span class="k">else</span><span class="p">:</span> <span class="n">run_op</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dyn_min_op</span>

        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_steps</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_session</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
              <span class="n">run_op</span><span class="p">,</span>
              <span class="n">feed_dict</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_dict</span><span class="p">(</span>
                  <span class="n">timesteps</span><span class="p">,</span>
                  <span class="n">actions</span><span class="p">,</span>
                  <span class="n">next_timesteps</span><span class="p">,</span>
                  <span class="n">batch_weights</span><span class="o">=</span><span class="n">batch_weights</span><span class="p">,</span>
                  <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
                  <span class="n">batch_norm</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">get_log_prob</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timesteps</span><span class="p">,</span> <span class="n">actions</span><span class="p">,</span> <span class="n">next_timesteps</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_use_placeholders</span><span class="p">:</span><span class="k">return</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_session</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log_probability</span><span class="p">,</span>
            <span class="n">feed_dict</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_dict</span><span class="p">(</span>
                <span class="n">timesteps</span><span class="p">,</span> <span class="n">actions</span><span class="p">,</span> <span class="n">next_timesteps</span><span class="p">,</span> <span class="n">batch_norm</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">predict_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timesteps</span><span class="p">,</span> <span class="n">actions</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_use_placeholders</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_use_modal_mean</span><span class="p">:</span>
            <span class="n">all_means</span><span class="p">,</span> <span class="n">modal_mean_indices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_session</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
              <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">means</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">logits</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)],</span>
              <span class="n">feed_dict</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_run_dict</span><span class="p">(</span><span class="n">timesteps</span><span class="p">,</span> <span class="n">actions</span><span class="p">))</span>
            <span class="n">pred_state</span> <span class="o">=</span> <span class="n">all_means</span><span class="p">[[</span>
              <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">all_means</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">modal_mean_indices</span>
          <span class="p">]]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pred_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_session</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
              <span class="bp">self</span><span class="o">.</span><span class="n">mean</span><span class="p">,</span> <span class="n">feed_dict</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_run_dict</span><span class="p">(</span><span class="n">timesteps</span><span class="p">,</span> <span class="n">actions</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_normalize_observations</span><span class="p">:</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_session</span><span class="o">.</span><span class="n">as_default</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_graph</span><span class="o">.</span><span class="n">as_default</span><span class="p">():</span>
                <span class="n">mean_correction</span><span class="p">,</span> <span class="n">variance_correction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_norm_layer</span><span class="o">.</span><span class="n">get_weights</span><span class="p">(</span>
                <span class="p">)</span>

            <span class="n">pred_state</span> <span class="o">=</span> <span class="n">pred_state</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">variance_correction</span> <span class="o">+</span>
                                                <span class="mf">1e-3</span><span class="p">)</span> <span class="o">+</span> <span class="n">mean_correction</span>

        <span class="n">pred_state</span> <span class="o">+=</span> <span class="n">timesteps</span>
        <span class="k">return</span> <span class="n">pred_state</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_text output_error">
<pre>
<span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">ModuleNotFoundError</span>                       Traceback (most recent call last)
<span class="ansi-green-fg">&lt;ipython-input-9-572acb1c60fe&gt;</span> in <span class="ansi-cyan-fg">&lt;module&gt;</span>
<span class="ansi-green-intense-fg ansi-bold">     14</span> <span class="ansi-green-fg">import</span> os
<span class="ansi-green-intense-fg ansi-bold">     15</span> <span class="ansi-green-fg">import</span> numpy <span class="ansi-green-fg">as</span> np
<span class="ansi-green-fg">---&gt; 16</span><span class="ansi-red-fg"> </span><span class="ansi-green-fg">import</span> tensorflow <span class="ansi-green-fg">as</span> tf
<span class="ansi-green-intense-fg ansi-bold">     17</span> <span class="ansi-green-fg">import</span> tensorflow_probability <span class="ansi-green-fg">as</span> tfp
<span class="ansi-green-intense-fg ansi-bold">     18</span> 

<span class="ansi-red-fg">ModuleNotFoundError</span>: No module named &#39;tensorflow&#39;</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">DADSAgent</span><span class="p">(</span><span class="n">SAC</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
               <span class="n">save_directory</span><span class="p">,</span>
               <span class="n">skill_dynamics_observation_size</span><span class="p">,</span>
               <span class="n">observation_modify_fn</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
               <span class="n">restrict_input_size</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
               <span class="n">latent_size</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
               <span class="n">latent_prior</span><span class="o">=</span><span class="s1">&#39;cont_uniform&#39;</span><span class="p">,</span>
               <span class="n">prior_samples</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
               <span class="n">fc_layer_params</span><span class="o">=</span><span class="p">(</span><span class="mi">256</span><span class="p">,</span> <span class="mi">256</span><span class="p">),</span>
               <span class="n">normalize_observations</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
               <span class="n">network_type</span><span class="o">=</span><span class="s1">&#39;default&#39;</span><span class="p">,</span>
               <span class="n">num_mixture_components</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
               <span class="n">fix_variance</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
               <span class="n">skill_dynamics_learning_rate</span><span class="o">=</span><span class="mf">3e-4</span><span class="p">,</span>
               <span class="n">reweigh_batches</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
               <span class="n">agent_graph</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
               <span class="n">skill_dynamics_graph</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
               <span class="o">*</span><span class="n">sac_args</span><span class="p">,</span>
               <span class="o">**</span><span class="n">sac_kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_skill_dynamics_learning_rate</span> <span class="o">=</span> <span class="n">skill_dynamics_learning_rate</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_latent_size</span> <span class="o">=</span> <span class="n">latent_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_latent_prior</span> <span class="o">=</span> <span class="n">latent_prior</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_prior_samples</span> <span class="o">=</span> <span class="n">prior_samples</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_save_directory</span> <span class="o">=</span> <span class="n">save_directory</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_restrict_input_size</span> <span class="o">=</span> <span class="n">restrict_input_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_process_observation</span> <span class="o">=</span> <span class="n">observation_modify_fn</span>

        <span class="k">if</span> <span class="n">agent_graph</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_graph</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">compat</span><span class="o">.</span><span class="n">v1</span><span class="o">.</span><span class="n">get_default_graph</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_graph</span> <span class="o">=</span> <span class="n">agent_graph</span>

        <span class="k">if</span> <span class="n">skill_dynamics_graph</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">skill_dynamics_graph</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_graph</span>

        <span class="c1"># instantiate the skill dynamics</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_skill_dynamics</span> <span class="o">=</span> <span class="n">skill_dynamics</span><span class="o">.</span><span class="n">SkillDynamics</span><span class="p">(</span>
            <span class="n">observation_size</span><span class="o">=</span><span class="n">skill_dynamics_observation_size</span><span class="p">,</span>
            <span class="n">action_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_latent_size</span><span class="p">,</span>
            <span class="n">restrict_observation</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_restrict_input_size</span><span class="p">,</span>
            <span class="n">normalize_observations</span><span class="o">=</span><span class="n">normalize_observations</span><span class="p">,</span>
            <span class="n">fc_layer_params</span><span class="o">=</span><span class="n">fc_layer_params</span><span class="p">,</span>
            <span class="n">network_type</span><span class="o">=</span><span class="n">network_type</span><span class="p">,</span>
            <span class="n">num_components</span><span class="o">=</span><span class="n">num_mixture_components</span><span class="p">,</span>
            <span class="n">fix_variance</span><span class="o">=</span><span class="n">fix_variance</span><span class="p">,</span>
            <span class="n">reweigh_batches</span><span class="o">=</span><span class="n">reweigh_batches</span><span class="p">,</span>
            <span class="n">graph</span><span class="o">=</span><span class="n">skill_dynamics_graph</span><span class="p">)</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">DADSAgent</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">sac_args</span><span class="p">,</span> <span class="o">**</span><span class="n">sac_kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_placeholders_in_place</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">compute_dads_reward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_obs</span><span class="p">,</span> <span class="n">cur_skill</span><span class="p">,</span> <span class="n">target_obs</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_observation</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">input_obs</span><span class="p">,</span> <span class="n">target_obs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_observation</span><span class="p">(</span>
              <span class="n">input_obs</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_observation</span><span class="p">(</span><span class="n">target_obs</span><span class="p">)</span>

        <span class="n">num_reps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prior_samples</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prior_samples</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">_latent_size</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="n">input_obs_altz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">input_obs</span><span class="p">]</span> <span class="o">*</span> <span class="n">num_reps</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">target_obs_altz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">target_obs</span><span class="p">]</span> <span class="o">*</span> <span class="n">num_reps</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># for marginalization of the denominator</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_latent_prior</span> <span class="o">==</span> <span class="s1">&#39;discrete_uniform&#39;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prior_samples</span><span class="p">:</span>
            <span class="n">alt_skill</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
              <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">cur_skill</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_reps</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)],</span>
              <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_latent_prior</span> <span class="o">==</span> <span class="s1">&#39;discrete_uniform&#39;</span><span class="p">:</span>
            <span class="n">alt_skill</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">multinomial</span><span class="p">(</span>
              <span class="mi">1</span><span class="p">,</span> <span class="p">[</span><span class="mf">1.</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_latent_size</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_latent_size</span><span class="p">,</span>
              <span class="n">size</span><span class="o">=</span><span class="n">input_obs_altz</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_latent_prior</span> <span class="o">==</span> <span class="s1">&#39;gaussian&#39;</span><span class="p">:</span>
            <span class="n">alt_skill</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">multivariate_normal</span><span class="p">(</span>
              <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_latent_size</span><span class="p">),</span>
              <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_latent_size</span><span class="p">),</span>
              <span class="n">size</span><span class="o">=</span><span class="n">input_obs_altz</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_latent_prior</span> <span class="o">==</span> <span class="s1">&#39;cont_uniform&#39;</span><span class="p">:</span>
            <span class="n">alt_skill</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span>
              <span class="n">low</span><span class="o">=-</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">high</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">input_obs_altz</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_latent_size</span><span class="p">))</span>

        <span class="n">logp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_skill_dynamics</span><span class="o">.</span><span class="n">get_log_prob</span><span class="p">(</span><span class="n">input_obs</span><span class="p">,</span> <span class="n">cur_skill</span><span class="p">,</span> <span class="n">target_obs</span><span class="p">)</span>

        <span class="c1"># denominator may require more memory than that of a GPU, break computation</span>
        <span class="n">split_group</span> <span class="o">=</span> <span class="mi">20</span> <span class="o">*</span> <span class="mi">4000</span>
        <span class="k">if</span> <span class="n">input_obs_altz</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">split_group</span><span class="p">:</span>
            <span class="n">logp_altz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_skill_dynamics</span><span class="o">.</span><span class="n">get_log_prob</span><span class="p">(</span><span class="n">input_obs_altz</span><span class="p">,</span> <span class="n">alt_skill</span><span class="p">,</span>
                                                        <span class="n">target_obs_altz</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logp_altz</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">split_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">input_obs_altz</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">//</span> <span class="n">split_group</span><span class="p">):</span>
                <span class="n">start_split</span> <span class="o">=</span> <span class="n">split_idx</span> <span class="o">*</span> <span class="n">split_group</span>
                <span class="n">end_split</span> <span class="o">=</span> <span class="p">(</span><span class="n">split_idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">split_group</span>
                <span class="n">logp_altz</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">_skill_dynamics</span><span class="o">.</span><span class="n">get_log_prob</span><span class="p">(</span>
                    <span class="n">input_obs_altz</span><span class="p">[</span><span class="n">start_split</span><span class="p">:</span><span class="n">end_split</span><span class="p">],</span>
                    <span class="n">alt_skill</span><span class="p">[</span><span class="n">start_split</span><span class="p">:</span><span class="n">end_split</span><span class="p">],</span>
                    <span class="n">target_obs_altz</span><span class="p">[</span><span class="n">start_split</span><span class="p">:</span><span class="n">end_split</span><span class="p">]))</span>
            <span class="k">if</span> <span class="n">input_obs_altz</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">%</span> <span class="n">split_group</span><span class="p">:</span>
                <span class="n">start_split</span> <span class="o">=</span> <span class="n">input_obs_altz</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">%</span> <span class="n">split_group</span>
                <span class="n">logp_altz</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_skill_dynamics</span><span class="o">.</span><span class="n">get_log_prob</span><span class="p">(</span><span class="n">input_obs_altz</span><span class="p">[</span><span class="o">-</span><span class="n">start_split</span><span class="p">:],</span>
                                                      <span class="n">alt_skill</span><span class="p">[</span><span class="o">-</span><span class="n">start_split</span><span class="p">:],</span>
                                                  <span class="n">target_obs_altz</span><span class="p">[</span><span class="o">-</span><span class="n">start_split</span><span class="p">:]))</span>
            <span class="n">logp_altz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">logp_altz</span><span class="p">)</span>
        <span class="n">logp_altz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array_split</span><span class="p">(</span><span class="n">logp_altz</span><span class="p">,</span> <span class="n">num_reps</span><span class="p">))</span>

        <span class="c1"># final DADS reward</span>
        <span class="n">intrinsic_reward</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">num_reps</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">logp_altz</span> <span class="o">-</span> <span class="n">logp</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="o">-</span><span class="mi">50</span><span class="p">,</span> <span class="mi">50</span><span class="p">))</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">intrinsic_reward</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;logp&#39;</span><span class="p">:</span> <span class="n">logp</span><span class="p">,</span> <span class="s1">&#39;logp_altz&#39;</span><span class="p">:</span> <span class="n">logp_altz</span><span class="o">.</span><span class="n">flatten</span><span class="p">()}</span>

    <span class="k">def</span> <span class="nf">get_experience_placeholder</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_placeholders_in_place</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_placeholders</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">nest</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">collect_data_spec</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_placeholders</span> <span class="o">+=</span> <span class="p">[</span>
              <span class="n">tf</span><span class="o">.</span><span class="n">compat</span><span class="o">.</span><span class="n">v1</span><span class="o">.</span><span class="n">placeholder</span><span class="p">(</span>
                  <span class="n">item</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
                  <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span>
                  <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">item</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span>
                  <span class="n">name</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
          <span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_policy_experience_ph</span> <span class="o">=</span> <span class="n">nest</span><span class="o">.</span><span class="n">pack_sequence_as</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">collect_data_spec</span><span class="p">,</span>
                                                           <span class="bp">self</span><span class="o">.</span><span class="n">_placeholders</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_policy_experience_ph</span>

    <span class="k">def</span> <span class="nf">build_agent_graph</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_graph</span><span class="o">.</span><span class="n">as_default</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_experience_placeholder</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">agent_train_op</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_policy_experience_ph</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">summary_ops</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">compat</span><span class="o">.</span><span class="n">v1</span><span class="o">.</span><span class="n">summary</span><span class="o">.</span><span class="n">all_v2_summary_ops</span><span class="p">()</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent_train_op</span>

    <span class="k">def</span> <span class="nf">build_skill_dynamics_graph</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_skill_dynamics</span><span class="o">.</span><span class="n">make_placeholders</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_skill_dynamics</span><span class="o">.</span><span class="n">build_graph</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_skill_dynamics</span><span class="o">.</span><span class="n">increase_prob_op</span><span class="p">(</span>
        <span class="n">learning_rate</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_skill_dynamics_learning_rate</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">create_savers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_skill_dynamics</span><span class="o">.</span><span class="n">create_saver</span><span class="p">(</span>
            <span class="n">save_prefix</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_save_directory</span><span class="p">,</span> <span class="s1">&#39;dynamics&#39;</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">set_sessions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">initialize_or_restore_skill_dynamics</span><span class="p">,</span> <span class="n">session</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">session</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_session</span> <span class="o">=</span> <span class="n">session</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_session</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">compat</span><span class="o">.</span><span class="n">v1</span><span class="o">.</span><span class="n">Session</span><span class="p">(</span><span class="n">graph</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_graph</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_skill_dynamics</span><span class="o">.</span><span class="n">set_session</span><span class="p">(</span>
            <span class="n">initialize_or_restore_variables</span><span class="o">=</span><span class="n">initialize_or_restore_skill_dynamics</span><span class="p">,</span>
            <span class="n">session</span><span class="o">=</span><span class="n">session</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">save_variables</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">global_step</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_skill_dynamics</span><span class="o">.</span><span class="n">save_variables</span><span class="p">(</span><span class="n">global_step</span><span class="o">=</span><span class="n">global_step</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trajectories</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">tf</span><span class="o">.</span><span class="n">nest</span><span class="o">.</span><span class="n">assert_same_structure</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">collect_data_spec</span><span class="p">,</span> <span class="n">trajectories</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">batch_size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
              <span class="n">shuffled_batch</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">permutation</span><span class="p">(</span>
              <span class="n">trajectories</span><span class="o">.</span><span class="n">observation</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])[:</span><span class="n">batch_size</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
              <span class="n">shuffled_batch</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">trajectories</span><span class="o">.</span><span class="n">observation</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="n">return_dict</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">placeholder</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_placeholders</span><span class="p">,</span> <span class="n">nest</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">trajectories</span><span class="p">)):</span>
              <span class="n">return_dict</span><span class="p">[</span><span class="n">placeholder</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span><span class="p">[</span><span class="n">shuffled_batch</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">return_dict</span>

    <span class="k">def</span> <span class="nf">train_loop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">trajectories</span><span class="p">,</span>
                 <span class="n">recompute_reward</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">batch_size</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
                 <span class="n">num_steps</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_placeholders_in_place</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="n">recompute_reward</span><span class="p">:</span>
            <span class="n">input_obs</span> <span class="o">=</span> <span class="n">trajectories</span><span class="o">.</span><span class="n">observation</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">_latent_size</span><span class="p">]</span>
            <span class="n">cur_skill</span> <span class="o">=</span> <span class="n">trajectories</span><span class="o">.</span><span class="n">observation</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">_latent_size</span><span class="p">:]</span>
            <span class="n">target_obs</span> <span class="o">=</span> <span class="n">trajectories</span><span class="o">.</span><span class="n">observation</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">_latent_size</span><span class="p">]</span>
            <span class="n">new_reward</span><span class="p">,</span> <span class="n">info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_dads_reward</span><span class="p">(</span><span class="n">input_obs</span><span class="p">,</span> <span class="n">cur_skill</span><span class="p">,</span>
                                                      <span class="n">target_obs</span><span class="p">)</span>
            <span class="n">trajectories</span> <span class="o">=</span> <span class="n">trajectories</span><span class="o">.</span><span class="n">_replace</span><span class="p">(</span>
              <span class="n">reward</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
                  <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">new_reward</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">trajectories</span><span class="o">.</span><span class="n">reward</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:]],</span>
                  <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>

          <span class="c1"># TODO(architsh):all agent specs should be the same as env specs, shift preprocessing to actor/critic networks</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_restrict_input_size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">trajectories</span> <span class="o">=</span> <span class="n">trajectories</span><span class="o">.</span><span class="n">_replace</span><span class="p">(</span>
              <span class="n">observation</span><span class="o">=</span><span class="n">trajectories</span><span class="o">.</span><span class="n">observation</span><span class="p">[:,</span> <span class="p">:,</span>
                                                   <span class="bp">self</span><span class="o">.</span><span class="n">_restrict_input_size</span><span class="p">:])</span>

        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_steps</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_session</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">agent_train_op</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">summary_ops</span><span class="p">],</span>
                            <span class="n">feed_dict</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_dict</span><span class="p">(</span>
                                <span class="n">trajectories</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">recompute_reward</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">new_reward</span><span class="p">,</span> <span class="n">info</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">skill_dynamics</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_skill_dynamics</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_text output_error">
<pre>
<span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">NameError</span>                                 Traceback (most recent call last)
<span class="ansi-green-fg">&lt;ipython-input-3-1cd16b332a51&gt;</span> in <span class="ansi-cyan-fg">&lt;module&gt;</span>
<span class="ansi-green-fg">----&gt; 1</span><span class="ansi-red-fg"> </span><span class="ansi-green-fg">class</span> DADSAgent<span class="ansi-blue-fg">(</span>SAC<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>
<span class="ansi-green-intense-fg ansi-bold">      2</span> 
<span class="ansi-green-intense-fg ansi-bold">      3</span>     def __init__(self,
<span class="ansi-green-intense-fg ansi-bold">      4</span>                save_directory<span class="ansi-blue-fg">,</span>
<span class="ansi-green-intense-fg ansi-bold">      5</span>                skill_dynamics_observation_size<span class="ansi-blue-fg">,</span>

<span class="ansi-red-fg">NameError</span>: name &#39;SAC&#39; is not defined</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">DADSLearner</span><span class="p">(</span><span class="n">SACLearner</span><span class="p">):</span><span class="k">pass</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">env</span><span class="o">=</span><span class="s1">&#39;Pendulum-v0&#39;</span>
<span class="n">agent</span><span class="o">=</span><span class="n">DADSAgent</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="n">gym</span><span class="o">.</span><span class="n">make</span><span class="p">(</span><span class="n">env</span><span class="p">)</span><span class="o">.</span><span class="n">action_space</span><span class="p">,</span><span class="n">gamma</span><span class="o">=</span><span class="mf">0.99</span><span class="p">,</span><span class="n">tau</span><span class="o">=</span><span class="mf">0.005</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>

<span class="n">block</span><span class="o">=</span><span class="n">FirstLastExperienceBlock</span><span class="p">(</span><span class="n">agent</span><span class="o">=</span><span class="n">agent</span><span class="p">,</span><span class="n">seed</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">n_steps</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">exclude_nones</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                               <span class="n">dls_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;bs&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span><span class="s1">&#39;num_workers&#39;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span><span class="s1">&#39;verbose&#39;</span><span class="p">:</span><span class="kc">False</span><span class="p">,</span><span class="s1">&#39;indexed&#39;</span><span class="p">:</span><span class="kc">True</span><span class="p">,</span><span class="s1">&#39;shuffle_train&#39;</span><span class="p">:</span><span class="kc">False</span><span class="p">})</span>
<span class="n">blk</span><span class="o">=</span><span class="n">IterableDataBlock</span><span class="p">(</span><span class="n">blocks</span><span class="o">=</span><span class="p">(</span><span class="n">block</span><span class="p">),</span>
                      <span class="n">splitter</span><span class="o">=</span><span class="n">FuncSplitter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span><span class="kc">False</span><span class="p">),</span>
<span class="c1">#                       batch_tfms=lambda x:(x[&#39;s&#39;],x),</span>
                     <span class="p">)</span>
<span class="n">dls</span><span class="o">=</span><span class="n">blk</span><span class="o">.</span><span class="n">dataloaders</span><span class="p">([</span><span class="n">env</span><span class="p">]</span><span class="o">*</span><span class="mi">1</span><span class="p">,</span><span class="n">n</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span><span class="n">device</span><span class="o">=</span><span class="n">default_device</span><span class="p">())</span>

<span class="n">learner</span><span class="o">=</span><span class="n">DADSLearner</span><span class="p">(</span><span class="n">dls</span><span class="p">,</span><span class="n">agent</span><span class="o">=</span><span class="n">agent</span><span class="p">,</span><span class="n">cbs</span><span class="o">=</span><span class="p">[</span><span class="n">ExperienceReplay</span><span class="p">(</span><span class="n">sz</span><span class="o">=</span><span class="mi">1000000</span><span class="p">,</span><span class="n">bs</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span><span class="n">starting_els</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span><span class="n">max_steps</span><span class="o">=</span><span class="n">gym</span><span class="o">.</span><span class="n">make</span><span class="p">(</span><span class="n">env</span><span class="p">)</span><span class="o">.</span><span class="n">_max_episode_steps</span><span class="p">),</span><span class="n">SACCriticTrainer</span><span class="p">],</span>
                   <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="n">AvgEpisodeRewardMetric</span><span class="p">()])</span>
<span class="n">learner</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span><span class="n">lr</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span><span class="n">wd</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

</div>
 

