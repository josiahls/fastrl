---

title: DQN Targets + N-Step


keywords: fastai
sidebar: home_sidebar

summary: "A Bare-Bones DQN is usually extremely unstable. Target models can eleviate this. We also support First-Last N steps better."
description: "A Bare-Bones DQN is usually extremely unstable. Target models can eleviate this. We also support First-Last N steps better."
nb_path: "nbs/10b_agents.dqn.targets.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: nbs/10b_agents.dqn.targets.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="DQNTargetTrainer" class="doc_header"><code>class</code> <code>DQNTargetTrainer</code><a href="https://github.com/josiahls/fastrl/tree/master/fastrl/agents/dqn/targets.py#L26" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>DQNTargetTrainer</code>(<strong><code>n_batch</code></strong>=<em><code>0</code></em>, <strong><code>target_sync</code></strong>=<em><code>300</code></em>, <strong><code>discount</code></strong>=<em><code>0.99</code></em>, <strong><code>n_steps</code></strong>=<em><code>1</code></em>) :: <code>Callback</code></p>
</blockquote>
<p>Basic class handling tweaks of the training loop by changing a <code>Learner</code> in various events</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">dqn</span><span class="o">=</span><span class="n">DQN</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
<span class="n">agent</span><span class="o">=</span><span class="n">Agent</span><span class="p">(</span><span class="n">dqn</span><span class="p">,</span><span class="n">cbs</span><span class="o">=</span><span class="p">[</span><span class="n">ArgMaxFeed</span><span class="p">,</span><span class="n">DiscreteEpsilonRandomSelect</span><span class="p">(</span><span class="n">min_epsilon</span><span class="o">=</span><span class="mf">0.02</span><span class="p">,</span><span class="n">max_steps</span><span class="o">=</span><span class="mi">1000</span><span class="p">)])</span>
<span class="n">source</span><span class="o">=</span><span class="n">Source</span><span class="p">(</span><span class="n">cbs</span><span class="o">=</span><span class="p">[</span><span class="n">GymLoop</span><span class="p">(</span><span class="s1">&#39;CartPole-v1&#39;</span><span class="p">,</span><span class="n">agent</span><span class="p">,</span><span class="n">steps_count</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                           <span class="n">steps_delta</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span><span class="n">FirstLast</span><span class="p">])</span>
<span class="n">dls</span><span class="o">=</span><span class="n">SourceDataBlock</span><span class="p">()</span><span class="o">.</span><span class="n">dataloaders</span><span class="p">([</span><span class="n">source</span><span class="p">],</span><span class="n">n</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span><span class="n">bs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">num_workers</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="n">learn</span><span class="o">=</span><span class="n">Learner</span><span class="p">(</span><span class="n">dls</span><span class="p">,</span><span class="n">agent</span><span class="p">,</span><span class="n">loss_func</span><span class="o">=</span><span class="n">MSELoss</span><span class="p">(),</span>
              <span class="n">cbs</span><span class="o">=</span><span class="p">[</span><span class="n">ExperienceReplay</span><span class="p">(</span><span class="n">bs</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span><span class="n">max_sz</span><span class="o">=</span><span class="mi">100000</span><span class="p">,</span><span class="n">warmup_sz</span><span class="o">=</span><span class="mi">32</span><span class="p">),</span><span class="n">DQNTargetTrainer</span><span class="p">(</span><span class="n">n_steps</span><span class="o">=</span><span class="mi">1</span><span class="p">)],</span>
              <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="n">Reward</span><span class="p">,</span><span class="n">Epsilon</span><span class="p">,</span><span class="n">NEpisodes</span><span class="p">])</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Could not do one pass in your dataloader, there is something wrong in it
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">slow</span><span class="o">=</span><span class="kc">True</span>
<span class="n">learn</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="mi">3</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">slow</span> <span class="k">else</span> <span class="mi">60</span><span class="p">,</span><span class="n">lr</span><span class="o">=</span><span class="mf">0.0001</span><span class="p">,</span><span class="n">wd</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea ">
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: left;">
      <th>epoch</th>
      <th>train_loss</th>
      <th>train_reward</th>
      <th>train_epsilon</th>
      <th>train_n_episodes</th>
      <th>valid_loss</th>
      <th>valid_reward</th>
      <th>valid_epsilon</th>
      <th>valid_n_episodes</th>
      <th>time</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>32.967072</td>
      <td>148.780000</td>
      <td>0.020000</td>
      <td>579</td>
      <td>00:38</td>
    </tr>
    <tr>
      <td>1</td>
      <td>33.991703</td>
      <td>142.190000</td>
      <td>0.020000</td>
      <td>588</td>
      <td>00:31</td>
    </tr>
    <tr>
      <td>2</td>
      <td>36.916882</td>
      <td>144.020000</td>
      <td>0.020000</td>
      <td>594</td>
      <td>00:29</td>
    </tr>
    <tr>
      <td>3</td>
      <td>49.794846</td>
      <td>143.550000</td>
      <td>0.020000</td>
      <td>601</td>
      <td>00:28</td>
    </tr>
    <tr>
      <td>4</td>
      <td>35.804199</td>
      <td>148.160000</td>
      <td>0.020000</td>
      <td>607</td>
      <td>00:28</td>
    </tr>
    <tr>
      <td>5</td>
      <td>49.903011</td>
      <td>144.230000</td>
      <td>0.020000</td>
      <td>615</td>
      <td>00:29</td>
    </tr>
    <tr>
      <td>6</td>
      <td>38.329674</td>
      <td>142.640000</td>
      <td>0.020000</td>
      <td>620</td>
      <td>00:30</td>
    </tr>
    <tr>
      <td>7</td>
      <td>36.479065</td>
      <td>141.260000</td>
      <td>0.020000</td>
      <td>628</td>
      <td>00:28</td>
    </tr>
    <tr>
      <td>8</td>
      <td>51.793835</td>
      <td>141.730000</td>
      <td>0.020000</td>
      <td>635</td>
      <td>00:29</td>
    </tr>
    <tr>
      <td>9</td>
      <td>25.748798</td>
      <td>137.220000</td>
      <td>0.020000</td>
      <td>644</td>
      <td>00:30</td>
    </tr>
    <tr>
      <td>10</td>
      <td>34.915688</td>
      <td>143.440000</td>
      <td>0.020000</td>
      <td>649</td>
      <td>00:29</td>
    </tr>
    <tr>
      <td>11</td>
      <td>40.659821</td>
      <td>143.480000</td>
      <td>0.020000</td>
      <td>656</td>
      <td>00:29</td>
    </tr>
    <tr>
      <td>12</td>
      <td>53.328106</td>
      <td>144.060000</td>
      <td>0.020000</td>
      <td>661</td>
      <td>00:29</td>
    </tr>
    <tr>
      <td>13</td>
      <td>54.423149</td>
      <td>141.040000</td>
      <td>0.020000</td>
      <td>667</td>
      <td>00:32</td>
    </tr>
    <tr>
      <td>14</td>
      <td>36.695988</td>
      <td>139.480000</td>
      <td>0.020000</td>
      <td>673</td>
      <td>00:29</td>
    </tr>
    <tr>
      <td>15</td>
      <td>33.906799</td>
      <td>135.810000</td>
      <td>0.020000</td>
      <td>681</td>
      <td>00:29</td>
    </tr>
    <tr>
      <td>16</td>
      <td>43.006138</td>
      <td>135.460000</td>
      <td>0.020000</td>
      <td>688</td>
      <td>00:29</td>
    </tr>
    <tr>
      <td>17</td>
      <td>33.630657</td>
      <td>136.280000</td>
      <td>0.020000</td>
      <td>693</td>
      <td>00:32</td>
    </tr>
    <tr>
      <td>18</td>
      <td>42.715637</td>
      <td>139.020000</td>
      <td>0.020000</td>
      <td>697</td>
      <td>00:24</td>
    </tr>
    <tr>
      <td>19</td>
      <td>41.933136</td>
      <td>136.520000</td>
      <td>0.020000</td>
      <td>703</td>
      <td>00:24</td>
    </tr>
    <tr>
      <td>20</td>
      <td>45.037426</td>
      <td>136.790000</td>
      <td>0.020000</td>
      <td>710</td>
      <td>00:23</td>
    </tr>
    <tr>
      <td>21</td>
      <td>51.416050</td>
      <td>139.050000</td>
      <td>0.020000</td>
      <td>715</td>
      <td>00:24</td>
    </tr>
    <tr>
      <td>22</td>
      <td>60.798603</td>
      <td>137.870000</td>
      <td>0.020000</td>
      <td>722</td>
      <td>00:25</td>
    </tr>
    <tr>
      <td>23</td>
      <td>41.110558</td>
      <td>135.230000</td>
      <td>0.020000</td>
      <td>730</td>
      <td>00:24</td>
    </tr>
    <tr>
      <td>24</td>
      <td>42.510475</td>
      <td>140.230000</td>
      <td>0.020000</td>
      <td>735</td>
      <td>00:24</td>
    </tr>
    <tr>
      <td>25</td>
      <td>54.897301</td>
      <td>139.540000</td>
      <td>0.020000</td>
      <td>744</td>
      <td>00:24</td>
    </tr>
    <tr>
      <td>26</td>
      <td>65.086815</td>
      <td>144.150000</td>
      <td>0.020000</td>
      <td>746</td>
      <td>00:24</td>
    </tr>
    <tr>
      <td>27</td>
      <td>37.813328</td>
      <td>144.230000</td>
      <td>0.020000</td>
      <td>752</td>
      <td>00:25</td>
    </tr>
    <tr>
      <td>28</td>
      <td>30.603466</td>
      <td>142.140000</td>
      <td>0.020000</td>
      <td>758</td>
      <td>00:24</td>
    </tr>
    <tr>
      <td>29</td>
      <td>60.073296</td>
      <td>144.190000</td>
      <td>0.020000</td>
      <td>764</td>
      <td>00:24</td>
    </tr>
    <tr>
      <td>30</td>
      <td>67.074615</td>
      <td>143.150000</td>
      <td>0.020000</td>
      <td>769</td>
      <td>00:24</td>
    </tr>
    <tr>
      <td>31</td>
      <td>71.958748</td>
      <td>145.370000</td>
      <td>0.020000</td>
      <td>775</td>
      <td>00:24</td>
    </tr>
    <tr>
      <td>32</td>
      <td>58.310413</td>
      <td>148.180000</td>
      <td>0.020000</td>
      <td>780</td>
      <td>00:26</td>
    </tr>
    <tr>
      <td>33</td>
      <td>50.135338</td>
      <td>152.950000</td>
      <td>0.020000</td>
      <td>785</td>
      <td>00:26</td>
    </tr>
    <tr>
      <td>34</td>
      <td>51.845100</td>
      <td>153.780000</td>
      <td>0.020000</td>
      <td>787</td>
      <td>00:26</td>
    </tr>
    <tr>
      <td>35</td>
      <td>53.534290</td>
      <td>154.050000</td>
      <td>0.020000</td>
      <td>792</td>
      <td>00:25</td>
    </tr>
    <tr>
      <td>36</td>
      <td>53.905632</td>
      <td>147.970000</td>
      <td>0.020000</td>
      <td>799</td>
      <td>00:25</td>
    </tr>
    <tr>
      <td>37</td>
      <td>52.816483</td>
      <td>152.680000</td>
      <td>0.020000</td>
      <td>803</td>
      <td>00:24</td>
    </tr>
    <tr>
      <td>38</td>
      <td>40.803253</td>
      <td>155.640000</td>
      <td>0.020000</td>
      <td>808</td>
      <td>00:24</td>
    </tr>
    <tr>
      <td>39</td>
      <td>55.184174</td>
      <td>155.990000</td>
      <td>0.020000</td>
      <td>814</td>
      <td>00:25</td>
    </tr>
    <tr>
      <td>40</td>
      <td>66.652138</td>
      <td>152.330000</td>
      <td>0.020000</td>
      <td>823</td>
      <td>00:24</td>
    </tr>
    <tr>
      <td>41</td>
      <td>54.564217</td>
      <td>154.650000</td>
      <td>0.020000</td>
      <td>828</td>
      <td>00:25</td>
    </tr>
    <tr>
      <td>42</td>
      <td>57.140594</td>
      <td>153.130000</td>
      <td>0.020000</td>
      <td>836</td>
      <td>00:24</td>
    </tr>
    <tr>
      <td>43</td>
      <td>42.338223</td>
      <td>155.730000</td>
      <td>0.020000</td>
      <td>842</td>
      <td>00:25</td>
    </tr>
    <tr>
      <td>44</td>
      <td>61.405502</td>
      <td>152.530000</td>
      <td>0.020000</td>
      <td>848</td>
      <td>00:25</td>
    </tr>
    <tr>
      <td>45</td>
      <td>57.241138</td>
      <td>147.690000</td>
      <td>0.020000</td>
      <td>857</td>
      <td>00:25</td>
    </tr>
    <tr>
      <td>46</td>
      <td>55.116177</td>
      <td>153.810000</td>
      <td>0.020000</td>
      <td>860</td>
      <td>00:25</td>
    </tr>
    <tr>
      <td>47</td>
      <td>86.618668</td>
      <td>149.750000</td>
      <td>0.020000</td>
      <td>867</td>
      <td>00:25</td>
    </tr>
    <tr>
      <td>48</td>
      <td>49.776161</td>
      <td>149.300000</td>
      <td>0.020000</td>
      <td>874</td>
      <td>00:25</td>
    </tr>
    <tr>
      <td>49</td>
      <td>62.097721</td>
      <td>145.030000</td>
      <td>0.020000</td>
      <td>882</td>
      <td>00:25</td>
    </tr>
    <tr>
      <td>50</td>
      <td>50.514488</td>
      <td>144.290000</td>
      <td>0.020000</td>
      <td>887</td>
      <td>00:25</td>
    </tr>
    <tr>
      <td>51</td>
      <td>53.351593</td>
      <td>145.590000</td>
      <td>0.020000</td>
      <td>892</td>
      <td>00:25</td>
    </tr>
    <tr>
      <td>52</td>
      <td>90.681190</td>
      <td>150.160000</td>
      <td>0.020000</td>
      <td>897</td>
      <td>00:25</td>
    </tr>
    <tr>
      <td>53</td>
      <td>54.170547</td>
      <td>145.180000</td>
      <td>0.020000</td>
      <td>905</td>
      <td>00:31</td>
    </tr>
    <tr>
      <td>54</td>
      <td>35.522045</td>
      <td>141.920000</td>
      <td>0.020000</td>
      <td>911</td>
      <td>00:30</td>
    </tr>
    <tr>
      <td>55</td>
      <td>42.218773</td>
      <td>148.280000</td>
      <td>0.020000</td>
      <td>916</td>
      <td>00:30</td>
    </tr>
    <tr>
      <td>56</td>
      <td>50.619457</td>
      <td>150.040000</td>
      <td>0.020000</td>
      <td>922</td>
      <td>00:30</td>
    </tr>
    <tr>
      <td>57</td>
      <td>63.748955</td>
      <td>149.530000</td>
      <td>0.020000</td>
      <td>928</td>
      <td>00:30</td>
    </tr>
    <tr>
      <td>58</td>
      <td>40.354549</td>
      <td>150.910000</td>
      <td>0.020000</td>
      <td>935</td>
      <td>00:30</td>
    </tr>
    <tr>
      <td>59</td>
      <td>37.481319</td>
      <td>148.820000</td>
      <td>0.020000</td>
      <td>942</td>
      <td>00:31</td>
    </tr>
  </tbody>
</table>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

</div>
 

