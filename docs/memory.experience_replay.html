---

title: Experience Replay


keywords: fastai
sidebar: home_sidebar

summary: "Experience Replay is likely the simplest form of memory used by RL agents. "
description: "Experience Replay is likely the simplest form of memory used by RL agents. "
nb_path: "nbs/06a_memory.experience_replay.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: nbs/06a_memory.experience_replay.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="ExperienceReplay" class="doc_header"><code>class</code> <code>ExperienceReplay</code><a href="https://github.com/josiahls/fastrl/tree/master/fastrl/memory/experience_replay.py#L20" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>ExperienceReplay</code>(<strong>*<code>args</code></strong>, <strong>**<code>kwds</code></strong>) :: <code>IterDataPipe</code></p>
</blockquote>
<p>Iterable-style DataPipe.</p>
<p>All DataPipes that represent an iterable of data samples should subclass this.
This style of DataPipes is particularly useful when data come from a stream, or
when the number of samples is too large to fit them all in memory. <code>IterDataPipe</code> is lazily initialized and its
elements are computed only when <code>next()</code> is called on the iterator of an <code>IterDataPipe</code>.</p>
<p>All subclasses should overwrite :meth:<code>__iter__</code>, which would return an
iterator of samples in this DataPipe. Calling <code>__iter__</code> of an <code>IterDataPipe</code> automatically invokes its
method <code>reset()</code>, which by default performs no operation. When writing a custom <code>IterDataPipe</code>, users should
override <code>reset()</code> if necessary. The common usages include resetting buffers, pointers,
and various state variables within the custom <code>IterDataPipe</code>.</p>
<p>Note:
    Only <code>one</code> iterator can be valid for each <code>IterDataPipe</code> at a time,
    and the creation a second iterator will invalidate the first one. This constraint is necessary because
    some <code>IterDataPipe</code> have internal buffers, whose states can become invalid if there are multiple iterators.
    The code example below presents details on how this constraint looks in practice.
    If you have any feedback related to this constraint, please see <code>GitHub IterDataPipe Single Iterator Issue</code>_.</p>
<p>These DataPipes can be invoked in two ways, using the class constructor or applying their
functional form onto an existing <code>IterDataPipe</code> (recommended, available to most but not all DataPipes).
You can chain multiple <code>IterDataPipe</code> together to form a pipeline that will perform multiple
operations in succession.</p>
<p>.. _GitHub IterDataPipe Single Iterator Issue:
    <a href="https://github.com/pytorch/data/issues/45">https://github.com/pytorch/data/issues/45</a></p>
<p>Note:
    When a subclass is used with :class:<code>~torch.utils.data.DataLoader</code>, each
    item in the DataPipe will be yielded from the :class:<code>~torch.utils.data.DataLoader</code>
    iterator. When :attr:<code>num_workers &gt; 0</code>, each worker process will have a
    different copy of the DataPipe object, so it is often desired to configure
    each copy independently to avoid having duplicate data returned from the
    workers. :func:<code>~torch.utils.data.get_worker_info</code>, when called in a worker
    process, returns information about the worker. It can be used in either the
    dataset's :meth:<code>__iter__</code> method or the :class:<code>~torch.utils.data.DataLoader</code> 's
    :attr:<code>worker_init_fn</code> option to modify each copy's behavior.</p>
<p>Examples:
    General Usage:</p>

<pre><code>    &gt;&gt;&gt; from torchdata.datapipes.iter import IterableWrapper, Mapper
    &gt;&gt;&gt; dp = IterableWrapper(range(10))
    &gt;&gt;&gt; map_dp_1 = Mapper(dp, lambda x: x + 1)  # Using class constructor
    &gt;&gt;&gt; map_dp_2 = dp.map(lambda x: x + 1)  # Using functional form (recommended)
    &gt;&gt;&gt; list(map_dp_1)
    [1, 2, 3, 4, 5, 6, 7, 8, 9, 10]
    &gt;&gt;&gt; list(map_dp_2)
    [1, 2, 3, 4, 5, 6, 7, 8, 9, 10]
    &gt;&gt;&gt; filter_dp = map_dp_1.filter(lambda x: x % 2 == 0)
    &gt;&gt;&gt; list(filter_dp)
    [2, 4, 6, 8, 10]
Single Iterator Constraint Example:
    &gt;&gt;&gt; from torchdata.datapipes.iter import IterableWrapper, Mapper
    &gt;&gt;&gt; dp = IterableWrapper(range(10))
    &gt;&gt;&gt; it1 = iter(source_dp)
    &gt;&gt;&gt; list(it1)
    [0, 1, 2, 3, 4, 5, 6, 7, 8, 9]
    &gt;&gt;&gt; it1 = iter(source_dp)
    &gt;&gt;&gt; it2 = iter(source_dp)  # The creation of a new iterator invalidates `it1`
    &gt;&gt;&gt; next(it2)
    0
    &gt;&gt;&gt; next(it1)  # Further usage of `it1` will raise a `RunTimeError`</code></pre>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>lets generate some batches to test with...</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">fastrl.fastai.data.pipes.core</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">fastrl.fastai.data.load</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">fastrl.fastai.data.block</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">fastrl.envs.gym</span> <span class="kn">import</span> <span class="o">*</span>

<span class="k">def</span> <span class="nf">baseline_test</span><span class="p">(</span><span class="n">envs</span><span class="p">,</span><span class="n">total_steps</span><span class="p">,</span><span class="n">seed</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="n">pipe</span> <span class="o">=</span> <span class="n">dp</span><span class="o">.</span><span class="n">map</span><span class="o">.</span><span class="n">Mapper</span><span class="p">(</span><span class="n">envs</span><span class="p">)</span>
    <span class="n">pipe</span> <span class="o">=</span> <span class="n">TypeTransformLoop</span><span class="p">(</span><span class="n">pipe</span><span class="p">,[</span><span class="n">GymTypeTransform</span><span class="p">])</span>
    <span class="n">pipe</span> <span class="o">=</span> <span class="n">dp</span><span class="o">.</span><span class="n">iter</span><span class="o">.</span><span class="n">MapToIterConverter</span><span class="p">(</span><span class="n">pipe</span><span class="p">)</span>
    <span class="n">pipe</span> <span class="o">=</span> <span class="n">dp</span><span class="o">.</span><span class="n">iter</span><span class="o">.</span><span class="n">InMemoryCacheHolder</span><span class="p">(</span><span class="n">pipe</span><span class="p">)</span>
    <span class="n">pipe</span> <span class="o">=</span> <span class="n">pipe</span><span class="o">.</span><span class="n">cycle</span><span class="p">()</span>
    <span class="n">pipe</span> <span class="o">=</span> <span class="n">GymStepper</span><span class="p">(</span><span class="n">pipe</span><span class="p">,</span><span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">)</span>

    <span class="n">steps</span> <span class="o">=</span> <span class="p">[</span><span class="n">step</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span><span class="n">step</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">total_steps</span><span class="p">),</span><span class="n">pipe</span><span class="p">))]</span>
    <span class="k">return</span> <span class="n">steps</span><span class="p">,</span> <span class="n">pipe</span>

<span class="nd">@delegates</span><span class="p">(</span><span class="n">ExperienceReplay</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">exp_replay_test</span><span class="p">(</span><span class="n">envs</span><span class="p">,</span><span class="n">total_steps</span><span class="p">,</span><span class="n">seed</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">pipe</span> <span class="o">=</span> <span class="n">dp</span><span class="o">.</span><span class="n">map</span><span class="o">.</span><span class="n">Mapper</span><span class="p">(</span><span class="n">envs</span><span class="p">)</span>
    <span class="n">pipe</span> <span class="o">=</span> <span class="n">TypeTransformLoop</span><span class="p">(</span><span class="n">pipe</span><span class="p">,[</span><span class="n">GymTypeTransform</span><span class="p">])</span>
    <span class="n">pipe</span> <span class="o">=</span> <span class="n">dp</span><span class="o">.</span><span class="n">iter</span><span class="o">.</span><span class="n">MapToIterConverter</span><span class="p">(</span><span class="n">pipe</span><span class="p">)</span>
    <span class="n">pipe</span> <span class="o">=</span> <span class="n">dp</span><span class="o">.</span><span class="n">iter</span><span class="o">.</span><span class="n">InMemoryCacheHolder</span><span class="p">(</span><span class="n">pipe</span><span class="p">)</span>
    <span class="n">pipe</span> <span class="o">=</span> <span class="n">pipe</span><span class="o">.</span><span class="n">cycle</span><span class="p">()</span>
    <span class="n">pipe</span> <span class="o">=</span> <span class="n">GymStepper</span><span class="p">(</span><span class="n">pipe</span><span class="p">,</span><span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">)</span>
    <span class="n">pipe</span> <span class="o">=</span> <span class="n">ExperienceReplay</span><span class="p">(</span><span class="n">pipe</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="n">steps</span> <span class="o">=</span> <span class="p">[</span><span class="n">step</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span><span class="n">step</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">total_steps</span><span class="p">),</span><span class="n">pipe</span><span class="p">))]</span>
    <span class="k">return</span> <span class="n">steps</span><span class="p">,</span> <span class="n">pipe</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">steps</span><span class="p">,</span> <span class="n">experience_replay</span> <span class="o">=</span> <span class="n">exp_replay_test</span><span class="p">([</span><span class="s1">&#39;CartPole-v1&#39;</span><span class="p">],</span><span class="mi">0</span><span class="p">,</span><span class="n">bs</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">experience_replay</span><span class="p">),</span><span class="mi">0</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><strong>what if we fill up ER?</strong>
Lets add the batches, this process will happen inplace...</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">steps</span><span class="p">,</span> <span class="n">experience_replay</span> <span class="o">=</span> <span class="n">exp_replay_test</span><span class="p">([</span><span class="s1">&#39;CartPole-v1&#39;</span><span class="p">],</span><span class="mi">10</span><span class="p">,</span><span class="n">max_sz</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">experience_replay</span><span class="o">.</span><span class="n">_sz_tracker</span><span class="p">,</span><span class="mi">10</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">experience_replay</span><span class="o">.</span><span class="n">_idx_tracker</span><span class="p">,</span><span class="mi">10</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">experience_replay</span><span class="o">.</span><span class="n">_cycle_tracker</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
<span class="n">test_len</span><span class="p">(</span><span class="n">experience_replay</span><span class="p">,</span><span class="mi">10</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>If we run 10 more times, the total size should be 20...</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">steps</span> <span class="o">=</span> <span class="p">[</span><span class="n">step</span> <span class="k">for</span> <span class="n">step</span><span class="p">,</span><span class="n">_</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span><span class="n">experience_replay</span><span class="p">))]</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">experience_replay</span><span class="o">.</span><span class="n">_sz_tracker</span><span class="p">,</span><span class="mi">20</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">experience_replay</span><span class="o">.</span><span class="n">_idx_tracker</span><span class="p">,</span><span class="mi">20</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">experience_replay</span><span class="o">.</span><span class="n">_cycle_tracker</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
<span class="n">test_len</span><span class="p">(</span><span class="n">experience_replay</span><span class="p">,</span><span class="mi">20</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><code>experience_replay</code> memory should contain identical steps to if we just run without it...</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">steps</span><span class="p">,</span> <span class="n">pipe</span> <span class="o">=</span> <span class="n">baseline_test</span><span class="p">([</span><span class="s1">&#39;CartPole-v1&#39;</span><span class="p">],</span><span class="mi">20</span><span class="p">,)</span>

<span class="k">for</span> <span class="n">baseline_step</span><span class="p">,</span><span class="n">memory_step</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">steps</span><span class="p">,</span><span class="n">experience_replay</span><span class="o">.</span><span class="n">memory</span><span class="p">):</span>
    <span class="n">test_eq</span><span class="p">(</span><span class="n">baseline_step</span><span class="o">.</span><span class="n">state</span><span class="p">,</span><span class="n">memory_step</span><span class="o">.</span><span class="n">state</span><span class="p">)</span>
    <span class="n">test_eq</span><span class="p">(</span><span class="n">baseline_step</span><span class="o">.</span><span class="n">next_state</span><span class="p">,</span><span class="n">memory_step</span><span class="o">.</span><span class="n">next_state</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Since the <code>max_sz</code> is 20, and so far we have run a total of 20 steps, if we run another 10 steps,
the <code>_cycle_tracker</code> should be 1 (since this is a new cycle),<code>_idx_tracker</code> should be 10 since it should 
have reset and stopped half way in the memory. The <code>_sz_tracker</code> should still be 20.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">steps</span> <span class="o">=</span> <span class="p">[</span><span class="n">step</span> <span class="k">for</span> <span class="n">step</span><span class="p">,</span><span class="n">_</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span><span class="n">experience_replay</span><span class="p">))]</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">experience_replay</span><span class="o">.</span><span class="n">_sz_tracker</span><span class="p">,</span><span class="mi">20</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">experience_replay</span><span class="o">.</span><span class="n">_idx_tracker</span><span class="p">,</span><span class="mi">10</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">experience_replay</span><span class="o">.</span><span class="n">_cycle_tracker</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<span class="n">test_len</span><span class="p">(</span><span class="n">experience_replay</span><span class="p">,</span><span class="mi">20</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>...and if we run the baseline, the last 10 steps in the baseline, should match the first 10 steps in memory
since it is in the middle of re-writing the memory due to being at max size.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">steps</span><span class="p">,</span> <span class="n">pipe</span> <span class="o">=</span> <span class="n">baseline_test</span><span class="p">([</span><span class="s1">&#39;CartPole-v1&#39;</span><span class="p">],</span><span class="mi">30</span><span class="p">)</span>

<span class="k">for</span> <span class="n">baseline_step</span><span class="p">,</span><span class="n">memory_step</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">steps</span><span class="p">[</span><span class="mi">20</span><span class="p">:],</span><span class="n">experience_replay</span><span class="o">.</span><span class="n">memory</span><span class="p">[:</span><span class="mi">10</span><span class="p">]):</span>
    <span class="n">test_eq</span><span class="p">(</span><span class="n">baseline_step</span><span class="o">.</span><span class="n">state</span><span class="p">,</span><span class="n">memory_step</span><span class="o">.</span><span class="n">state</span><span class="p">)</span>
    <span class="n">test_eq</span><span class="p">(</span><span class="n">baseline_step</span><span class="o">.</span><span class="n">next_state</span><span class="p">,</span><span class="n">memory_step</span><span class="o">.</span><span class="n">next_state</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Finally we want to finish writing over the memory in its entirety.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">steps</span> <span class="o">=</span> <span class="p">[</span><span class="n">step</span> <span class="k">for</span> <span class="n">step</span><span class="p">,</span><span class="n">_</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span><span class="n">experience_replay</span><span class="p">))]</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">experience_replay</span><span class="o">.</span><span class="n">_sz_tracker</span><span class="p">,</span><span class="mi">20</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">experience_replay</span><span class="o">.</span><span class="n">_idx_tracker</span><span class="p">,</span><span class="mi">20</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">experience_replay</span><span class="o">.</span><span class="n">_cycle_tracker</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<span class="n">test_len</span><span class="p">(</span><span class="n">experience_replay</span><span class="p">,</span><span class="mi">20</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">steps</span><span class="p">,</span> <span class="n">pipe</span> <span class="o">=</span> <span class="n">baseline_test</span><span class="p">([</span><span class="s1">&#39;CartPole-v1&#39;</span><span class="p">],</span><span class="mi">40</span><span class="p">)</span>

<span class="k">for</span> <span class="n">baseline_step</span><span class="p">,</span><span class="n">memory_step</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">steps</span><span class="p">[</span><span class="mi">20</span><span class="p">:],</span><span class="n">experience_replay</span><span class="o">.</span><span class="n">memory</span><span class="p">):</span>
    <span class="n">test_eq</span><span class="p">(</span><span class="n">baseline_step</span><span class="o">.</span><span class="n">state</span><span class="p">,</span><span class="n">memory_step</span><span class="o">.</span><span class="n">state</span><span class="p">)</span>
    <span class="n">test_eq</span><span class="p">(</span><span class="n">baseline_step</span><span class="o">.</span><span class="n">next_state</span><span class="p">,</span><span class="n">memory_step</span><span class="o">.</span><span class="n">next_state</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Let's verify that the steps are what we expect...</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><strong>What if we sample the experience?</strong></p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">steps</span><span class="p">,</span> <span class="n">experience_replay</span> <span class="o">=</span> <span class="n">exp_replay_test</span><span class="p">([</span><span class="s1">&#39;CartPole-v1&#39;</span><span class="p">],</span><span class="mi">1000</span><span class="p">,</span><span class="n">bs</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span><span class="n">max_sz</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
<span class="n">memory</span> <span class="o">=</span> <span class="kc">None</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">sample</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">experience_replay</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">sample</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">memory</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">test_ne</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">memory</span><span class="p">)</span>
        <span class="n">memory</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">i</span><span class="o">&gt;</span><span class="mi">100</span><span class="p">:</span><span class="k">break</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>We should be able to sample enough times that we have sampled <strong>everything</strong>. 
So we test this by sampling, check if that sample has been seen before, and then record that.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">steps</span><span class="p">,</span> <span class="n">experience_replay</span> <span class="o">=</span> <span class="n">exp_replay_test</span><span class="p">([</span><span class="s1">&#39;CartPole-v1&#39;</span><span class="p">],</span><span class="mi">1000</span><span class="p">,</span><span class="n">bs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">max_sz</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span><span class="n">return_idxs</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">memory_hits</span> <span class="o">=</span> <span class="p">[</span><span class="kc">False</span><span class="p">]</span><span class="o">*</span><span class="mi">30</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">150</span><span class="p">):</span>
    <span class="n">res</span><span class="p">,</span><span class="n">idxs</span> <span class="o">=</span> <span class="n">experience_replay</span><span class="o">.</span><span class="n">sample</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">idxs</span><span class="p">:</span> <span class="n">memory_hits</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">test_eq</span><span class="p">(</span><span class="nb">all</span><span class="p">(</span><span class="n">memory_hits</span><span class="p">),</span><span class="kc">True</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

</div>


