---

title: DQN Targets + N-Step


keywords: fastai
sidebar: home_sidebar

summary: "A Bare-Bones DQN is usually extremely unstable. Target models can eleviate this. We also support First-Last N steps better."
description: "A Bare-Bones DQN is usually extremely unstable. Target models can eleviate this. We also support First-Last N steps better."
nb_path: "nbs/10b_agents.dqn.targets-Copy1.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: nbs/10b_agents.dqn.targets-Copy1.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="DQNTargetTrainer" class="doc_header"><code>class</code> <code>DQNTargetTrainer</code><a href="https://github.com/josiahls/fastrl/tree/master/fastrl/agents/dqn/targets.py#L24" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>DQNTargetTrainer</code>(<strong><code>discount</code></strong>=<em><code>0.99</code></em>, <strong><code>n_batch</code></strong>=<em><code>0</code></em>, <strong><code>target_sync</code></strong>=<em><code>300</code></em>, <strong><code>n_steps</code></strong>=<em><code>1</code></em>) :: <code>Callback</code></p>
</blockquote>
<p>Basic class handling tweaks of the training loop by changing a <code>Learner</code> in various events</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">dqn</span><span class="o">=</span><span class="n">DQN</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
<span class="n">agent</span><span class="o">=</span><span class="n">Agent</span><span class="p">(</span><span class="n">dqn</span><span class="p">,</span><span class="n">cbs</span><span class="o">=</span><span class="p">[</span><span class="n">ArgMaxFeed</span><span class="p">,</span><span class="n">DiscreteEpsilonRandomSelect</span><span class="p">])</span>
<span class="n">source</span><span class="o">=</span><span class="n">Src</span><span class="p">(</span><span class="s1">&#39;CartPole-v1&#39;</span><span class="p">,</span><span class="n">agent</span><span class="p">,</span><span class="n">seed</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">steps_count</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">n_envs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">steps_delta</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">cbs</span><span class="o">=</span><span class="p">[</span><span class="n">GymSrc</span><span class="p">,</span><span class="n">FirstLast</span><span class="p">])</span>

<span class="n">dls</span><span class="o">=</span><span class="n">SourceDataBlock</span><span class="p">(</span>
    <span class="n">blocks</span><span class="o">=</span><span class="n">SourceBlock</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
<span class="p">)</span><span class="o">.</span><span class="n">dataloaders</span><span class="p">([</span><span class="n">source</span><span class="p">],</span><span class="n">n</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span><span class="n">bs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">num_workers</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="n">learn</span><span class="o">=</span><span class="n">Learner</span><span class="p">(</span><span class="n">dls</span><span class="p">,</span><span class="n">agent</span><span class="p">,</span><span class="n">loss_func</span><span class="o">=</span><span class="n">MSELoss</span><span class="p">(),</span>
              <span class="n">cbs</span><span class="o">=</span><span class="p">[</span><span class="n">ExperienceReplay</span><span class="p">(</span><span class="n">bs</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span><span class="n">max_sz</span><span class="o">=</span><span class="mi">100000</span><span class="p">,</span><span class="n">warmup_sz</span><span class="o">=</span><span class="mi">32</span><span class="p">),</span><span class="n">DQNTargetTrainer</span><span class="p">],</span>
              <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="n">Reward</span><span class="p">,</span><span class="n">Epsilon</span><span class="p">])</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learn</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="mi">47</span><span class="p">,</span><span class="n">lr</span><span class="o">=</span><span class="mf">0.0001</span><span class="p">,</span><span class="n">wd</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea ">
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: left;">
      <th>epoch</th>
      <th>train_loss</th>
      <th>train_reward</th>
      <th>train_epsilon</th>
      <th>valid_loss</th>
      <th>valid_reward</th>
      <th>valid_epsilon</th>
      <th>time</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>0.334313</td>
      <td>20.038462</td>
      <td>0.800000</td>
      <td>00:19</td>
    </tr>
    <tr>
      <td>1</td>
      <td>0.676860</td>
      <td>20.980000</td>
      <td>0.600000</td>
      <td>00:19</td>
    </tr>
    <tr>
      <td>2</td>
      <td>0.743174</td>
      <td>20.880000</td>
      <td>0.400000</td>
      <td>00:19</td>
    </tr>
    <tr>
      <td>3</td>
      <td>1.276103</td>
      <td>24.370000</td>
      <td>0.200000</td>
      <td>00:19</td>
    </tr>
    <tr>
      <td>4</td>
      <td>1.712288</td>
      <td>25.760000</td>
      <td>0.200000</td>
      <td>00:19</td>
    </tr>
    <tr>
      <td>5</td>
      <td>1.759551</td>
      <td>30.630000</td>
      <td>0.200000</td>
      <td>00:19</td>
    </tr>
    <tr>
      <td>6</td>
      <td>2.994070</td>
      <td>32.510000</td>
      <td>0.200000</td>
      <td>00:18</td>
    </tr>
    <tr>
      <td>7</td>
      <td>3.622862</td>
      <td>34.980000</td>
      <td>0.200000</td>
      <td>00:19</td>
    </tr>
    <tr>
      <td>8</td>
      <td>4.652473</td>
      <td>35.050000</td>
      <td>0.200000</td>
      <td>00:21</td>
    </tr>
    <tr>
      <td>9</td>
      <td>4.479828</td>
      <td>34.320000</td>
      <td>0.200000</td>
      <td>00:23</td>
    </tr>
    <tr>
      <td>10</td>
      <td>4.942077</td>
      <td>34.950000</td>
      <td>0.200000</td>
      <td>00:25</td>
    </tr>
    <tr>
      <td>11</td>
      <td>5.326796</td>
      <td>34.790000</td>
      <td>0.200000</td>
      <td>00:24</td>
    </tr>
    <tr>
      <td>12</td>
      <td>4.387165</td>
      <td>36.600000</td>
      <td>0.200000</td>
      <td>00:24</td>
    </tr>
    <tr>
      <td>13</td>
      <td>6.445348</td>
      <td>38.690000</td>
      <td>0.200000</td>
      <td>00:25</td>
    </tr>
    <tr>
      <td>14</td>
      <td>5.375407</td>
      <td>39.270000</td>
      <td>0.200000</td>
      <td>00:24</td>
    </tr>
    <tr>
      <td>15</td>
      <td>8.442756</td>
      <td>42.020000</td>
      <td>0.200000</td>
      <td>00:25</td>
    </tr>
    <tr>
      <td>16</td>
      <td>7.077539</td>
      <td>40.380000</td>
      <td>0.200000</td>
      <td>00:24</td>
    </tr>
    <tr>
      <td>17</td>
      <td>6.406795</td>
      <td>38.550000</td>
      <td>0.200000</td>
      <td>00:25</td>
    </tr>
    <tr>
      <td>18</td>
      <td>8.157024</td>
      <td>39.930000</td>
      <td>0.200000</td>
      <td>00:24</td>
    </tr>
    <tr>
      <td>19</td>
      <td>8.742580</td>
      <td>40.140000</td>
      <td>0.200000</td>
      <td>00:24</td>
    </tr>
    <tr>
      <td>20</td>
      <td>9.661374</td>
      <td>40.490000</td>
      <td>0.200000</td>
      <td>00:25</td>
    </tr>
    <tr>
      <td>21</td>
      <td>7.656657</td>
      <td>42.480000</td>
      <td>0.200000</td>
      <td>00:25</td>
    </tr>
    <tr>
      <td>22</td>
      <td>9.534591</td>
      <td>43.900000</td>
      <td>0.200000</td>
      <td>00:25</td>
    </tr>
    <tr>
      <td>23</td>
      <td>10.476411</td>
      <td>45.490000</td>
      <td>0.200000</td>
      <td>00:25</td>
    </tr>
    <tr>
      <td>24</td>
      <td>7.879462</td>
      <td>45.680000</td>
      <td>0.200000</td>
      <td>00:24</td>
    </tr>
    <tr>
      <td>25</td>
      <td>11.972182</td>
      <td>44.410000</td>
      <td>0.200000</td>
      <td>00:25</td>
    </tr>
    <tr>
      <td>26</td>
      <td>10.250607</td>
      <td>47.670000</td>
      <td>0.200000</td>
      <td>00:24</td>
    </tr>
    <tr>
      <td>27</td>
      <td>12.760225</td>
      <td>49.290000</td>
      <td>0.200000</td>
      <td>00:24</td>
    </tr>
    <tr>
      <td>28</td>
      <td>14.717470</td>
      <td>52.380000</td>
      <td>0.200000</td>
      <td>00:24</td>
    </tr>
    <tr>
      <td>29</td>
      <td>10.258933</td>
      <td>52.070000</td>
      <td>0.200000</td>
      <td>00:25</td>
    </tr>
    <tr>
      <td>30</td>
      <td>12.807858</td>
      <td>53.880000</td>
      <td>0.200000</td>
      <td>00:25</td>
    </tr>
    <tr>
      <td>31</td>
      <td>12.815685</td>
      <td>54.360000</td>
      <td>0.200000</td>
      <td>00:24</td>
    </tr>
    <tr>
      <td>32</td>
      <td>10.723271</td>
      <td>54.810000</td>
      <td>0.200000</td>
      <td>00:24</td>
    </tr>
    <tr>
      <td>33</td>
      <td>17.827276</td>
      <td>54.370000</td>
      <td>0.200000</td>
      <td>00:24</td>
    </tr>
    <tr>
      <td>34</td>
      <td>21.730267</td>
      <td>54.870000</td>
      <td>0.200000</td>
      <td>00:25</td>
    </tr>
    <tr>
      <td>35</td>
      <td>13.061940</td>
      <td>57.360000</td>
      <td>0.200000</td>
      <td>00:25</td>
    </tr>
    <tr>
      <td>36</td>
      <td>17.304792</td>
      <td>58.400000</td>
      <td>0.200000</td>
      <td>00:24</td>
    </tr>
    <tr>
      <td>37</td>
      <td>15.901886</td>
      <td>56.890000</td>
      <td>0.200000</td>
      <td>00:24</td>
    </tr>
    <tr>
      <td>38</td>
      <td>23.815809</td>
      <td>59.040000</td>
      <td>0.200000</td>
      <td>00:24</td>
    </tr>
    <tr>
      <td>39</td>
      <td>17.793276</td>
      <td>57.480000</td>
      <td>0.200000</td>
      <td>00:25</td>
    </tr>
    <tr>
      <td>40</td>
      <td>19.123775</td>
      <td>62.750000</td>
      <td>0.200000</td>
      <td>00:25</td>
    </tr>
    <tr>
      <td>41</td>
      <td>15.577535</td>
      <td>61.440000</td>
      <td>0.200000</td>
      <td>00:25</td>
    </tr>
    <tr>
      <td>42</td>
      <td>19.763550</td>
      <td>63.050000</td>
      <td>0.200000</td>
      <td>00:24</td>
    </tr>
    <tr>
      <td>43</td>
      <td>16.592752</td>
      <td>67.630000</td>
      <td>0.200000</td>
      <td>00:25</td>
    </tr>
    <tr>
      <td>44</td>
      <td>20.035053</td>
      <td>70.600000</td>
      <td>0.200000</td>
      <td>00:26</td>
    </tr>
    <tr>
      <td>45</td>
      <td>21.544369</td>
      <td>69.850000</td>
      <td>0.200000</td>
      <td>00:26</td>
    </tr>
    <tr>
      <td>46</td>
      <td>21.044302</td>
      <td>75.850000</td>
      <td>0.200000</td>
      <td>00:25</td>
    </tr>
  </tbody>
</table>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

</div>
 

