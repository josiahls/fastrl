---

title: Loop


keywords: fastai
sidebar: home_sidebar

summary: "fastrl concept of generic loop objects. "
description: "fastrl concept of generic loop objects. "
nb_path: "nbs/02_fastai.loop.old.old.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: nbs/02_fastai.loop.old.old.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># Python native modules</span>
<span class="kn">import</span> <span class="nn">os</span><span class="o">,</span><span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">deepcopy</span><span class="p">,</span><span class="n">copy</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="nn">types</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">inspect</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">chain</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>
<span class="c1"># Third party libs</span>
<span class="kn">from</span> <span class="nn">fastcore.all</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="c1"># Local modules</span>

<span class="n">IN_IPYTHON</span><span class="o">=</span><span class="kc">False</span>

<span class="n">_logger</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Why-do-we-need-this?">Why do we need this?<a class="anchor-link" href="#Why-do-we-need-this?"> </a></h3><p>We have identified at least 3 different kinds of loops already:</p>

<pre><code>Learner (training)
Source/Gym (Data Access)
Agent (How an AI takes in data, generates actions)

</code></pre>
<h3 id="What-is-a-loop?">What is a loop?<a class="anchor-link" href="#What-is-a-loop?"> </a></h3>
<pre><code>It should be capable of containing inner loops. 
It should self-describe its structure. 
It should be easy to know which parts of the loop are taking long/short amounts of time.
It should be flexible in state modification.
It should alternatively make it easy show what fields are being changed at what points in time.</code></pre>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>A Loop will act as a compiled structure. The actual result will be a compiled list of nodes that reference the original loop.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">EVENT_ORDER_MAPPING</span><span class="o">=</span><span class="p">{}</span>
<span class="n">PREFIXES</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;before_&#39;</span><span class="p">,</span><span class="s1">&#39;on_&#39;</span><span class="p">,</span><span class="s1">&#39;after_&#39;</span><span class="p">,</span><span class="s1">&#39;failed_&#39;</span><span class="p">,</span><span class="s1">&#39;finally_&#39;</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">_is_event</span><span class="p">(</span><span class="n">o</span><span class="p">):</span> <span class="k">return</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">o</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span><span class="n">Event</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">_last_element</span><span class="p">(</span><span class="n">ls</span><span class="p">):</span> <span class="k">return</span> <span class="n">ls</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="k">def</span> <span class="nf">_grab_full_name</span><span class="p">(</span><span class="n">o</span><span class="p">:</span><span class="s1">&#39;Event&#39;</span><span class="p">):</span> <span class="k">return</span> <span class="n">o</span><span class="o">.</span><span class="n">full_name</span>

<span class="k">class</span> <span class="nc">EventException</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span><span class="k">pass</span>

<span class="k">def</span> <span class="nf">event_parent_iter</span><span class="p">(</span><span class="n">event</span><span class="p">:</span><span class="s1">&#39;Event&#39;</span><span class="p">):</span>
    <span class="k">yield</span> <span class="n">event</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">event</span><span class="o">=</span><span class="n">event</span><span class="o">.</span><span class="n">parent_event</span>
        <span class="k">if</span> <span class="n">event</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="k">break</span>
        <span class="k">yield</span> <span class="n">event</span>
    
<span class="k">def</span> <span class="nf">custom_traceback</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;hi&#39;</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">Event</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">function</span><span class="p">:</span><span class="n">Callable</span><span class="p">,</span>
                 <span class="n">loop</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">parent_event</span><span class="o">=</span><span class="kc">None</span>
                <span class="p">):</span>
        <span class="n">store_attr</span><span class="p">()</span>
        <span class="c1"># We set the order over the entire Loop definition</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outer_name</span><span class="o">=</span><span class="n">function</span><span class="o">.</span><span class="vm">__module__</span><span class="o">+</span><span class="s1">&#39;.&#39;</span><span class="o">+</span><span class="n">function</span><span class="o">.</span><span class="vm">__qualname__</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">outer_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">EVENT_ORDER_MAPPING</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">order</span><span class="o">=</span><span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">order</span><span class="o">=</span><span class="n">EVENT_ORDER_MAPPING</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">outer_name</span><span class="p">]</span>
        <span class="n">EVENT_ORDER_MAPPING</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">outer_name</span><span class="p">]</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">order</span><span class="o">+</span><span class="mi">1</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">full_name</span><span class="o">=</span><span class="n">function</span><span class="o">.</span><span class="vm">__module__</span><span class="o">+</span><span class="s1">&#39;.&#39;</span><span class="o">+</span><span class="n">function</span><span class="o">.</span><span class="vm">__qualname__</span>
            
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">pre</span><span class="p">)</span> <span class="k">for</span> <span class="n">pre</span> <span class="ow">in</span> <span class="n">PREFIXES</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">EventException</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1"> needs to start with any </span><span class="si">{</span><span class="n">PREFIXES</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            
        <span class="bp">self</span><span class="o">.</span><span class="n">cbs</span><span class="o">=</span><span class="n">L</span><span class="p">()</span>
        
    <span class="k">def</span> <span class="nf">set_cbs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">cbs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">cbs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cbs</span><span class="o">=</span><span class="n">L</span><span class="p">((</span><span class="n">cb</span><span class="p">()</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cb</span><span class="p">,</span> <span class="nb">type</span><span class="p">)</span> <span class="k">else</span> <span class="n">cb</span><span class="p">)</span> <span class="k">for</span> <span class="n">cb</span> <span class="ow">in</span> <span class="n">L</span><span class="p">(</span><span class="n">cbs</span><span class="p">)</span> 
                       <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">cb</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">cb</span><span class="o">.</span><span class="n">call_on</span> <span class="ow">or</span> <span class="nb">any</span><span class="p">([</span><span class="n">isrelevent</span><span class="p">(</span><span class="n">cb</span><span class="p">,</span><span class="n">e</span><span class="p">)</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">event_parent_iter</span><span class="p">(</span><span class="bp">self</span><span class="p">)])))</span>
            
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">root_loop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">loop</span><span class="o">.</span><span class="n">root_loop</span>
    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span> 
        <span class="n">ret</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loop</span><span class="p">,</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>                             <span class="c1"># fastrl.skip_traceback</span>
        <span class="k">for</span> <span class="n">cb</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cbs</span><span class="p">:</span> <span class="n">cb_ret</span><span class="o">=</span><span class="nb">getattr</span><span class="p">(</span><span class="n">cb</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)()</span>
        <span class="k">return</span> <span class="n">ret</span>

    <span class="k">def</span> <span class="fm">__lt__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">o</span><span class="p">:</span><span class="s1">&#39;Event&#39;</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">order</span><span class="o">&lt;</span><span class="n">o</span><span class="o">.</span><span class="n">order</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">function</span><span class="o">.</span><span class="vm">__name__</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">prefix</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;_&#39;</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">postfix</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">:])</span>
    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">full_name</span>
    
    <span class="k">def</span> <span class="nf">show</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">n_tab</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">n_cbs</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">include_cbs</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">kwargs</span><span class="o">=</span><span class="n">merge</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">n_cbs</span><span class="o">=</span><span class="n">n_cbs</span><span class="p">,</span><span class="n">include_cbs</span><span class="o">=</span><span class="n">include_cbs</span><span class="p">),</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">tab</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">loop</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">loop</span><span class="o">.</span><span class="n">root_loop</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">loop</span><span class="o">.</span><span class="n">root_loop</span><span class="o">.</span><span class="n">tab</span>
        <span class="n">event</span><span class="o">=</span><span class="n">n_tab</span><span class="o">*</span><span class="n">tab</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">full_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cbs</span><span class="p">:</span> <span class="n">event</span><span class="o">+=</span><span class="sa">f</span><span class="s1">&#39; #</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cbs</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="k">if</span> <span class="n">include_cbs</span><span class="p">:</span> 
            <span class="k">for</span> <span class="n">cb</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cbs</span><span class="p">:</span>
                <span class="n">event</span><span class="o">+=</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">+</span><span class="p">(</span><span class="n">n_tab</span><span class="o">*</span><span class="n">tab</span><span class="p">)</span><span class="o">+</span><span class="n">cb</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">n_tab</span><span class="o">=</span><span class="n">n_tab</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">event</span>
    
<span class="k">def</span> <span class="nf">isrelevent</span><span class="p">(</span><span class="n">loop_or_cb</span><span class="p">,</span><span class="n">event</span><span class="p">:</span><span class="n">Event</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">event</span><span class="p">,(</span><span class="nb">list</span><span class="p">,</span><span class="n">L</span><span class="p">)):</span> <span class="k">return</span> <span class="kc">False</span>
    <span class="k">return</span> <span class="n">event</span><span class="o">.</span><span class="n">full_name</span> <span class="ow">in</span> <span class="n">loop_or_cb</span><span class="o">.</span><span class="n">call_on</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">_grab_full_name</span><span class="p">)</span>

<span class="n">event</span><span class="o">=</span><span class="n">Event</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">on_test</span><span class="p">():</span><span class="k">pass</span>

<span class="n">decorated_on_test</span><span class="o">=</span><span class="n">Event</span><span class="p">(</span><span class="n">on_test</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">decorated_on_test</span><span class="o">.</span><span class="n">full_name</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>&#39;__main__.on_test&#39;</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">B</span><span class="p">():</span>
    <span class="nd">@event</span>
    <span class="k">def</span> <span class="nf">on_test_2_a</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span><span class="k">pass</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">B</span><span class="o">.</span><span class="n">on_test_2_a</span><span class="o">.</span><span class="n">full_name</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>&#39;__main__.B.on_test_2_a&#39;</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">A</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="n">loop</span><span class="p">,</span><span class="n">root_loop</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span>
    
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">events</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span><span class="n">instance</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">instantiate</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">loop</span><span class="o">=</span><span class="n">instance</span> <span class="k">if</span> <span class="n">instance</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">(</span><span class="bp">cls</span><span class="p">()</span> <span class="k">if</span> <span class="n">instantiate</span> <span class="k">else</span> <span class="bp">cls</span><span class="p">)</span>
        <span class="n">events</span><span class="o">=</span><span class="n">L</span><span class="p">(</span><span class="n">inspect</span><span class="o">.</span><span class="n">getmembers</span><span class="p">(</span><span class="n">loop</span><span class="p">))</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">_last_element</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">_is_event</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">events</span><span class="p">:</span> <span class="n">o</span><span class="o">.</span><span class="n">loop</span><span class="o">=</span><span class="n">loop</span>
        <span class="k">return</span> <span class="n">events</span>
    
    <span class="nd">@event</span>
    <span class="k">def</span> <span class="nf">before_test_c</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span><span class="nb">print</span><span class="p">(</span><span class="s1">&#39;before_test_c&#39;</span><span class="p">)</span>
    <span class="nd">@event</span>
    <span class="k">def</span> <span class="nf">on_test_c</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span><span class="nb">print</span><span class="p">(</span><span class="s1">&#39;on_test_c&#39;</span><span class="p">)</span>
    <span class="nd">@event</span>
    <span class="k">def</span> <span class="nf">after_test_c</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span><span class="nb">print</span><span class="p">(</span><span class="s1">&#39;after_test_c&#39;</span><span class="p">)</span>
    <span class="nd">@event</span>
    <span class="k">def</span> <span class="nf">after_test_c</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span><span class="nb">print</span><span class="p">(</span><span class="s1">&#39;after_test_c&#39;</span><span class="p">)</span>
    <span class="nd">@event</span>
    <span class="k">def</span> <span class="nf">on_test_b</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span><span class="nb">print</span><span class="p">(</span><span class="s1">&#39;on_test_b&#39;</span><span class="p">)</span>
    <span class="nd">@event</span>
    <span class="k">def</span> <span class="nf">on_test_a</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span><span class="nb">print</span><span class="p">(</span><span class="s1">&#39;on_test_a&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">A</span><span class="p">()</span><span class="o">.</span><span class="n">before_test_c</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>before_test_c
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Notes:</p>
<ul>
<li>Having a section object might make this overal loop management better<ul>
<li>remaining stuff, the Section object needs to handle lists and execute those also.</li>
<li>with this in mind, using the section I think will make the looping run much cleaner.</li>
</ul>
</li>
</ul>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">_grab_postfix</span><span class="p">(</span><span class="n">e</span><span class="p">:</span><span class="n">Union</span><span class="p">[</span><span class="n">Event</span><span class="p">,</span><span class="nb">list</span><span class="p">],</span><span class="n">previous_event</span><span class="p">:</span><span class="nb">dict</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span> 
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">e</span><span class="p">,</span><span class="n">Event</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">previous_event</span><span class="p">:</span> 
            <span class="k">raise</span> <span class="n">SectionException</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s1"> doesnt have an event tied to it.&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">previous_event</span><span class="p">[</span><span class="s1">&#39;last_event&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">previous_event</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">previous_event</span><span class="p">[</span><span class="s1">&#39;last_event&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">e</span><span class="o">.</span><span class="n">postfix</span>
    <span class="k">return</span> <span class="n">e</span><span class="o">.</span><span class="n">postfix</span>

<span class="k">def</span> <span class="nf">_grab_prefix</span><span class="p">(</span><span class="n">o</span><span class="p">:</span><span class="n">Event</span><span class="p">):</span> <span class="k">return</span> <span class="n">o</span><span class="o">.</span><span class="n">prefix</span>
<span class="k">def</span> <span class="nf">_default_raise</span><span class="p">():</span> <span class="k">raise</span> 
<span class="k">def</span> <span class="nf">_event2dict</span><span class="p">(</span><span class="n">e</span><span class="p">:</span><span class="n">Union</span><span class="p">[</span><span class="n">Event</span><span class="p">,</span><span class="nb">list</span><span class="p">,</span><span class="n">L</span><span class="p">],</span><span class="n">previous_event</span><span class="p">:</span><span class="nb">dict</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">e</span><span class="p">,</span><span class="n">Event</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">previous_event</span><span class="p">:</span> 
            <span class="k">raise</span> <span class="n">SectionException</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s1"> doesnt have an event tied to it.&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">previous_event</span><span class="p">[</span><span class="s1">&#39;last_event&#39;</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;inner&#39;</span><span class="p">,</span><span class="n">e</span><span class="p">)</span>
    
    <span class="n">previous_event</span><span class="p">[</span><span class="s1">&#39;last_event&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">e</span><span class="o">.</span><span class="n">prefix</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">prefix</span><span class="p">,</span><span class="n">e</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_noop_event_pair</span><span class="p">(</span><span class="n">k</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">((</span><span class="n">k</span><span class="p">,</span><span class="n">noop</span> <span class="k">if</span> <span class="n">k</span><span class="o">!=</span><span class="s1">&#39;failed_&#39;</span> <span class="k">else</span> <span class="n">_default_raise</span><span class="p">),(</span><span class="n">k</span><span class="o">+</span><span class="s1">&#39;inner&#39;</span><span class="p">,[]))</span>


<span class="k">class</span> <span class="nc">SectionException</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span><span class="k">pass</span>

<span class="k">class</span> <span class="nc">Section</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">events</span><span class="p">,</span><span class="n">parent_event</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">store_attr</span><span class="p">(</span><span class="n">but</span><span class="o">=</span><span class="s1">&#39;events&#39;</span><span class="p">)</span>
        <span class="n">default_events</span><span class="o">=</span><span class="n">L</span><span class="p">(</span><span class="n">PREFIXES</span><span class="p">)</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">_noop_event_pair</span><span class="p">)</span>
        <span class="n">default_events</span><span class="o">=</span><span class="n">L</span><span class="p">(</span><span class="n">chain</span><span class="o">.</span><span class="n">from_iterable</span><span class="p">(</span><span class="n">default_events</span><span class="p">))</span>
        <span class="n">previous_event</span><span class="o">=</span><span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">events_ls</span><span class="o">=</span><span class="p">[</span><span class="n">o</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">events</span> <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">o</span><span class="p">,(</span><span class="nb">list</span><span class="p">,</span><span class="n">L</span><span class="p">))</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">o</span><span class="p">)</span><span class="o">!=</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">parent_event</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> 
            <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">events_ls</span><span class="p">:</span> <span class="n">event</span><span class="o">.</span><span class="n">parent_event</span><span class="o">=</span><span class="n">parent_event</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">events</span><span class="o">=</span><span class="n">merge</span><span class="p">(</span>
            <span class="nb">dict</span><span class="p">(</span><span class="n">default_events</span><span class="p">),</span>
            <span class="nb">dict</span><span class="p">(</span><span class="n">L</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">events_ls</span><span class="p">)</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">_event2dict</span><span class="p">,</span><span class="n">previous_event</span><span class="o">=</span><span class="n">previous_event</span><span class="p">))</span>
        <span class="p">)</span>
        
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">root_loop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">events_ls</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">root_loop</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">loop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">events_ls</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">loop</span>
    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">L</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">events</span><span class="o">.</span><span class="n">values</span><span class="p">())</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">_is_event</span><span class="p">))</span> 

    <span class="nd">@delegates</span><span class="p">(</span><span class="n">Event</span><span class="o">.</span><span class="n">show</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">show</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">n_tab</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">n_events</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">include_events</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">include_defaults</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">kwargs</span><span class="o">=</span><span class="n">merge</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">n_events</span><span class="o">=</span><span class="n">n_events</span><span class="p">,</span>
                          <span class="n">include_events</span><span class="o">=</span><span class="n">include_events</span><span class="p">,</span>
                          <span class="n">include_defaults</span><span class="o">=</span><span class="n">include_defaults</span><span class="p">),</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">tab</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">root_loop</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">root_loop</span><span class="o">.</span><span class="n">tab</span>
        <span class="n">section</span><span class="o">=</span><span class="n">n_tab</span><span class="o">*</span><span class="n">tab</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">n_events</span><span class="p">:</span><span class="n">section</span><span class="o">+=</span><span class="sa">f</span><span class="s1">&#39; </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="si">}</span><span class="s1"> events&#39;</span>
        <span class="k">if</span> <span class="n">include_events</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">events</span><span class="o">.</span><span class="n">values</span><span class="p">():</span> 
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">event</span><span class="p">,(</span><span class="nb">list</span><span class="p">,</span><span class="n">L</span><span class="p">)):</span>
                    <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">event</span><span class="p">:</span>
                        <span class="n">section</span><span class="o">+=</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">+</span><span class="p">(</span><span class="n">n_tab</span><span class="o">*</span><span class="n">tab</span><span class="p">)</span><span class="o">+</span><span class="n">o</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">n_tab</span><span class="o">=</span><span class="n">n_tab</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">event</span> <span class="ow">in</span> <span class="p">[</span><span class="n">_default_raise</span><span class="p">,</span><span class="n">noop</span><span class="p">]</span> <span class="ow">and</span> <span class="n">include_defaults</span><span class="p">:</span>
                    <span class="n">section</span><span class="o">+=</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">+</span><span class="p">((</span><span class="n">n_tab</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">tab</span><span class="p">)</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">event</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="n">_default_raise</span><span class="p">,</span><span class="n">noop</span><span class="p">]:</span>
                    <span class="n">section</span><span class="o">+=</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">+</span><span class="p">(</span><span class="n">n_tab</span><span class="o">*</span><span class="n">tab</span><span class="p">)</span><span class="o">+</span><span class="n">event</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">n_tab</span><span class="o">=</span><span class="n">n_tab</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">section</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">events</span><span class="p">[</span><span class="s1">&#39;before_&#39;</span><span class="p">]()</span>
            <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">events</span><span class="p">[</span><span class="s1">&#39;before_inner&#39;</span><span class="p">]:</span> <span class="n">o</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>                       <span class="c1"># fastrl.skip_traceback</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">events</span><span class="p">[</span><span class="s1">&#39;on_&#39;</span><span class="p">]()</span>
            <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">events</span><span class="p">[</span><span class="s1">&#39;on_inner&#39;</span><span class="p">]:</span> <span class="n">o</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">events</span><span class="p">[</span><span class="s1">&#39;after_&#39;</span><span class="p">]()</span>
            <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">events</span><span class="p">[</span><span class="s1">&#39;after_inner&#39;</span><span class="p">]:</span> <span class="n">o</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>                        <span class="c1"># fastrl.skip_traceback</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>     
                <span class="bp">self</span><span class="o">.</span><span class="n">events</span><span class="p">[</span><span class="s1">&#39;failed_&#39;</span><span class="p">]()</span>                                        <span class="c1"># fastrl.skip_traceback</span>
                <span class="k">raise</span>
            <span class="k">finally</span><span class="p">:</span> 
                <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">events</span><span class="p">[</span><span class="s1">&#39;failed_inner&#39;</span><span class="p">]:</span> <span class="n">o</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>                   <span class="c1"># fastrl.skip_traceback</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">events</span><span class="p">[</span><span class="s1">&#39;finally_&#39;</span><span class="p">]()</span>
            <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">events</span><span class="p">[</span><span class="s1">&#39;finally_inner&#39;</span><span class="p">]:</span> <span class="n">o</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>                      <span class="c1"># fastrl.skip_traceback</span>
    
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_events</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span><span class="n">events</span><span class="p">:</span><span class="n">List</span><span class="p">[</span><span class="n">Event</span><span class="p">],</span><span class="n">loop</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">parent_event</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">previous_event</span><span class="o">=</span><span class="p">{}</span>
        <span class="n">event_groups</span><span class="o">=</span><span class="n">groupby</span><span class="p">(</span><span class="n">events</span><span class="p">,</span><span class="n">partial</span><span class="p">(</span><span class="n">_grab_postfix</span><span class="p">,</span><span class="n">previous_event</span><span class="o">=</span><span class="n">previous_event</span><span class="p">))</span>
        <span class="k">return</span> <span class="p">[</span><span class="bp">cls</span><span class="p">(</span><span class="n">o</span><span class="p">,</span><span class="n">parent_event</span><span class="o">=</span><span class="n">parent_event</span><span class="p">)</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">event_groups</span><span class="o">.</span><span class="n">values</span><span class="p">()]</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">Section</span><span class="o">.</span><span class="n">from_events</span><span class="p">(</span><span class="n">A</span><span class="o">.</span><span class="n">events</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">events</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>{&#39;before_&#39;: __main__.A.before_test_c,
 &#39;before_inner&#39;: [],
 &#39;on_&#39;: __main__.A.on_test_c,
 &#39;on_inner&#39;: [],
 &#39;after_&#39;: __main__.A.after_test_c,
 &#39;after_inner&#39;: [],
 &#39;failed_&#39;: &lt;function __main__._default_raise()&gt;,
 &#39;failed_inner&#39;: [],
 &#39;finally_&#39;: &lt;function fastcore.imports.noop(x=None, *args, **kwargs)&gt;,
 &#39;finally_inner&#39;: []}</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">A</span><span class="o">.</span><span class="n">events</span><span class="p">(</span><span class="n">A</span><span class="p">())[</span><span class="mi">0</span><span class="p">]()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>after_test_c
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="p">[</span><span class="n">o</span><span class="o">.</span><span class="n">show</span><span class="p">(</span> 
    <span class="n">n_events</span><span class="o">=</span>      <span class="kc">True</span><span class="p">,</span>
    <span class="n">include_events</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">n_cbs</span><span class="o">=</span>         <span class="kc">True</span><span class="p">,</span>
    <span class="n">include_cbs</span><span class="o">=</span>   <span class="kc">True</span><span class="p">)</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">Section</span><span class="o">.</span><span class="n">from_events</span><span class="p">(</span><span class="n">A</span><span class="o">.</span><span class="n">events</span><span class="p">(</span><span class="n">A</span><span class="p">()))]</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>[&#39;Section 3 events\n\t__main__.A.before_test_c\n\t__main__.A.on_test_c\n\t__main__.A.after_test_c&#39;,
 &#39;Section 1 events\n\t__main__.A.on_test_a&#39;,
 &#39;Section 1 events\n\t__main__.A.on_test_b&#39;]</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="p">[</span><span class="nb">print</span><span class="p">(</span><span class="n">o</span><span class="o">.</span><span class="n">show</span><span class="p">(</span> 
    <span class="n">n_events</span><span class="o">=</span>      <span class="kc">True</span><span class="p">,</span>
    <span class="n">include_events</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">n_cbs</span><span class="o">=</span>         <span class="kc">True</span><span class="p">,</span>
    <span class="n">include_cbs</span><span class="o">=</span>   <span class="kc">True</span><span class="p">))</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">Section</span><span class="o">.</span><span class="n">from_events</span><span class="p">(</span><span class="n">A</span><span class="o">.</span><span class="n">events</span><span class="p">(</span><span class="n">A</span><span class="p">()))]</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Section 3 events
	__main__.A.before_test_c
	__main__.A.on_test_c
	__main__.A.after_test_c
Section 1 events
	__main__.A.on_test_a
Section 1 events
	__main__.A.on_test_b
</pre>
</div>
</div>

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>[None, None, None]</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="p">[</span><span class="n">o</span><span class="o">.</span><span class="n">run</span><span class="p">()</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">Section</span><span class="o">.</span><span class="n">from_events</span><span class="p">(</span><span class="n">A</span><span class="o">.</span><span class="n">events</span><span class="p">(</span><span class="n">A</span><span class="p">()))]</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>before_test_c
on_test_c
after_test_c
on_test_a
on_test_b
</pre>
</div>
</div>

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>[None, None, None]</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">_is_event</span><span class="p">(</span><span class="n">o</span><span class="p">):</span> <span class="k">return</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">o</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span><span class="n">Event</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">_last_element</span><span class="p">(</span><span class="n">ls</span><span class="p">):</span> <span class="k">return</span> <span class="n">ls</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="k">def</span> <span class="nf">_loop2sections</span><span class="p">(</span><span class="n">loop</span><span class="p">,</span><span class="n">loops</span><span class="p">,</span><span class="n">cbs</span><span class="p">):</span> <span class="k">return</span> <span class="n">loop</span><span class="o">.</span><span class="n">sections</span><span class="p">(</span><span class="n">loops</span><span class="o">=</span><span class="n">loops</span><span class="p">,</span><span class="n">cbs</span><span class="o">=</span><span class="n">cbs</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">_loop_with_sections</span><span class="p">(</span><span class="n">loop</span><span class="p">,</span><span class="n">loops</span><span class="p">,</span><span class="n">cbs</span><span class="p">,</span><span class="n">parent</span><span class="p">,</span><span class="n">parent_event</span><span class="p">):</span> 
    <span class="n">loop</span><span class="o">.</span><span class="n">loop</span><span class="o">=</span><span class="n">parent</span>
    <span class="k">return</span> <span class="n">loop</span><span class="o">.</span><span class="n">from_sections</span><span class="p">(</span><span class="n">loops</span><span class="o">=</span><span class="n">loops</span><span class="p">,</span><span class="n">cbs</span><span class="o">=</span><span class="n">cbs</span><span class="p">,</span><span class="n">parent_event</span><span class="o">=</span><span class="n">parent_event</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">class_or_instancemethod</span><span class="p">(</span><span class="nb">classmethod</span><span class="p">):</span>
    <span class="s2">&quot;From: https://stackoverflow.com/questions/28237955/same-name-for-classmethod-and-instancemethod&quot;</span>
    <span class="k">def</span> <span class="fm">__get__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">type_</span><span class="p">):</span>
        <span class="n">descr_get</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__get__</span> <span class="k">if</span> <span class="n">instance</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__func__</span><span class="o">.</span><span class="fm">__get__</span>
        <span class="k">return</span> <span class="n">descr_get</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">type_</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">Loop</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>  
    <span class="n">call_on</span><span class="p">,</span><span class="n">loop</span><span class="p">,</span><span class="n">loops</span><span class="p">,</span><span class="n">cbs</span><span class="p">,</span><span class="n">tab</span><span class="p">,</span><span class="n">verbose</span><span class="o">=</span><span class="n">L</span><span class="p">(),</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">,</span><span class="s1">&#39;  &#39;</span><span class="p">,</span><span class="kc">False</span>
    
    <span class="nd">@class_or_instancemethod</span>
    <span class="k">def</span> <span class="nf">events</span><span class="p">(</span><span class="n">cls_or_self</span><span class="p">,</span><span class="n">loops</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">cbs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">events</span><span class="o">=</span><span class="n">L</span><span class="p">(</span><span class="n">inspect</span><span class="o">.</span><span class="n">getmembers</span><span class="p">(</span><span class="n">cls_or_self</span><span class="p">))</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">_last_element</span><span class="p">)</span>\
                                                 <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">_is_event</span><span class="p">)</span>\
                                                 <span class="o">.</span><span class="n">sorted</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">events</span><span class="p">:</span> 
            <span class="n">o</span><span class="o">.</span><span class="n">loop</span><span class="o">=</span><span class="n">cls_or_self</span>
            <span class="k">for</span> <span class="n">cb</span> <span class="ow">in</span> <span class="n">L</span><span class="p">(</span><span class="n">cbs</span><span class="p">):</span> <span class="n">cb</span><span class="o">.</span><span class="n">loop</span><span class="o">=</span><span class="n">cls_or_self</span>
            <span class="n">o</span><span class="o">.</span><span class="n">set_cbs</span><span class="p">(</span><span class="n">cbs</span><span class="p">)</span>
        
        <span class="n">events</span><span class="o">=</span><span class="n">chain</span><span class="o">.</span><span class="n">from_iterable</span><span class="p">([</span>
            <span class="p">(</span><span class="n">o</span><span class="p">,</span><span class="n">L</span><span class="p">(</span><span class="n">ifnone</span><span class="p">(</span><span class="n">loops</span><span class="p">,</span><span class="n">L</span><span class="p">())</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">isrelevent</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="n">o</span><span class="p">)</span>\
                                <span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">_loop_with_sections</span><span class="p">,</span>
                                     <span class="n">loops</span><span class="o">=</span><span class="n">loops</span><span class="p">,</span><span class="n">cbs</span><span class="o">=</span><span class="n">cbs</span><span class="p">,</span>
                                     <span class="n">parent</span><span class="o">=</span><span class="n">cls_or_self</span><span class="p">,</span>
                                     <span class="n">parent_event</span><span class="o">=</span><span class="n">o</span><span class="p">)))</span> 
            <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">events</span>
        <span class="p">])</span>
        <span class="k">return</span> <span class="n">events</span>

    <span class="nd">@class_or_instancemethod</span>
    <span class="k">def</span> <span class="nf">get_sections</span><span class="p">(</span><span class="n">cls_or_self</span><span class="p">,</span><span class="n">loops</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">cbs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">parent_event</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">cls_or_self</span><span class="o">.</span><span class="n">loops</span><span class="o">=</span><span class="n">ifnone</span><span class="p">(</span><span class="n">cls_or_self</span><span class="o">.</span><span class="n">loops</span><span class="p">,</span><span class="n">loops</span><span class="p">)</span>
        <span class="n">cls_or_self</span><span class="o">.</span><span class="n">cbs</span><span class="o">=</span><span class="n">ifnone</span><span class="p">(</span><span class="n">cls_or_self</span><span class="o">.</span><span class="n">cbs</span><span class="p">,</span><span class="n">cbs</span><span class="p">)</span>
        <span class="n">events</span><span class="o">=</span><span class="n">cls_or_self</span><span class="o">.</span><span class="n">events</span><span class="p">(</span><span class="n">loops</span><span class="o">=</span><span class="n">L</span><span class="p">(</span><span class="n">cls_or_self</span><span class="o">.</span><span class="n">loops</span><span class="p">),</span><span class="n">cbs</span><span class="o">=</span><span class="n">L</span><span class="p">(</span><span class="n">cls_or_self</span><span class="o">.</span><span class="n">cbs</span><span class="p">))</span>
        <span class="n">sections</span><span class="o">=</span><span class="n">Section</span><span class="o">.</span><span class="n">from_events</span><span class="p">(</span><span class="n">events</span><span class="p">,</span><span class="n">cls_or_self</span><span class="p">,</span><span class="n">parent_event</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">sections</span>
    
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_sections</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">loop</span><span class="o">=</span><span class="bp">cls</span><span class="p">()</span>
        <span class="n">loop</span><span class="o">.</span><span class="n">sections</span><span class="o">=</span><span class="n">loop</span><span class="o">.</span><span class="n">get_sections</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">loop</span>
    
    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">loops</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">cbs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">sections</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_sections</span><span class="p">(</span><span class="n">loops</span><span class="o">=</span><span class="n">loops</span><span class="p">,</span><span class="n">cbs</span><span class="o">=</span><span class="n">cbs</span><span class="p">)</span>                     <span class="c1"># fastrl.skip_traceback</span>
            <span class="k">for</span> <span class="n">section</span> <span class="ow">in</span> <span class="n">sections</span><span class="p">:</span>                                            <span class="c1"># fastrl.skip_traceback</span>
                <span class="n">section</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>                                                   <span class="c1"># fastrl.skip_traceback</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">e</span><span class="o">.</span><span class="n">_show_loop_errors</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">verbose</span>
            <span class="k">raise</span>
            
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">root_loop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">loop</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">loop</span>
    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>  <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sections</span><span class="p">)</span>
    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>

    <span class="nd">@delegates</span><span class="p">(</span><span class="n">Section</span><span class="o">.</span><span class="n">show</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">show</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">n_tab</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">n_sections</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">include_sections</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">tab</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">root_loop</span><span class="o">.</span><span class="n">tab</span>
        <span class="n">kwargs</span><span class="o">=</span><span class="n">merge</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">n_sections</span><span class="o">=</span><span class="n">n_sections</span><span class="p">,</span><span class="n">include_sections</span><span class="o">=</span><span class="n">include_sections</span><span class="p">),</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">loop</span><span class="o">=</span><span class="n">n_tab</span><span class="o">*</span><span class="n">tab</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">n_sections</span><span class="p">:</span><span class="n">loop</span><span class="o">+=</span><span class="sa">f</span><span class="s1">&#39; </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="si">}</span><span class="s1"> sections&#39;</span>
        <span class="k">if</span> <span class="n">include_sections</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">section</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sections</span><span class="p">:</span> 
                <span class="n">loop</span><span class="o">+=</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">+</span><span class="p">(</span><span class="n">n_tab</span><span class="o">*</span><span class="n">tab</span><span class="p">)</span>
                <span class="n">loop</span><span class="o">+=</span><span class="n">section</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">n_tab</span><span class="o">=</span><span class="n">n_tab</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">loop</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">Outer</span><span class="p">(</span><span class="n">Loop</span><span class="p">):</span>
    <span class="nd">@event</span>
    <span class="k">def</span> <span class="nf">before_step</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="p">:</span>  <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;before_step&#39;</span><span class="p">)</span>
    <span class="nd">@event</span>
    <span class="k">def</span> <span class="nf">on_step</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>     <span class="p">:</span>  <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;on_step&#39;</span><span class="p">)</span>
    <span class="nd">@event</span>
    <span class="k">def</span> <span class="nf">after_step</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>  <span class="p">:</span>  <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;after_step&#39;</span><span class="p">)</span>
    <span class="nd">@event</span>
    <span class="k">def</span> <span class="nf">failed_step</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="p">:</span>  <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;failed_step&#39;</span><span class="p">)</span>
    <span class="nd">@event</span>
    <span class="k">def</span> <span class="nf">finally_step</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>  <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;finally_step&#39;</span><span class="p">)</span>
 
    <span class="nd">@event</span>
    <span class="k">def</span> <span class="nf">before_jump</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="p">:</span>  <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;before_jump&#39;</span><span class="p">)</span>
    <span class="nd">@event</span>
    <span class="k">def</span> <span class="nf">on_jump</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>     <span class="p">:</span>  <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;on_jump&#39;</span><span class="p">)</span>
    <span class="nd">@event</span>
    <span class="k">def</span> <span class="nf">after_jump</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>  <span class="p">:</span>  <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;after_jump&#39;</span><span class="p">)</span>
    <span class="nd">@event</span>
    <span class="k">def</span> <span class="nf">failed_jump</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="p">:</span>  <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;failed_jump&#39;</span><span class="p">)</span>
    <span class="nd">@event</span>
    <span class="k">def</span> <span class="nf">finally_jump</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>  <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;finally_jump&#39;</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">Inner</span><span class="p">(</span><span class="n">Loop</span><span class="p">):</span>
    <span class="n">call_on</span><span class="o">=</span><span class="n">L</span><span class="p">(</span><span class="n">Outer</span><span class="o">.</span><span class="n">on_step</span><span class="p">,</span><span class="n">Outer</span><span class="o">.</span><span class="n">after_step</span><span class="p">,</span><span class="n">Outer</span><span class="o">.</span><span class="n">finally_jump</span><span class="p">)</span>
    
    <span class="nd">@event</span>
    <span class="k">def</span> <span class="nf">before_iteration</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;before_iteration&#39;</span><span class="p">)</span>
    <span class="nd">@event</span>
    <span class="k">def</span> <span class="nf">on_iteration</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>     <span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;on_iteration&#39;</span><span class="p">)</span>
    <span class="nd">@event</span>
    <span class="k">def</span> <span class="nf">after_iteration</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>  <span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;after_iteration&#39;</span><span class="p">)</span>
    <span class="nd">@event</span>
    <span class="k">def</span> <span class="nf">failed_iteration</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;failed_iteration&#39;</span><span class="p">)</span>
    <span class="nd">@event</span>
    <span class="k">def</span> <span class="nf">finally_iteration</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;finally_iteration&#39;</span><span class="p">)</span>
    <span class="c1"># def run(self,loops=None,cbs=None):</span>
    <span class="c1">#     sections=self.get_sections(loops=loops,cbs=cbs)</span>
    <span class="c1">#     for section in sections:</span>
    <span class="c1">#         section.run()</span>
    
<span class="k">class</span> <span class="nc">FailingInner</span><span class="p">(</span><span class="n">Loop</span><span class="p">):</span>
    <span class="n">call_on</span><span class="o">=</span><span class="n">L</span><span class="p">(</span><span class="n">Inner</span><span class="o">.</span><span class="n">finally_iteration</span><span class="p">)</span>
    
    <span class="nd">@event</span>
    <span class="k">def</span> <span class="nf">on_force_fail</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>                    
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;on_force_fail&#39;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">Exception</span>
        
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">Outer</span><span class="p">()</span><span class="o">.</span><span class="n">get_sections</span><span class="p">(</span><span class="n">L</span><span class="p">(</span><span class="n">Inner</span><span class="p">(),</span><span class="n">FailingInner</span><span class="p">()))</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>[Section, Section]</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">CallbackException</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span><span class="k">pass</span>

<span class="k">class</span> <span class="nc">Callback</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="n">call_on</span><span class="p">,</span><span class="n">loop</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span>
    
    <span class="k">def</span> <span class="nf">show</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">n_tab</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">tab</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">loop</span><span class="o">.</span><span class="n">root_loop</span><span class="o">.</span><span class="n">tab</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">loop</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">tab</span><span class="o">*</span><span class="n">n_tab</span><span class="p">)</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">OuterCallback</span><span class="p">(</span><span class="n">Callback</span><span class="p">):</span>
    <span class="n">call_on</span><span class="o">=</span><span class="n">L</span><span class="p">(</span><span class="n">Outer</span><span class="o">.</span><span class="n">on_step</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">before_iteration</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">-&gt;</span><span class="nb">dict</span><span class="p">(</span><span class="n">this</span><span class="o">=</span><span class="nb">list</span><span class="p">,</span><span class="n">that</span><span class="o">=</span><span class="nb">str</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;   OuterCallback called lol&#39;</span><span class="p">)</span>

<span class="n">Outer</span><span class="p">()</span><span class="o">.</span><span class="n">get_sections</span><span class="p">(</span><span class="n">L</span><span class="p">(</span><span class="n">Inner</span><span class="p">(),</span><span class="n">FailingInner</span><span class="p">()),</span><span class="n">OuterCallback</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>[Section, Section]</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">Outer</span><span class="o">.</span><span class="n">from_sections</span><span class="p">(</span>
    <span class="n">loops</span><span class="o">=</span><span class="n">L</span><span class="p">(</span><span class="n">Inner</span><span class="p">(),</span><span class="n">FailingInner</span><span class="p">()),</span>
    <span class="n">cbs</span><span class="o">=</span><span class="n">OuterCallback</span>
                   
                   
<span class="p">)</span><span class="o">.</span><span class="n">show</span><span class="p">(</span>
    <span class="n">n_sections</span><span class="o">=</span>      <span class="kc">True</span><span class="p">,</span>
    <span class="n">include_sections</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">n_events</span><span class="o">=</span>        <span class="kc">True</span><span class="p">,</span>
    <span class="n">include_events</span><span class="o">=</span>  <span class="kc">True</span><span class="p">,</span>
    <span class="n">n_cbs</span><span class="o">=</span>           <span class="kc">True</span><span class="p">,</span>
    <span class="n">include_cbs</span><span class="o">=</span>     <span class="kc">True</span><span class="p">,</span>
    <span class="n">include_defaults</span><span class="o">=</span><span class="kc">True</span>
<span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Outer 2 sections
  Section 5 events
      __main__.Outer.before_step
      __main__.Outer.on_step
      Inner 1 sections
          Section 5 events
              __main__.Inner.before_iteration
              __main__.Inner.on_iteration
              __main__.Inner.after_iteration
              __main__.Inner.failed_iteration
              __main__.Inner.finally_iteration
              FailingInner 1 sections
                  Section 1 events
            &lt;function noop at 0x7f8cc8309ca0&gt;
                      __main__.FailingInner.on_force_fail
            &lt;function noop at 0x7f8cc8309ca0&gt;
            &lt;function _default_raise at 0x7f8cc83091f0&gt;
            &lt;function noop at 0x7f8cc8309ca0&gt;
      __main__.Outer.after_step
      Inner 1 sections
          Section 5 events
              __main__.Inner.before_iteration
              __main__.Inner.on_iteration
              __main__.Inner.after_iteration
              __main__.Inner.failed_iteration
              __main__.Inner.finally_iteration
              FailingInner 1 sections
                  Section 1 events
            &lt;function noop at 0x7f8cc8309ca0&gt;
                      __main__.FailingInner.on_force_fail
            &lt;function noop at 0x7f8cc8309ca0&gt;
            &lt;function _default_raise at 0x7f8cc83091f0&gt;
            &lt;function noop at 0x7f8cc8309ca0&gt;
      __main__.Outer.failed_step
      __main__.Outer.finally_step
  Section 5 events
      __main__.Outer.before_jump
      __main__.Outer.on_jump
      __main__.Outer.after_jump
      __main__.Outer.failed_jump
      __main__.Outer.finally_jump
      Inner 1 sections
          Section 5 events
              __main__.Inner.before_iteration
              __main__.Inner.on_iteration
              __main__.Inner.after_iteration
              __main__.Inner.failed_iteration
              __main__.Inner.finally_iteration
              FailingInner 1 sections
                  Section 1 events
            &lt;function noop at 0x7f8cc8309ca0&gt;
                      __main__.FailingInner.on_force_fail
            &lt;function noop at 0x7f8cc8309ca0&gt;
            &lt;function _default_raise at 0x7f8cc83091f0&gt;
            &lt;function noop at 0x7f8cc8309ca0&gt;
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><code>Reference: https://stackoverflow.com/questions/31949760/how-to-limit-python-traceback-to-specific-files</code></p>
<p><code>Reference: https://github.com/ipython/ipython/blob/8520f3063ca36655b5febbbd18bf55e59cb2cbb5/IPython/core/interactiveshell.py#L1945</code></p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">_skip_traceback</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">in_</span><span class="p">(</span><span class="s1">&#39;# fastrl.skip_traceback&#39;</span><span class="p">,</span><span class="n">s</span><span class="p">)</span>
    
<span class="k">def</span> <span class="nf">ipy_handle_exception</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">etype</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">tb</span><span class="p">,</span> <span class="n">tb_offset</span><span class="p">):</span>
    <span class="c1">## Do something fancy</span>
    <span class="n">stb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">InteractiveTB</span><span class="o">.</span><span class="n">structured_traceback</span><span class="p">(</span><span class="n">etype</span><span class="p">,</span><span class="n">value</span><span class="p">,</span><span class="n">tb</span><span class="p">,</span><span class="n">tb_offset</span><span class="o">=</span><span class="n">tb_offset</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">value</span><span class="p">,</span><span class="s1">&#39;_show_loop_errors&#39;</span><span class="p">,</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">tmp</span><span class="p">,</span><span class="n">idxs</span><span class="o">=</span><span class="p">[],</span><span class="n">L</span><span class="p">(</span><span class="n">stb</span><span class="p">)</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="n">_skip_traceback</span><span class="p">)</span>
        <span class="n">prev_skipped_idx</span><span class="o">=</span><span class="n">idxs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">idxs</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">s</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">stb</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">idxs</span> <span class="ow">and</span> <span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="o">!=</span><span class="n">prev_skipped_idx</span><span class="p">:</span> 
                <span class="n">msg</span><span class="o">=</span><span class="s1">&#39;Skipped Loop Code due to # fastrl.skip_traceback found in source code,&#39;</span>
                <span class="n">msg</span><span class="o">+=</span><span class="s1">&#39; please use Loop(...verbose=True) to view loop tracebacks</span><span class="se">\n</span><span class="s1">&#39;</span>
                <span class="n">tmp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">idxs</span><span class="p">:</span>
                <span class="n">tmp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">prev_skipped_idx</span><span class="o">=</span><span class="n">i</span>
        <span class="n">stb</span><span class="o">=</span><span class="n">tmp</span>
    <span class="c1">## Do something fancy</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_showtraceback</span><span class="p">(</span><span class="nb">type</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">stb</span><span class="p">)</span>

<span class="k">if</span> <span class="n">IN_IPYTHON</span><span class="p">:</span>
    <span class="n">get_ipython</span><span class="p">()</span><span class="o">.</span><span class="n">set_custom_exc</span><span class="p">((</span><span class="ne">Exception</span><span class="p">,),</span><span class="n">ipy_handle_exception</span><span class="p">)</span>
    
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">if</span> <span class="kc">False</span><span class="p">:</span>
    <span class="n">Outer</span><span class="o">.</span><span class="n">verbose</span><span class="o">=</span><span class="kc">False</span>
    <span class="n">Outer</span><span class="p">()</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">L</span><span class="p">(</span><span class="n">Inner</span><span class="p">(),</span><span class="n">FailingInner</span><span class="p">()),</span><span class="n">OuterCallback</span><span class="p">())</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>before_step
on_step
before_iteration
on_iteration
after_iteration
finally_iteration
on_force_fail
failed_step
finally_step
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_text output_error">
<pre>
<span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">Exception</span>                                 Traceback (most recent call last)
<span class="ansi-green-fg">/tmp/ipykernel_147/2396079472.py</span> in <span class="ansi-cyan-fg">&lt;module&gt;</span>
<span class="ansi-green-intense-fg ansi-bold">      1</span> <span class="ansi-green-fg">if</span> <span class="ansi-green-fg">True</span><span class="ansi-blue-fg">:</span>
<span class="ansi-green-intense-fg ansi-bold">      2</span>     Outer<span class="ansi-blue-fg">.</span>verbose<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">False</span>
<span class="ansi-green-fg">----&gt; 3</span><span class="ansi-red-fg">     </span>Outer<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">.</span>run<span class="ansi-blue-fg">(</span>L<span class="ansi-blue-fg">(</span>Inner<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">,</span>FailingInner<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">,</span>OuterCallback<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">)</span>

Skipped Loop Code due to # fastrl.skip_traceback, please use Loop(...verbose=True) to view loop tracebacks

<span class="ansi-green-fg">/tmp/ipykernel_147/3821596272.py</span> in <span class="ansi-cyan-fg">on_force_fail</span><span class="ansi-blue-fg">(self)</span>
<span class="ansi-green-intense-fg ansi-bold">     46</span>     <span class="ansi-green-fg">def</span> on_force_fail<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>
<span class="ansi-green-intense-fg ansi-bold">     47</span>         print<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">&#39;on_force_fail&#39;</span><span class="ansi-blue-fg">)</span>
<span class="ansi-green-fg">---&gt; 48</span><span class="ansi-red-fg">         </span><span class="ansi-green-fg">raise</span> Exception
<span class="ansi-green-intense-fg ansi-bold">     49</span> 

<span class="ansi-red-fg">Exception</span>: </pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">if</span> <span class="kc">False</span><span class="p">:</span>
    <span class="n">Outer</span><span class="o">.</span><span class="n">verbose</span><span class="o">=</span><span class="kc">True</span>
    <span class="n">Outer</span><span class="p">()</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">L</span><span class="p">(</span><span class="n">Inner</span><span class="p">(),</span><span class="n">FailingInner</span><span class="p">()),</span><span class="n">OuterCallback</span><span class="p">())</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>before_step
on_step
before_iteration
on_iteration
after_iteration
finally_iteration
on_force_fail
failed_step
finally_step
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_text output_error">
<pre>
<span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">Exception</span>                                 Traceback (most recent call last)
<span class="ansi-green-fg">/tmp/ipykernel_147/2545524841.py</span> in <span class="ansi-cyan-fg">&lt;module&gt;</span>
<span class="ansi-green-intense-fg ansi-bold">      1</span> <span class="ansi-green-fg">if</span> <span class="ansi-green-fg">True</span><span class="ansi-blue-fg">:</span>
<span class="ansi-green-intense-fg ansi-bold">      2</span>     Outer<span class="ansi-blue-fg">.</span>verbose<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">True</span>
<span class="ansi-green-fg">----&gt; 3</span><span class="ansi-red-fg">     </span>Outer<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">.</span>run<span class="ansi-blue-fg">(</span>L<span class="ansi-blue-fg">(</span>Inner<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">,</span>FailingInner<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">,</span>OuterCallback<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">)</span>

<span class="ansi-green-fg">/tmp/ipykernel_147/352176355.py</span> in <span class="ansi-cyan-fg">run</span><span class="ansi-blue-fg">(self, loops, cbs)</span>
<span class="ansi-green-intense-fg ansi-bold">     54</span>             sections<span class="ansi-blue-fg">=</span>self<span class="ansi-blue-fg">.</span>get_sections<span class="ansi-blue-fg">(</span>loops<span class="ansi-blue-fg">=</span>loops<span class="ansi-blue-fg">,</span>cbs<span class="ansi-blue-fg">=</span>cbs<span class="ansi-blue-fg">)</span>                     <span class="ansi-red-fg"># fastrl.skip_traceback</span>
<span class="ansi-green-intense-fg ansi-bold">     55</span>             <span class="ansi-green-fg">for</span> section <span class="ansi-green-fg">in</span> sections<span class="ansi-blue-fg">:</span>                                            <span class="ansi-red-fg"># fastrl.skip_traceback</span>
<span class="ansi-green-fg">---&gt; 56</span><span class="ansi-red-fg">                 </span>section<span class="ansi-blue-fg">.</span>run<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span>                                                   <span class="ansi-red-fg"># fastrl.skip_traceback</span>
<span class="ansi-green-intense-fg ansi-bold">     57</span>         <span class="ansi-green-fg">except</span> Exception <span class="ansi-green-fg">as</span> e<span class="ansi-blue-fg">:</span>
<span class="ansi-green-intense-fg ansi-bold">     58</span>             e<span class="ansi-blue-fg">.</span>_show_loop_errors<span class="ansi-blue-fg">=</span>self<span class="ansi-blue-fg">.</span>verbose

<span class="ansi-green-fg">/tmp/ipykernel_147/1544263056.py</span> in <span class="ansi-cyan-fg">run</span><span class="ansi-blue-fg">(self)</span>
<span class="ansi-green-intense-fg ansi-bold">     74</span>             <span class="ansi-green-fg">for</span> o <span class="ansi-green-fg">in</span> self<span class="ansi-blue-fg">.</span>events<span class="ansi-blue-fg">[</span><span class="ansi-blue-fg">&#39;before_inner&#39;</span><span class="ansi-blue-fg">]</span><span class="ansi-blue-fg">:</span> o<span class="ansi-blue-fg">.</span>run<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span>                       <span class="ansi-red-fg"># fastrl.skip_traceback</span>
<span class="ansi-green-intense-fg ansi-bold">     75</span>             self<span class="ansi-blue-fg">.</span>events<span class="ansi-blue-fg">[</span><span class="ansi-blue-fg">&#39;on_&#39;</span><span class="ansi-blue-fg">]</span><span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span>
<span class="ansi-green-fg">---&gt; 76</span><span class="ansi-red-fg">             </span><span class="ansi-green-fg">for</span> o <span class="ansi-green-fg">in</span> self<span class="ansi-blue-fg">.</span>events<span class="ansi-blue-fg">[</span><span class="ansi-blue-fg">&#39;on_inner&#39;</span><span class="ansi-blue-fg">]</span><span class="ansi-blue-fg">:</span> o<span class="ansi-blue-fg">.</span>run<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">     77</span>             self<span class="ansi-blue-fg">.</span>events<span class="ansi-blue-fg">[</span><span class="ansi-blue-fg">&#39;after_&#39;</span><span class="ansi-blue-fg">]</span><span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">     78</span>             <span class="ansi-green-fg">for</span> o <span class="ansi-green-fg">in</span> self<span class="ansi-blue-fg">.</span>events<span class="ansi-blue-fg">[</span><span class="ansi-blue-fg">&#39;after_inner&#39;</span><span class="ansi-blue-fg">]</span><span class="ansi-blue-fg">:</span> o<span class="ansi-blue-fg">.</span>run<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span>                        <span class="ansi-red-fg"># fastrl.skip_traceback</span>

<span class="ansi-green-fg">/tmp/ipykernel_147/352176355.py</span> in <span class="ansi-cyan-fg">run</span><span class="ansi-blue-fg">(self, loops, cbs)</span>
<span class="ansi-green-intense-fg ansi-bold">     54</span>             sections<span class="ansi-blue-fg">=</span>self<span class="ansi-blue-fg">.</span>get_sections<span class="ansi-blue-fg">(</span>loops<span class="ansi-blue-fg">=</span>loops<span class="ansi-blue-fg">,</span>cbs<span class="ansi-blue-fg">=</span>cbs<span class="ansi-blue-fg">)</span>                     <span class="ansi-red-fg"># fastrl.skip_traceback</span>
<span class="ansi-green-intense-fg ansi-bold">     55</span>             <span class="ansi-green-fg">for</span> section <span class="ansi-green-fg">in</span> sections<span class="ansi-blue-fg">:</span>                                            <span class="ansi-red-fg"># fastrl.skip_traceback</span>
<span class="ansi-green-fg">---&gt; 56</span><span class="ansi-red-fg">                 </span>section<span class="ansi-blue-fg">.</span>run<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span>                                                   <span class="ansi-red-fg"># fastrl.skip_traceback</span>
<span class="ansi-green-intense-fg ansi-bold">     57</span>         <span class="ansi-green-fg">except</span> Exception <span class="ansi-green-fg">as</span> e<span class="ansi-blue-fg">:</span>
<span class="ansi-green-intense-fg ansi-bold">     58</span>             e<span class="ansi-blue-fg">.</span>_show_loop_errors<span class="ansi-blue-fg">=</span>self<span class="ansi-blue-fg">.</span>verbose

<span class="ansi-green-fg">/tmp/ipykernel_147/1544263056.py</span> in <span class="ansi-cyan-fg">run</span><span class="ansi-blue-fg">(self)</span>
<span class="ansi-green-intense-fg ansi-bold">     85</span>         <span class="ansi-green-fg">finally</span><span class="ansi-blue-fg">:</span>
<span class="ansi-green-intense-fg ansi-bold">     86</span>             self<span class="ansi-blue-fg">.</span>events<span class="ansi-blue-fg">[</span><span class="ansi-blue-fg">&#39;finally_&#39;</span><span class="ansi-blue-fg">]</span><span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span>
<span class="ansi-green-fg">---&gt; 87</span><span class="ansi-red-fg">             </span><span class="ansi-green-fg">for</span> o <span class="ansi-green-fg">in</span> self<span class="ansi-blue-fg">.</span>events<span class="ansi-blue-fg">[</span><span class="ansi-blue-fg">&#39;finally_inner&#39;</span><span class="ansi-blue-fg">]</span><span class="ansi-blue-fg">:</span> o<span class="ansi-blue-fg">.</span>run<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span>                      <span class="ansi-red-fg"># fastrl.skip_traceback</span>
<span class="ansi-green-intense-fg ansi-bold">     88</span> 
<span class="ansi-green-intense-fg ansi-bold">     89</span>     <span class="ansi-blue-fg">@</span>classmethod

<span class="ansi-green-fg">/tmp/ipykernel_147/352176355.py</span> in <span class="ansi-cyan-fg">run</span><span class="ansi-blue-fg">(self, loops, cbs)</span>
<span class="ansi-green-intense-fg ansi-bold">     54</span>             sections<span class="ansi-blue-fg">=</span>self<span class="ansi-blue-fg">.</span>get_sections<span class="ansi-blue-fg">(</span>loops<span class="ansi-blue-fg">=</span>loops<span class="ansi-blue-fg">,</span>cbs<span class="ansi-blue-fg">=</span>cbs<span class="ansi-blue-fg">)</span>                     <span class="ansi-red-fg"># fastrl.skip_traceback</span>
<span class="ansi-green-intense-fg ansi-bold">     55</span>             <span class="ansi-green-fg">for</span> section <span class="ansi-green-fg">in</span> sections<span class="ansi-blue-fg">:</span>                                            <span class="ansi-red-fg"># fastrl.skip_traceback</span>
<span class="ansi-green-fg">---&gt; 56</span><span class="ansi-red-fg">                 </span>section<span class="ansi-blue-fg">.</span>run<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span>                                                   <span class="ansi-red-fg"># fastrl.skip_traceback</span>
<span class="ansi-green-intense-fg ansi-bold">     57</span>         <span class="ansi-green-fg">except</span> Exception <span class="ansi-green-fg">as</span> e<span class="ansi-blue-fg">:</span>
<span class="ansi-green-intense-fg ansi-bold">     58</span>             e<span class="ansi-blue-fg">.</span>_show_loop_errors<span class="ansi-blue-fg">=</span>self<span class="ansi-blue-fg">.</span>verbose

<span class="ansi-green-fg">/tmp/ipykernel_147/1544263056.py</span> in <span class="ansi-cyan-fg">run</span><span class="ansi-blue-fg">(self)</span>
<span class="ansi-green-intense-fg ansi-bold">     79</span>         <span class="ansi-green-fg">except</span> Exception <span class="ansi-green-fg">as</span> ex<span class="ansi-blue-fg">:</span>
<span class="ansi-green-intense-fg ansi-bold">     80</span>             <span class="ansi-green-fg">try</span><span class="ansi-blue-fg">:</span>
<span class="ansi-green-fg">---&gt; 81</span><span class="ansi-red-fg">                 </span>self<span class="ansi-blue-fg">.</span>events<span class="ansi-blue-fg">[</span><span class="ansi-blue-fg">&#39;failed_&#39;</span><span class="ansi-blue-fg">]</span><span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span>                                        <span class="ansi-red-fg"># fastrl.skip_traceback</span>
<span class="ansi-green-intense-fg ansi-bold">     82</span>                 <span class="ansi-green-fg">raise</span>
<span class="ansi-green-intense-fg ansi-bold">     83</span>             <span class="ansi-green-fg">finally</span><span class="ansi-blue-fg">:</span>

<span class="ansi-green-fg">/tmp/ipykernel_147/1544263056.py</span> in <span class="ansi-cyan-fg">run</span><span class="ansi-blue-fg">(self)</span>
<span class="ansi-green-intense-fg ansi-bold">     73</span>             self<span class="ansi-blue-fg">.</span>events<span class="ansi-blue-fg">[</span><span class="ansi-blue-fg">&#39;before_&#39;</span><span class="ansi-blue-fg">]</span><span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">     74</span>             <span class="ansi-green-fg">for</span> o <span class="ansi-green-fg">in</span> self<span class="ansi-blue-fg">.</span>events<span class="ansi-blue-fg">[</span><span class="ansi-blue-fg">&#39;before_inner&#39;</span><span class="ansi-blue-fg">]</span><span class="ansi-blue-fg">:</span> o<span class="ansi-blue-fg">.</span>run<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span>                       <span class="ansi-red-fg"># fastrl.skip_traceback</span>
<span class="ansi-green-fg">---&gt; 75</span><span class="ansi-red-fg">             </span>self<span class="ansi-blue-fg">.</span>events<span class="ansi-blue-fg">[</span><span class="ansi-blue-fg">&#39;on_&#39;</span><span class="ansi-blue-fg">]</span><span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">     76</span>             <span class="ansi-green-fg">for</span> o <span class="ansi-green-fg">in</span> self<span class="ansi-blue-fg">.</span>events<span class="ansi-blue-fg">[</span><span class="ansi-blue-fg">&#39;on_inner&#39;</span><span class="ansi-blue-fg">]</span><span class="ansi-blue-fg">:</span> o<span class="ansi-blue-fg">.</span>run<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">     77</span>             self<span class="ansi-blue-fg">.</span>events<span class="ansi-blue-fg">[</span><span class="ansi-blue-fg">&#39;after_&#39;</span><span class="ansi-blue-fg">]</span><span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span>

<span class="ansi-green-fg">/tmp/ipykernel_147/626771263.py</span> in <span class="ansi-cyan-fg">__call__</span><span class="ansi-blue-fg">(self, *args, **kwargs)</span>
<span class="ansi-green-intense-fg ansi-bold">     47</span>     <span class="ansi-green-fg">def</span> root_loop<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span> <span class="ansi-green-fg">return</span> self<span class="ansi-blue-fg">.</span>loop<span class="ansi-blue-fg">.</span>root_loop
<span class="ansi-green-intense-fg ansi-bold">     48</span>     <span class="ansi-green-fg">def</span> __call__<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">,</span><span class="ansi-blue-fg">*</span>args<span class="ansi-blue-fg">,</span><span class="ansi-blue-fg">**</span>kwargs<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>
<span class="ansi-green-fg">---&gt; 49</span><span class="ansi-red-fg">         </span>ret<span class="ansi-blue-fg">=</span>self<span class="ansi-blue-fg">.</span>function<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">.</span>loop<span class="ansi-blue-fg">,</span><span class="ansi-blue-fg">*</span>args<span class="ansi-blue-fg">,</span><span class="ansi-blue-fg">**</span>kwargs<span class="ansi-blue-fg">)</span>                             <span class="ansi-red-fg"># fastrl.skip_traceback</span>
<span class="ansi-green-intense-fg ansi-bold">     50</span>         <span class="ansi-green-fg">for</span> cb <span class="ansi-green-fg">in</span> self<span class="ansi-blue-fg">.</span>cbs<span class="ansi-blue-fg">:</span> cb_ret<span class="ansi-blue-fg">=</span>getattr<span class="ansi-blue-fg">(</span>cb<span class="ansi-blue-fg">,</span>self<span class="ansi-blue-fg">.</span>name<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">     51</span>         <span class="ansi-green-fg">return</span> ret

<span class="ansi-green-fg">/tmp/ipykernel_147/3821596272.py</span> in <span class="ansi-cyan-fg">on_force_fail</span><span class="ansi-blue-fg">(self)</span>
<span class="ansi-green-intense-fg ansi-bold">     46</span>     <span class="ansi-green-fg">def</span> on_force_fail<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>
<span class="ansi-green-intense-fg ansi-bold">     47</span>         print<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">&#39;on_force_fail&#39;</span><span class="ansi-blue-fg">)</span>
<span class="ansi-green-fg">---&gt; 48</span><span class="ansi-red-fg">         </span><span class="ansi-green-fg">raise</span> Exception
<span class="ansi-green-intense-fg ansi-bold">     49</span> 

<span class="ansi-red-fg">Exception</span>: </pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># # Reference: https://stackoverflow.com/questions/31949760/how-to-limit-python-traceback-to-specific-files</span>
<span class="c1"># # __mycode = True</span>

<span class="c1"># # def is_mycode(tb):</span>
<span class="c1"># #     globals = tb.tb_frame.f_globals</span>
<span class="c1"># #     return globals.has_key(&#39;__mycode&#39;)</span>

<span class="c1"># # def mycode_traceback_levels(tb):</span>
<span class="c1"># #     length = 0</span>
<span class="c1"># #     while tb and is_mycode(tb):</span>
<span class="c1"># #         tb = tb.tb_next</span>
<span class="c1"># #         length += 1</span>
<span class="c1"># #     return length</span>
<span class="c1"># import traceback</span>
<span class="c1"># from traceback import TracebackException</span>
<span class="c1"># __mycode = True</span>

<span class="c1"># def callers_module():</span>
<span class="c1">#     module_name = inspect.currentframe().f_back.f_globals[&quot;__name__&quot;]</span>
<span class="c1">#     return sys.modules[module_name]</span>

<span class="c1"># def is_mycode(tb):</span>
<span class="c1">#     return globals().get(&#39;__mycode&#39;,False)</span>

<span class="c1"># def mycode_traceback_levels(tb):</span>
<span class="c1">#     length = 0</span>
<span class="c1">#     while tb and is_mycode(tb):</span>
<span class="c1">#         tb = tb.tb_next</span>
<span class="c1">#         length += 1</span>
<span class="c1">#     return length</span>

<span class="c1"># def handle_exception(type, value, tb, tb_offset):</span>
<span class="c1">#     # 1. skip custom assert code, e.g.</span>
<span class="c1">#     # while tb and is_custom_assert_code(tb):</span>
<span class="c1">#     #   tb = tb.tb_next</span>
<span class="c1">#     # 2. only display your code</span>
<span class="c1">#     length = mycode_traceback_levels(tb)</span>
    
<span class="c1">#     # Reference: https://github.com/ipython/ipython/blob/8520f3063ca36655b5febbbd18bf55e59cb2cbb5/IPython/core/interactiveshell.py#L1945</span>

<span class="c1">#     # return [str(line) for line in TracebackException(</span>
<span class="c1">#     #         type, value, tb, limit=length).format(chain=True)]</span>
<span class="c1">#     return TracebackException(</span>
<span class="c1">#             type, value, tb, limit=length).format(chain=True)</span>


<span class="c1"># def ipy_handle_exception(self, etype, value, tb, tb_offset):</span>
<span class="c1">#     # 1. skip custom assert code, e.g.</span>
<span class="c1">#     # while tb and is_custom_assert_code(tb):</span>
<span class="c1">#     #   tb = tb.tb_next</span>
<span class="c1">#     # 2. only display your code</span>
<span class="c1">#     # length = mycode_traceback_levels(tb)</span>
    
<span class="c1">#     # Reference: https://github.com/ipython/ipython/blob/8520f3063ca36655b5febbbd18bf55e59cb2cbb5/IPython/core/interactiveshell.py#L1945</span>

<span class="c1">#     # return [str(line) for line in TracebackException(</span>
<span class="c1">#     #         type, value, tb, limit=length).format(chain=True)]</span>
<span class="c1">#     print(&#39;Returning traceback&#39;)</span>
<span class="c1"># #     ss= [str(line) for line in TracebackException(</span>
<span class="c1"># #             type, value, tb, limit=None).format(chain=True)]</span>
    
<span class="c1">#     stb = self.InteractiveTB.structured_traceback(etype,</span>
<span class="c1">#                                             value, tb, tb_offset=tb_offset)</span>
    
<span class="c1">#     # print(stb)</span>
<span class="c1">#     self._showtraceback(type, value, stb)</span>
    
<span class="c1">#     # print(ss)</span>
<span class="c1">#     # return ss</span>
<span class="c1"># get_ipython().set_custom_exc((Exception,),ipy_handle_exception)</span>
    
<span class="c1"># # sys.excepthook = handle_exception</span>

<span class="c1"># def custom_traceback():</span>
<span class="c1">#     exception_info=sys.exc_info()</span>
<span class="c1">#     # print(exception_info)</span>
<span class="c1">#     ex=handle_exception(*exception_info)</span>
<span class="c1">#     # get_ipython()</span>
    
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

</div>
 

