---

title: Data Block Simple


keywords: fastai
sidebar: home_sidebar

summary: "Stripped down simpler environment execution code."
description: "Stripped down simpler environment execution code."
nb_path: "nbs/05a_data.block.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: nbs/05a_data.block.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">pybulletgym</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Development of this was helped by <a href="https://github.com/pytorch/pytorch/blob/4949eea0ffb60dc81a0a78402fa59fdf68206718/torch/utils/data/dataset.py#L64">IterableData documentation on multiple workers</a></p>
<p>This code is heavily modifed from <a href="https://github.com/Shmuma/ptan">https://github.com/Shmuma/ptan</a></p>
<p>Reference for env <a href="https://github.com/openai/universe/blob/master/doc/env_semantics.rst">semantics related to vectorized environments</a></p>
<p>Useful links:</p>
<ul>
<li><a href="https://github.com/pytorch/pytorch/blob/a61a8d059efa0fb139a09e479b1a2c8dd1cf1a44/torch/utils/data/dataloader.py#L564">torch multiprocessing</a></li>
<li><a href="https://github.com/pytorch/pytorch/blob/master/torch/utils/data/_utils/worker.py">torch worker</a></li>
</ul>
<p>This notebook walks through a more advanced usage of the <a href="/fastrl/callback.core.html#Loop"><code>Loop</code></a> class.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="parse_events" class="doc_header"><code>parse_events</code><a href="https://github.com/josiahls/fastrl/tree/master/fastrl/data/block.py#L30" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>parse_events</code>(<strong><code>loop</code></strong>:<code>L</code>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">parse_events</span><span class="p">(</span><span class="n">loop</span><span class="p">:</span><span class="n">L</span><span class="p">):</span> 
    <span class="k">return</span> <span class="n">loop</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">s</span><span class="p">:</span><span class="n">in_</span><span class="p">(</span><span class="s1">&#39;event.&#39;</span><span class="p">,</span><span class="n">s</span><span class="p">))</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">s</span><span class="p">:</span><span class="n">s</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;event.&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Source">Source<a class="anchor-link" href="#Source"> </a></h2><blockquote><p>The base iterable used for iterating through environments.</p>
</blockquote>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">_loop</span><span class="o">=</span><span class="n">L</span><span class="p">([</span><span class="s1">&#39;event.after_create&#39;</span><span class="p">,</span><span class="s1">&#39;Start Setup&#39;</span><span class="p">,</span><span class="s1">&#39;event.initialize&#39;</span><span class="p">,</span><span class="s1">&#39;End Setup&#39;</span><span class="p">,</span>
             <span class="s1">&#39;event.before_episodes&#39;</span><span class="p">,</span>
             <span class="s1">&#39;Start Episodes&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;event.reset&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;event.do_action&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;event.do_step&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;event.render&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;event.history&#39;</span><span class="p">,</span>
             <span class="s1">&#39;End Episodes&#39;</span><span class="p">,</span>
             <span class="s1">&#39;event.after_episodes&#39;</span>
             <span class="p">])</span>

<span class="n">mk_class</span><span class="p">(</span><span class="s1">&#39;source_events&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">parse_events</span><span class="p">(</span><span class="n">_loop</span><span class="p">)</span><span class="o">.</span><span class="n">map_dict</span><span class="p">(),</span>
         <span class="n">doc</span><span class="o">=</span><span class="s2">&quot;All possible events as attributes to get tab-completion and typo-proofing&quot;</span><span class="p">)</span>

<span class="n">_all_</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;source_events&#39;</span><span class="p">]</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="Source" class="doc_header"><code>class</code> <code>Source</code><a href="https://github.com/josiahls/fastrl/tree/master/fastrl/data/block.py#L52" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>Source</code>(<strong><code>cbs</code></strong>=<em><code>None</code></em>) :: <a href="/fastrl/callback.core.html#Loop"><code>Loop</code></a></p>
</blockquote>
<p>Inherit from this to have all attr accesses in <code>self._xtra</code> passed down to <code>self.default</code></p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">Source</span><span class="p">(</span><span class="n">Loop</span><span class="p">):</span>
    <span class="n">_loop</span><span class="o">=</span><span class="n">_loop</span>
    <span class="n">_events</span><span class="o">=</span><span class="n">source_events</span>
    <span class="n">_default</span><span class="o">=</span><span class="s1">&#39;source&#39;</span>    
    <span class="n">end_event</span><span class="o">=</span><span class="n">parse_events</span><span class="p">(</span><span class="n">_loop</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    
    <span class="nd">@delegates</span><span class="p">(</span><span class="n">Loop</span><span class="p">)</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">cbs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">cbs</span><span class="o">=</span><span class="n">cbs</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">store_attr</span><span class="p">(</span><span class="n">but</span><span class="o">=</span><span class="s1">&#39;cbs&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">idx</span><span class="o">=</span><span class="mi">0</span>
        
    <span class="k">def</span> <span class="nf">after_create</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">(</span><span class="s1">&#39;initialize&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>
        
    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">idx</span><span class="o">+=</span><span class="mi">1</span>
            <span class="bp">self</span><span class="p">(</span><span class="s1">&#39;do_step&#39;</span><span class="p">)</span>
            <span class="k">yield</span> <span class="p">{</span><span class="s1">&#39;this&#39;</span><span class="p">:</span><span class="n">torch</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="mi">5</span><span class="p">),</span><span class="bp">self</span><span class="o">.</span><span class="n">idx</span><span class="p">)}</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>So the <a href="/fastrl/data.gym.html#Source"><code>Source</code></a> object does a simple loop that returns a dictionary. 
This is going to be similar to what the rest of fastrl will be expecting.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">source</span><span class="o">=</span><span class="n">Source</span><span class="p">()</span>
<span class="k">for</span> <span class="n">x</span><span class="p">,</span><span class="n">_</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">source</span><span class="p">),</span><span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">)):</span> <span class="nb">print</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>{&#39;this&#39;: tensor([[1, 1, 1, 1, 1]])}
{&#39;this&#39;: tensor([[2, 2, 2, 2, 2]])}
{&#39;this&#39;: tensor([[3, 3, 3, 3, 3]])}
{&#39;this&#39;: tensor([[4, 4, 4, 4, 4]])}
{&#39;this&#39;: tensor([[5, 5, 5, 5, 5]])}
{&#39;this&#39;: tensor([[6, 6, 6, 6, 6]])}
{&#39;this&#39;: tensor([[7, 7, 7, 7, 7]])}
{&#39;this&#39;: tensor([[8, 8, 8, 8, 8]])}
{&#39;this&#39;: tensor([[9, 9, 9, 9, 9]])}
{&#39;this&#39;: tensor([[10, 10, 10, 10, 10]])}
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">Source</span><span class="p">()</span><span class="o">.</span><span class="n">show_loop</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre> - after_create   : []
Start Setup
   - initialize     : []
End Setup
 - before_episodes: []
Start Episodes
   - reset          : []
   - do_action      : []
   - do_step        : []
   - render         : []
   - history        : []
End Episodes
 - after_episodes : []
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Base-PyTorch">Base PyTorch<a class="anchor-link" href="#Base-PyTorch"> </a></h2><p>This section covers the basic dataloader in pytorch with the source object.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">torch.utils.data</span> <span class="kn">import</span> <span class="n">DataLoader</span>
<span class="n">source</span><span class="o">=</span><span class="n">Source</span><span class="p">()</span>
<span class="k">try</span><span class="p">:</span>                   <span class="nb">print</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">DataLoader</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">source</span><span class="p">),</span><span class="n">batch_size</span><span class="o">=</span><span class="mi">10</span><span class="p">)))</span>
<span class="k">except</span> <span class="ne">TypeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>object of type &#39;generator&#39; has no len()
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Ok so the initial attempt failed. This is because we need to indicate this is an iterable dataset
that contains <code>items</code> that are each the <a href="/fastrl/data.gym.html#Source"><code>Source</code></a> instance. Ok so lets make this an 
iterable dataset.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="SourceDataset" class="doc_header"><code>class</code> <code>SourceDataset</code><a href="https://github.com/josiahls/fastrl/tree/master/fastrl/data/block.py#L75" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>SourceDataset</code>(<strong>*<code>args</code></strong>, <strong>**<code>kwds</code></strong>) :: <code>IterableDataset</code></p>
</blockquote>
<p>Iterates through a <code>source</code> object. Allows for re-initing source connections when <code>num_workers&gt;0</code></p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">SourceDataset</span><span class="p">(</span><span class="n">IterableDataset</span><span class="p">):</span>
    <span class="s2">&quot;Iterates through a `source` object. Allows for re-initing source connections when `num_workers&gt;0`&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">source</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="o">=</span><span class="n">source</span>
    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>             
        <span class="n">source</span><span class="o">=</span><span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">)</span>
        <span class="k">yield from</span> <span class="n">source</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="VerboseChecked" class="doc_header"><code>class</code> <code>VerboseChecked</code><a href="https://github.com/josiahls/fastrl/tree/master/fastrl/data/block.py#L83" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>VerboseChecked</code>(<strong><code>show_worker_id</code></strong>=<em><code>True</code></em>, <strong><code>show_env_id</code></strong>=<em><code>True</code></em>) :: <a href="/fastrl/callback.core.html#LoopCallback"><code>LoopCallback</code></a></p>
</blockquote>
<p>Basic class handling tweaks of a callback loop by changing a <code>obj</code> in various events</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">torch.utils.data</span> <span class="kn">import</span> <span class="n">DataLoader</span><span class="p">,</span><span class="n">IterableDataset</span>
<span class="n">source</span><span class="o">=</span><span class="n">Source</span><span class="p">(</span><span class="n">cbs</span><span class="o">=</span><span class="n">VerboseChecked</span><span class="p">)</span>
<span class="n">source</span><span class="o">.</span><span class="n">after_create</span><span class="p">()</span>
<span class="n">dataset</span><span class="o">=</span><span class="n">SourceDataset</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
<span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span><span class="n">batch_size</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">))</span>
    <span class="k">break</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Worker id:  0
WalkerBase::__init__
Env Id:  140515425373968
Env Id:  140515425373968
Env Id:  140515425373968
{&#39;this&#39;:tensor([[[1,1,1,1,1]],[[2,2,2,2,2]],[[3,3,3,3,3]]])}
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>pybullet build time: Sep  3 2021 23:58:23
/home/fastrl_user/.local/lib/python3.8/site-packages/gym/logger.py:34: UserWarning: <span class="ansi-yellow-fg">WARN: Box bound precision lowered by casting to float32</span>
  warnings.warn(colorize(&#34;%s: %s&#34; % (&#34;WARN&#34;, msg % args), &#34;yellow&#34;))
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">source</span><span class="o">=</span><span class="n">Source</span><span class="p">(</span><span class="n">cbs</span><span class="o">=</span><span class="n">VerboseChecked</span><span class="p">)</span>
<span class="n">source</span><span class="o">.</span><span class="n">after_create</span><span class="p">()</span>
<span class="n">dataset</span><span class="o">=</span><span class="n">SourceDataset</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
<span class="k">for</span> <span class="n">x</span><span class="p">,</span><span class="n">i</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">DataLoader</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span><span class="n">batch_size</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">num_workers</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span><span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">)):</span>
    <span class="nb">print</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Worker id:  0
WalkerBase::__init__
Env Id:  140515211069328
Env Id:  140515211069328
{&#39;this&#39;:tensor([[[1,1,1,1,1]],[[2,2,2,2,2]]])}
Env Id:  140515211069328
Env Id:  140515211069328
{&#39;this&#39;:tensor([[[3,3,3,3,3]],[[4,4,4,4,4]]])}
Env Id:  140515211069328
Env Id:  140515211069328
{&#39;this&#39;:tensor([[[5,5,5,5,5]],[[6,6,6,6,6]]])}
Env Id:  140515211069328
Env Id:  140515211069328
{&#39;this&#39;:tensor([[[7,7,7,7,7]],[[8,8,8,8,8]]])}
Env Id:  140515211069328
Env Id:  140515211069328
{&#39;this&#39;:tensor([[[9,9,9,9,9]],[[10,10,10,10,10]]])}
Env Id:  140515211069328
Env Id:  140515211069328
{&#39;this&#39;:tensor([[[11,11,11,11,11]],[[12,12,12,12,12]]])}
Env Id:  140515211069328
Env Id:  140515211069328
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Fastai-Compatibility">Fastai Compatibility<a class="anchor-link" href="#Fastai-Compatibility"> </a></h2><p>Now lets get this working with the fastai API!</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">fastai.data.all</span> <span class="kn">import</span> <span class="o">*</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="TfmdList-Compatability">TfmdList Compatability<a class="anchor-link" href="#TfmdList-Compatability"> </a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>{% include note.html content='First issue we run into: It would be nice to leverage the transform API and the TfmdLists' %}        would be great in case we want to execute transforms on the returned items. In this case,
        we want to forgo the <a href="/fastrl/data.block.html#SourceDataset"><code>SourceDataset</code></a> since we want to use the <code>TfmdList</code>s instead.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>{% include note.html content='Additional note, I wonder what the real difference is between a <code>TfmdList</code> and a <code>Dataset</code>?' %}</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">source</span><span class="o">=</span><span class="n">Source</span><span class="p">(</span><span class="n">cbs</span><span class="o">=</span><span class="n">VerboseChecked</span><span class="p">)</span>
<span class="c1"># dataset=SourceDataset(source)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>So from the looks of the config below, this should be fine right? We have an iterable dataset,
so we indicate that it is not indexed, and that shuffling wouldn't make sense.</p>
<p>There is some strange things we need to do to actually make this work with defaults. We need to do <code>type_tfms</code> 
on the items since they need to be iterables. We then need to do <code>item_tfms</code> to tell fastai that it is supposed
to try to iterate through these are opposed to simply "pushing" them through the tfm pipeline.</p>
<p>Let's see if this works!</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">try</span><span class="p">:</span>
    <span class="n">dls</span><span class="o">=</span><span class="n">DataBlock</span><span class="p">(</span>
        <span class="n">blocks</span><span class="o">=</span><span class="n">TransformBlock</span><span class="p">(</span>
            <span class="n">dls_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;indexed&#39;</span><span class="p">:</span><span class="kc">False</span><span class="p">,</span><span class="s1">&#39;shuffle&#39;</span><span class="p">:</span><span class="kc">False</span><span class="p">}),</span>
    <span class="p">)</span><span class="o">.</span><span class="n">dataloaders</span><span class="p">([</span><span class="n">source</span><span class="p">],</span><span class="n">n</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span><span class="n">bs</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">num_workers</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">dls</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="nb">print</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">TypeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Collecting items from [&lt;__main__.Source object at 0x7fcc3f3ddf70&gt;]
Found 1 items
2 datasets of sizes 1,0
Setting up Pipeline: 
Setting up after_item: Pipeline: ToTensor
Setting up before_batch: Pipeline: 
Setting up after_batch: Pipeline: 
Could not do one pass in your dataloader, there is something wrong in it
default_collate: batch must contain tensors, numpy arrays, numbers, dicts or lists; found &lt;class &#39;__main__.Source&#39;&gt;
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Oops! Seems like instead of iterating through the item, it is just passing the item into the collation mechanism. 
Let's manually make the items iterable!</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">try</span><span class="p">:</span>
    <span class="n">dls</span><span class="o">=</span><span class="n">DataBlock</span><span class="p">(</span>
        <span class="n">blocks</span><span class="o">=</span><span class="n">TransformBlock</span><span class="p">(</span>
            <span class="n">type_tfms</span><span class="o">=</span><span class="p">[</span><span class="k">lambda</span> <span class="n">o</span><span class="p">:</span> <span class="n">o</span><span class="o">.</span><span class="n">after_create</span><span class="p">(),</span><span class="k">lambda</span> <span class="n">o</span><span class="p">:</span><span class="nb">iter</span><span class="p">(</span><span class="n">o</span><span class="p">)],</span>
            <span class="n">dls_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;indexed&#39;</span><span class="p">:</span><span class="kc">False</span><span class="p">,</span><span class="s1">&#39;shuffle&#39;</span><span class="p">:</span><span class="kc">False</span><span class="p">}),</span>
    <span class="p">)</span><span class="o">.</span><span class="n">dataloaders</span><span class="p">([</span><span class="n">source</span><span class="p">],</span><span class="n">n</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span><span class="n">bs</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">num_workers</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">dls</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="nb">print</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">TypeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span><span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Collecting items from [&lt;__main__.Source object at 0x7fcc3f3ddf70&gt;]
Found 1 items
2 datasets of sizes 1,0
Setting up Pipeline: &lt;lambda&gt; -&gt; &lt;lambda&gt;
Worker id:  0
WalkerBase::__init__
Setting up after_item: Pipeline: ToTensor
Setting up before_batch: Pipeline: 
Setting up after_batch: Pipeline: 
Could not do one pass in your dataloader, there is something wrong in it
Worker id:  0
WalkerBase::__init__
default_collate: batch must contain tensors, numpy arrays, numbers, dicts or lists; found &lt;class &#39;generator&#39;&gt;
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Ok,ok lets also tell it to pull items out of the generator...</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">dls</span><span class="o">=</span><span class="n">DataBlock</span><span class="p">(</span>
    <span class="n">blocks</span><span class="o">=</span><span class="n">TransformBlock</span><span class="p">(</span>
        <span class="n">type_tfms</span><span class="o">=</span><span class="p">[</span><span class="k">lambda</span> <span class="n">o</span><span class="p">:</span> <span class="n">o</span><span class="o">.</span><span class="n">after_create</span><span class="p">(),</span><span class="k">lambda</span> <span class="n">o</span><span class="p">:</span><span class="nb">iter</span><span class="p">(</span><span class="n">o</span><span class="p">)],</span>
        <span class="n">item_tfms</span><span class="o">=</span><span class="k">lambda</span> <span class="n">o</span><span class="p">:</span><span class="nb">next</span><span class="p">(</span><span class="n">o</span><span class="p">),</span>
        <span class="n">dls_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;indexed&#39;</span><span class="p">:</span><span class="kc">False</span><span class="p">,</span><span class="s1">&#39;shuffle&#39;</span><span class="p">:</span><span class="kc">False</span><span class="p">}),</span>
<span class="p">)</span><span class="o">.</span><span class="n">dataloaders</span><span class="p">([</span><span class="n">source</span><span class="p">],</span><span class="n">n</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span><span class="n">bs</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">num_workers</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">dls</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="nb">print</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Collecting items from [&lt;__main__.Source object at 0x7fcc3f3ddf70&gt;]
Found 1 items
2 datasets of sizes 1,0
Setting up Pipeline: &lt;lambda&gt; -&gt; &lt;lambda&gt;
Worker id:  0
WalkerBase::__init__
Setting up after_item: Pipeline: &lt;lambda&gt; -&gt; ToTensor
Setting up before_batch: Pipeline: 
Setting up after_batch: Pipeline: 
Could not do one pass in your dataloader, there is something wrong in it
Worker id:  0
WalkerBase::__init__
Env Id:  140515425339424
({&#39;this&#39;: tensor([[[1, 1, 1, 1, 1]]], device=&#39;cuda:0&#39;)},)
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Huh... It only loops once since there is only 1 "item" in the list. This is not desirable behavior since this is 
an iterable. The number of loops should be able to be arbitrarily defined via <code>n</code> and <code>bs</code> especially if the items
don't have a length to them. There are a couple additional worries that I have:</p>
<ul>
<li>We may not want to call <code>iter</code> of the items until they are loaded onto a worker/passed to a process. This is due to 
many/all iterable sources not being picklable. The <code>type_tfms</code> might do this too early. </li>
<li>Why do we need to define the <code>item_tfms</code> above in the first place? the dataloader should understand that the 
item is iterable to just pull from it?</li>
</ul>
<p>You might wonder why we can't just pass a source directly into the <code>DataBlock</code>, however anything passed needs to have a len...</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">try</span><span class="p">:</span>
    <span class="n">dls</span><span class="o">=</span><span class="n">DataBlock</span><span class="p">(</span>
            <span class="n">blocks</span><span class="o">=</span><span class="n">TransformBlock</span><span class="p">(</span>
            <span class="n">type_tfms</span><span class="o">=</span><span class="p">[</span><span class="k">lambda</span> <span class="n">o</span><span class="p">:</span> <span class="n">o</span><span class="o">.</span><span class="n">after_create</span><span class="p">(),</span><span class="k">lambda</span> <span class="n">o</span><span class="p">:</span><span class="nb">iter</span><span class="p">(</span><span class="n">o</span><span class="p">)],</span>
            <span class="n">item_tfms</span><span class="o">=</span><span class="k">lambda</span> <span class="n">o</span><span class="p">:</span><span class="nb">next</span><span class="p">(</span><span class="n">o</span><span class="p">),</span>
            <span class="n">dls_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;indexed&#39;</span><span class="p">:</span><span class="kc">False</span><span class="p">,</span><span class="s1">&#39;shuffle&#39;</span><span class="p">:</span><span class="kc">False</span><span class="p">})</span>
    <span class="p">)</span><span class="o">.</span><span class="n">dataloaders</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">TypeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>object of type &#39;Source&#39; has no len()
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Ok... so how do get <code>dls</code> to iterate more than just the number of items? Well, the first issue is...</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span>TfmdLists.__iter__<span class="o">??</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea ">
<pre><span class="ansi-red-fg">Signature:</span> TfmdLists<span class="ansi-blue-fg">.</span>__iter__<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">)</span>
<span class="ansi-red-fg">Docstring:</span> &lt;no docstring&gt;
<span class="ansi-red-fg">Source:</span>        <span class="ansi-green-fg">def</span> __iter__<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span> <span class="ansi-green-fg">return</span> <span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">[</span>i<span class="ansi-blue-fg">]</span> <span class="ansi-green-fg">for</span> i <span class="ansi-green-fg">in</span> range<span class="ansi-blue-fg">(</span>len<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">)</span>
<span class="ansi-red-fg">File:</span>      ~/fastai/fastai/data/core.py
<span class="ansi-red-fg">Type:</span>      function
</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>And...</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span>Datasets.__iter__<span class="o">??</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea ">
<pre><span class="ansi-red-fg">Signature:</span> Datasets<span class="ansi-blue-fg">.</span>__iter__<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">)</span>
<span class="ansi-red-fg">Docstring:</span> &lt;no docstring&gt;
<span class="ansi-red-fg">Source:</span>        <span class="ansi-green-fg">def</span> __iter__<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span> <span class="ansi-green-fg">return</span> <span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">[</span>i<span class="ansi-blue-fg">]</span> <span class="ansi-green-fg">for</span> i <span class="ansi-green-fg">in</span> range<span class="ansi-blue-fg">(</span>len<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">)</span>
<span class="ansi-red-fg">File:</span>      ~/fastai/fastai/data/core.py
<span class="ansi-red-fg">Type:</span>      function
</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>So even though we have gone through the work to indicate that these items and the overall dataset does not have a length,
we still are constrained by a <code>len</code> call. This seems to be a fundamental issue with the <code>TfmdLists</code>. Maybe we can trick it into 
thinking there are <code>n</code> items when there really is only one...</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="IterableTfmdLists" class="doc_header"><code>class</code> <code>IterableTfmdLists</code><a href="https://github.com/josiahls/fastrl/tree/master/fastrl/data/block.py#L100" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>IterableTfmdLists</code>(<strong><code>items</code></strong>=<em><code>None</code></em>, <strong>*<code>rest</code></strong>, <strong><code>use_list</code></strong>=<em><code>False</code></em>, <strong><code>match</code></strong>=<em><code>None</code></em>) :: <code>TfmdLists</code></p>
</blockquote>
<p>A <code>Pipeline</code> of <code>tfms</code> applied to a collection of <code>items</code></p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="IterableDatasets" class="doc_header"><code>class</code> <code>IterableDatasets</code><a href="https://github.com/josiahls/fastrl/tree/master/fastrl/data/block.py#L103" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>IterableDatasets</code>(<strong><code>items</code></strong>=<em><code>None</code></em>, <strong><code>tfms</code></strong>=<em><code>None</code></em>, <strong><code>tls</code></strong>=<em><code>None</code></em>, <strong><code>n_inp</code></strong>=<em><code>None</code></em>, <strong><code>dl_type</code></strong>=<em><code>None</code></em>, <strong><code>use_list</code></strong>=<em><code>None</code></em>, <strong><code>do_setup</code></strong>=<em><code>True</code></em>, <strong><code>split_idx</code></strong>=<em><code>None</code></em>, <strong><code>train_setup</code></strong>=<em><code>True</code></em>, <strong><code>splits</code></strong>=<em><code>None</code></em>, <strong><code>types</code></strong>=<em><code>None</code></em>, <strong><code>verbose</code></strong>=<em><code>False</code></em>) :: <code>Datasets</code></p>
</blockquote>
<p>A dataset that creates a tuple from each <code>tfms</code></p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">cycle</span>

<span class="k">class</span> <span class="nc">IterableTfmdLists</span><span class="p">(</span><span class="n">TfmdLists</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="n">cycle</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)))</span>
    
<span class="k">class</span> <span class="nc">IterableDatasets</span><span class="p">(</span><span class="n">Datasets</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="n">cycle</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)))</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Now that we have a custom <code>TfmdLists</code> that will cycle through all the items, we need to modfy 
<code>DataBlock</code> and <code>Datasets</code> to accept these.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="IterableDataBlock" class="doc_header"><code>class</code> <code>IterableDataBlock</code><a href="https://github.com/josiahls/fastrl/tree/master/fastrl/data/block.py#L107" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>IterableDataBlock</code>(<strong><code>blocks</code></strong>=<em><code>None</code></em>, <strong><code>datasets_type</code></strong>=<em><code>None</code></em>, <strong><code>n_inp</code></strong>=<em><code>None</code></em>, <strong><code>dl_type</code></strong>=<em><code>None</code></em>, <strong><code>getters</code></strong>=<em><code>None</code></em>, <strong><code>item_tfms</code></strong>=<em><code>None</code></em>, <strong><code>batch_tfms</code></strong>=<em><code>None</code></em>, <strong><code>get_items</code></strong>=<em><code>None</code></em>, <strong><code>splitter</code></strong>=<em><code>None</code></em>, <strong><code>get_y</code></strong>=<em><code>None</code></em>, <strong><code>get_x</code></strong>=<em><code>None</code></em>) :: <code>DataBlock</code></p>
</blockquote>
<p>Generic container to quickly build <code>Datasets</code> and <code>DataLoaders</code></p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="Datasets.__init__" class="doc_header"><code>Datasets.__init__</code><a href="https://github.com/josiahls/fastrl/tree/master/fastrl/data/block.py#L128" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>Datasets.__init__</code>(<strong><code>items</code></strong>=<em><code>None</code></em>, <strong><code>tfms</code></strong>=<em><code>None</code></em>, <strong><code>tls</code></strong>=<em><code>None</code></em>, <strong><code>n_inp</code></strong>=<em><code>None</code></em>, <strong><code>dl_type</code></strong>=<em><code>None</code></em>, <strong><code>tl_type</code></strong>=<em><code>TfmdLists</code></em>, <strong>**<code>kwargs</code></strong>)</p>
</blockquote>
<p>Initialize self.  See help(type(self)) for accurate signature.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="TransformBlock" class="doc_header"><code>class</code> <code>TransformBlock</code><a href="https://github.com/fastai/fastai/tree/master/fastai/data/block.py#L13" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>TransformBlock</code>(<strong><code>type_tfms</code></strong>=<em><code>None</code></em>, <strong><code>item_tfms</code></strong>=<em><code>None</code></em>, <strong><code>batch_tfms</code></strong>=<em><code>None</code></em>, <strong><code>dl_type</code></strong>=<em><code>None</code></em>, <strong><code>dls_kwargs</code></strong>=<em><code>None</code></em>)</p>
</blockquote>
<p>A basic wrapper that links defaults transforms for the data block API</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">IterableDataBlock</span><span class="p">(</span><span class="n">DataBlock</span><span class="p">):</span>
    <span class="n">tl_type</span> <span class="o">=</span> <span class="n">TfmdLists</span>
    <span class="n">datasets_type</span> <span class="o">=</span> <span class="n">Datasets</span>

    <span class="nd">@delegates</span><span class="p">(</span><span class="n">DataBlock</span><span class="p">)</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">blocks</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">datasets_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">n_inp</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">blocks</span> <span class="o">=</span> <span class="n">L</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">blocks</span> <span class="k">if</span> <span class="n">blocks</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">blocks</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">blocks</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="s1">&#39;tl_type&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">tl_type</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">tl_type</span>
        <span class="k">if</span> <span class="n">datasets_type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">datasets_type</span><span class="o">=</span><span class="n">datasets_type</span>
        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">is_listy</span><span class="p">(</span><span class="n">blocks</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">blocks</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="n">n_inp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">n_inp</span><span class="o">=</span><span class="mi">0</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">blocks</span><span class="o">=</span><span class="n">blocks</span><span class="p">,</span><span class="n">n_inp</span><span class="o">=</span><span class="n">n_inp</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">datasets</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">source</span> <span class="o">=</span> <span class="n">source</span>                     <span class="p">;</span> <span class="n">pv</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Collecting items from </span><span class="si">{</span><span class="n">source</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>
        <span class="n">items</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_items</span> <span class="ow">or</span> <span class="n">noop</span><span class="p">)(</span><span class="n">source</span><span class="p">)</span> <span class="p">;</span> <span class="n">pv</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">items</span><span class="p">)</span><span class="si">}</span><span class="s2"> items&quot;</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>
        <span class="n">splits</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">splitter</span> <span class="ow">or</span> <span class="n">RandomSplitter</span><span class="p">())(</span><span class="n">items</span><span class="p">)</span>
<span class="c1">#         pv(f&quot;{len(splits)} datasets of sizes {&#39;,&#39;.join([str(len(s)) for s in splits])}&quot;, verbose)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">datasets_type</span><span class="p">(</span><span class="n">items</span><span class="p">,</span> <span class="n">tfms</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_combine_type_tfms</span><span class="p">(),</span> <span class="n">splits</span><span class="o">=</span><span class="n">splits</span><span class="p">,</span> <span class="n">dl_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dl_type</span><span class="p">,</span> 
                                  <span class="n">n_inp</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">n_inp</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span> <span class="n">tl_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tl_type</span><span class="p">)</span>

<span class="nd">@patch</span>
<span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span><span class="n">Datasets</span><span class="p">,</span> <span class="n">items</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tfms</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tls</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">n_inp</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dl_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">tl_type</span><span class="o">=</span><span class="n">TfmdLists</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="nb">super</span><span class="p">(</span><span class="n">Datasets</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">dl_type</span><span class="o">=</span><span class="n">dl_type</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">tls</span> <span class="o">=</span> <span class="n">L</span><span class="p">(</span><span class="n">tls</span> <span class="k">if</span> <span class="n">tls</span> <span class="k">else</span> <span class="p">[</span><span class="n">tl_type</span><span class="p">(</span><span class="n">items</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">L</span><span class="p">(</span><span class="n">ifnone</span><span class="p">(</span><span class="n">tfms</span><span class="p">,[</span><span class="kc">None</span><span class="p">]))])</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">n_inp</span> <span class="o">=</span> <span class="n">ifnone</span><span class="p">(</span><span class="n">n_inp</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tls</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
    
<span class="k">class</span> <span class="nc">TransformBlock</span><span class="p">():</span>
    <span class="s2">&quot;A basic wrapper that links defaults transforms for the data block API&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">type_tfms</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">item_tfms</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">batch_tfms</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dl_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dls_kwargs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tl_type</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">type_tfms</span>  <span class="o">=</span>            <span class="n">L</span><span class="p">(</span><span class="n">type_tfms</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">item_tfms</span>  <span class="o">=</span> <span class="n">ToTensor</span> <span class="o">+</span> <span class="n">L</span><span class="p">(</span><span class="n">item_tfms</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">batch_tfms</span> <span class="o">=</span>            <span class="n">L</span><span class="p">(</span><span class="n">batch_tfms</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dl_type</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">dls_kwargs</span> <span class="o">=</span> <span class="n">dl_type</span><span class="p">,({}</span> <span class="k">if</span> <span class="n">dls_kwargs</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">dls_kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tl_type</span> <span class="o">=</span> <span class="n">tl_type</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>So we have modified the fastai data block API to handle custom <code>TfmdList</code>s, let's try these out!</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="Source" class="doc_header"><code>class</code> <code>Source</code><a href="https://github.com/josiahls/fastrl/tree/master/fastrl/data/block.py#L52" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>Source</code>(<strong><code>cbs</code></strong>=<em><code>None</code></em>) :: <a href="/fastrl/callback.core.html#Loop"><code>Loop</code></a></p>
</blockquote>
<p>Inherit from this to have all attr accesses in <code>self._xtra</code> passed down to <code>self.default</code></p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">Source</span><span class="p">(</span><span class="n">Loop</span><span class="p">):</span>
    <span class="n">_loop</span><span class="o">=</span><span class="n">_loop</span>
    <span class="n">_events</span><span class="o">=</span><span class="n">source_events</span>
    <span class="n">_default</span><span class="o">=</span><span class="s1">&#39;source&#39;</span>    
    <span class="n">end_event</span><span class="o">=</span><span class="n">parse_events</span><span class="p">(</span><span class="n">_loop</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    
    <span class="nd">@delegates</span><span class="p">(</span><span class="n">Loop</span><span class="p">)</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">cbs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">cbs</span><span class="o">=</span><span class="n">cbs</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">store_attr</span><span class="p">(</span><span class="n">but</span><span class="o">=</span><span class="s1">&#39;cbs&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">idx</span><span class="o">=</span><span class="mi">0</span>
        
    <span class="k">def</span> <span class="nf">after_create</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">(</span><span class="s1">&#39;initialize&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;init&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>
        
    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">idx</span><span class="o">+=</span><span class="mi">1</span>
            <span class="bp">self</span><span class="p">(</span><span class="s1">&#39;do_step&#39;</span><span class="p">)</span>
            <span class="k">yield</span> <span class="p">{</span><span class="s1">&#39;this&#39;</span><span class="p">:</span><span class="n">torch</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="mi">5</span><span class="p">),</span><span class="bp">self</span><span class="o">.</span><span class="n">idx</span><span class="p">)}</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">mutli_recreate</span><span class="p">():</span>
    <span class="n">worker_id</span><span class="o">=</span><span class="n">get_worker_info</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">worker_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;reinit&#39;</span><span class="p">,</span><span class="n">worker_id</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">worker_id</span><span class="p">)</span>
        <span class="p">[</span><span class="n">worker_id</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">d</span><span class="o">.</span><span class="n">items</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">after_create</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">worker_id</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">d</span><span class="o">.</span><span class="n">items</span><span class="p">))]</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">source</span><span class="o">=</span><span class="n">Source</span><span class="p">()</span>
<span class="n">block</span><span class="o">=</span><span class="n">IterableDataBlock</span><span class="p">(</span>
    <span class="n">datasets_type</span><span class="o">=</span><span class="n">IterableDatasets</span><span class="p">,</span>
    <span class="n">get_items</span><span class="o">=</span><span class="k">lambda</span> <span class="n">o</span><span class="p">:[</span><span class="n">j</span><span class="o">.</span><span class="n">after_create</span><span class="p">()</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">o</span><span class="p">],</span>
    <span class="n">splitter</span><span class="o">=</span><span class="k">lambda</span> <span class="n">o</span><span class="p">:[[</span><span class="mi">0</span><span class="p">]],</span>
    <span class="n">blocks</span><span class="o">=</span><span class="n">TransformBlock</span><span class="p">(</span>
        <span class="n">type_tfms</span><span class="o">=</span><span class="k">lambda</span> <span class="n">o</span><span class="p">:</span><span class="nb">iter</span><span class="p">(</span><span class="n">o</span><span class="p">),</span>
        <span class="n">item_tfms</span><span class="o">=</span><span class="k">lambda</span> <span class="n">o</span><span class="p">:</span><span class="nb">next</span><span class="p">(</span><span class="n">o</span><span class="p">),</span>
        <span class="n">tl_type</span><span class="o">=</span><span class="n">IterableTfmdLists</span><span class="p">,</span>
        <span class="n">dls_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;indexed&#39;</span><span class="p">:</span><span class="kc">False</span><span class="p">,</span><span class="s1">&#39;shuffle&#39;</span><span class="p">:</span><span class="kc">False</span><span class="p">,</span><span class="s1">&#39;persistent_workers&#39;</span><span class="p">:</span><span class="kc">True</span><span class="p">,</span><span class="s1">&#39;pin_memory&#39;</span><span class="p">:</span><span class="kc">True</span><span class="p">}),</span>
<span class="p">)</span>
<span class="n">dls</span><span class="o">=</span><span class="n">block</span><span class="o">.</span><span class="n">dataloaders</span><span class="p">([</span><span class="n">source</span><span class="p">],</span><span class="n">n</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">bs</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span><span class="n">num_workers</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">wif</span><span class="o">=</span><span class="n">mutli_recreate</span><span class="p">)</span>
<span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">dls</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="nb">print</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">dls</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="nb">print</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Collecting items from [&lt;__main__.Source object at 0x7fcc3e90e160&gt;]
init
Found 1 items
Setting up Pipeline: &lt;lambda&gt;
Setting up after_item: Pipeline: &lt;lambda&gt; -&gt; ToTensor
Setting up before_batch: Pipeline: 
Setting up after_batch: Pipeline: 
reinit
 0
WorkerInfo(id=0, num_workers=2, seed=6483176774096658303, dataset=&lt;fastai.data.load._FakeLoader object at 0x7fcc3e936190&gt;)
initreinit 1

WorkerInfo(id=1, num_workers=2, seed=6483176774096658304, dataset=&lt;fastai.data.load._FakeLoader object at 0x7fcc3e936190&gt;)init
[{&#39;this&#39;: tensor([[[1, 1, 1, 1, 1]],

        [[2, 2, 2, 2, 2]],

        [[3, 3, 3, 3, 3]]], device=&#39;cuda:0&#39;)}]
[{&#39;this&#39;: tensor([[[1, 1, 1, 1, 1]],

        [[2, 2, 2, 2, 2]],

        [[3, 3, 3, 3, 3]]], device=&#39;cuda:0&#39;)}]
[{&#39;this&#39;: tensor([[[4, 4, 4, 4, 4]],

        [[5, 5, 5, 5, 5]],

        [[6, 6, 6, 6, 6]]], device=&#39;cuda:0&#39;)}]
[{&#39;this&#39;: tensor([[[4, 4, 4, 4, 4]]], device=&#39;cuda:0&#39;)}]
reinit 0
WorkerInfo(id=0, num_workers=2, seed=5213387086090605726, dataset=&lt;fastai.data.load._FakeLoader object at 0x7fcc3e936190&gt;)
init
reinit 1
WorkerInfo(id=1, num_workers=2, seed=5213387086090605727, dataset=&lt;fastai.data.load._FakeLoader object at 0x7fcc3e936190&gt;)
init
[{&#39;this&#39;: tensor([[[1, 1, 1, 1, 1]],

        [[2, 2, 2, 2, 2]],

        [[3, 3, 3, 3, 3]]], device=&#39;cuda:0&#39;)}]
[{&#39;this&#39;: tensor([[[1, 1, 1, 1, 1]],

        [[2, 2, 2, 2, 2]],

        [[3, 3, 3, 3, 3]]], device=&#39;cuda:0&#39;)}]
[{&#39;this&#39;: tensor([[[4, 4, 4, 4, 4]],

        [[5, 5, 5, 5, 5]],

        [[6, 6, 6, 6, 6]]], device=&#39;cuda:0&#39;)}]
[{&#39;this&#39;: tensor([[[4, 4, 4, 4, 4]]], device=&#39;cuda:0&#39;)}]
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Multi-Epoch-Iteration-Issues">Multi Epoch Iteration Issues<a class="anchor-link" href="#Multi-Epoch-Iteration-Issues"> </a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Great! Its iterating! But it seems to reset every iteration for some reason, i.e. It should just keep counting up...</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">dls</span><span class="o">=</span><span class="n">block</span><span class="o">.</span><span class="n">dataloaders</span><span class="p">([</span><span class="n">source</span><span class="p">],</span><span class="n">n</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">bs</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span><span class="n">num_workers</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">wif</span><span class="o">=</span><span class="n">mutli_recreate</span><span class="p">)</span>
<span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">dls</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="nb">print</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">dls</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="nb">print</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Collecting items from [&lt;__main__.Source object at 0x7fcc3e90e160&gt;]
init
Found 1 items
Setting up Pipeline: &lt;lambda&gt;
Setting up after_item: Pipeline: &lt;lambda&gt; -&gt; ToTensor
Setting up before_batch: Pipeline: 
Setting up after_batch: Pipeline: 
[{&#39;this&#39;: tensor([[[1, 1, 1, 1, 1]],

        [[2, 2, 2, 2, 2]],

        [[3, 3, 3, 3, 3]]], device=&#39;cuda:0&#39;)}]
[{&#39;this&#39;: tensor([[[4, 4, 4, 4, 4]],

        [[5, 5, 5, 5, 5]],

        [[6, 6, 6, 6, 6]]], device=&#39;cuda:0&#39;)}]
[{&#39;this&#39;: tensor([[[7, 7, 7, 7, 7]],

        [[8, 8, 8, 8, 8]],

        [[9, 9, 9, 9, 9]]], device=&#39;cuda:0&#39;)}]
[{&#39;this&#39;: tensor([[[10, 10, 10, 10, 10]]], device=&#39;cuda:0&#39;)}]
[{&#39;this&#39;: tensor([[[11, 11, 11, 11, 11]],

        [[12, 12, 12, 12, 12]],

        [[13, 13, 13, 13, 13]]], device=&#39;cuda:0&#39;)}]
[{&#39;this&#39;: tensor([[[14, 14, 14, 14, 14]],

        [[15, 15, 15, 15, 15]],

        [[16, 16, 16, 16, 16]]], device=&#39;cuda:0&#39;)}]
[{&#39;this&#39;: tensor([[[17, 17, 17, 17, 17]],

        [[18, 18, 18, 18, 18]],

        [[19, 19, 19, 19, 19]]], device=&#39;cuda:0&#39;)}]
[{&#39;this&#39;: tensor([[[20, 20, 20, 20, 20]]], device=&#39;cuda:0&#39;)}]
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>You will notice that the culprit seems to be related to whether the dataloader is
doing multiprocessing or not. Interestingly, it seems that persistent workers does not
work (?)
{% include important.html content='Note above' %}<br>
This is because of the line...</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span>DataLoader.__iter__<span class="o">??</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea ">
<pre><span class="ansi-red-fg">Signature:</span> DataLoader<span class="ansi-blue-fg">.</span>__iter__<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">)</span>
<span class="ansi-red-fg">Docstring:</span> &lt;no docstring&gt;
<span class="ansi-red-fg">Source:</span>   
    <span class="ansi-green-fg">def</span> __iter__<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>
        self<span class="ansi-blue-fg">.</span>randomize<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span>
        self<span class="ansi-blue-fg">.</span>before_iter<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span>
        self<span class="ansi-blue-fg">.</span>__idxs<span class="ansi-blue-fg">=</span>self<span class="ansi-blue-fg">.</span>get_idxs<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span> <span class="ansi-red-fg"># called in context of main process (not workers/subprocesses)</span>
        <span class="ansi-green-fg">for</span> b <span class="ansi-green-fg">in</span> _loaders<span class="ansi-blue-fg">[</span>self<span class="ansi-blue-fg">.</span>fake_l<span class="ansi-blue-fg">.</span>num_workers<span class="ansi-blue-fg">==</span><span class="ansi-cyan-fg">0</span><span class="ansi-blue-fg">]</span><span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">.</span>fake_l<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>
            <span class="ansi-green-fg">if</span> self<span class="ansi-blue-fg">.</span>device <span class="ansi-green-fg">is</span> <span class="ansi-green-fg">not</span> <span class="ansi-green-fg">None</span><span class="ansi-blue-fg">:</span> b <span class="ansi-blue-fg">=</span> to_device<span class="ansi-blue-fg">(</span>b<span class="ansi-blue-fg">,</span> self<span class="ansi-blue-fg">.</span>device<span class="ansi-blue-fg">)</span>
            <span class="ansi-green-fg">yield</span> self<span class="ansi-blue-fg">.</span>after_batch<span class="ansi-blue-fg">(</span>b<span class="ansi-blue-fg">)</span>
        self<span class="ansi-blue-fg">.</span>after_iter<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span>
        <span class="ansi-green-fg">if</span> hasattr<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">,</span> <span class="ansi-blue-fg">&#39;it&#39;</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span> <span class="ansi-green-fg">del</span><span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">.</span>it<span class="ansi-blue-fg">)</span>
<span class="ansi-red-fg">File:</span>      ~/fastai/fastai/data/load.py
<span class="ansi-red-fg">Type:</span>      function
</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>You will notice that the loader is redefined per iter. This will happen per epoch then.
Since the workers are tied to a dataloader, it may persist the worker between batches,
however it will not persist them between epochs. This is undesirable. We can try to fix this through by changing how loaders are
handled if persistant worker is set to true. You will find that this does not fix the issue due to core pytorch issues that will be illistrated later...</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Custom-collater's">Custom collater's<a class="anchor-link" href="#Custom-collater's"> </a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Finally, we need to change how collation is handled. Since we are returning batch-wise
dictionaries, we want to stack them. You will notice that the [[1,1,1,1]] get turned into [[[1,1,1,1]]].
We don't want this, so lets change it!</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="vstack_collate" class="doc_header"><code>vstack_collate</code><a href="https://github.com/josiahls/fastrl/tree/master/fastrl/data/block.py#L171" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>vstack_collate</code>(<strong><code>batch</code></strong>)</p>
</blockquote>
<p>99% similar to default_collate, however vstacks tensors thus assuming they already have a batch dim</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="fr_collate" class="doc_header"><code>fr_collate</code><a href="https://github.com/josiahls/fastrl/tree/master/fastrl/data/block.py#L219" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>fr_collate</code>(<strong><code>t</code></strong>)</p>
</blockquote>
<p>A replacement for PyTorch <code>default_collate</code> which maintains types and handles <code>Sequence</code>s</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">_collate_types</span> <span class="o">=</span> <span class="p">(</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">,</span> <span class="n">typing</span><span class="o">.</span><span class="n">Mapping</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">fr_collate</span><span class="p">(</span><span class="n">t</span><span class="p">):</span>
    <span class="s2">&quot;A replacement for PyTorch `default_collate` which maintains types and handles `Sequence`s&quot;</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">vstack_collate</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">_collate_types</span><span class="p">)</span>
            <span class="k">else</span> <span class="nb">type</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">])([</span><span class="n">fr_collate</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">t</span><span class="p">)])</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">)</span>
            <span class="k">else</span> <span class="n">vstack_collate</span><span class="p">(</span><span class="n">t</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>If the <code>num_worker &gt; 0</code> and <code>persistent_workers==True</code>, then we need to have the loaders be re-dfined outside
of the <strong>iter</strong> method.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="IterableTfmdDL" class="doc_header"><code>class</code> <code>IterableTfmdDL</code><a href="https://github.com/josiahls/fastrl/tree/master/fastrl/data/block.py#L230" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>IterableTfmdDL</code>(<strong><code>dataset</code></strong>, <strong><code>bs</code></strong>=<em><code>64</code></em>, <strong><code>shuffle</code></strong>=<em><code>False</code></em>, <strong><code>num_workers</code></strong>=<em><code>None</code></em>, <strong><code>verbose</code></strong>=<em><code>False</code></em>, <strong><code>do_setup</code></strong>=<em><code>True</code></em>, <strong>**<code>kwargs</code></strong>) :: <code>TfmdDL</code></p>
</blockquote>
<p>Transformed <code>DataLoader</code></p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">fastai.data.load</span> <span class="kn">import</span> <span class="n">_loaders</span>

<span class="k">class</span> <span class="nc">IterableTfmdDL</span><span class="p">(</span><span class="n">TfmdDL</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataset</span><span class="p">,</span><span class="n">bs</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">num_workers</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">do_setup</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">bs</span><span class="o">=</span><span class="n">bs</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="n">shuffle</span><span class="p">,</span> <span class="n">num_workers</span><span class="o">=</span><span class="n">num_workers</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_loader</span><span class="o">=</span><span class="kc">None</span>
        
    <span class="k">def</span> <span class="nf">create_batch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span> <span class="k">return</span> <span class="p">(</span><span class="n">fr_collate</span><span class="p">,</span><span class="n">fa_convert</span><span class="p">)[</span><span class="bp">self</span><span class="o">.</span><span class="n">prebatched</span><span class="p">](</span><span class="n">b</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Pytorch-persistent-worker-Limitation">Pytorch persistent worker Limitation<a class="anchor-link" href="#Pytorch-persistent-worker-Limitation"> </a></h3><blockquote><p>This is probably the worst part of the RL &lt;-&gt; Pytorch issue.</p>
</blockquote>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>I thought that:</p>

<pre><code>- If self.num_workers &gt; 0
- And fake_l.persistent_workers==True

</code></pre>
<p>All I needed to do was make sure fastai doesn't destroy dls if these above cases were
true. The below code that would be added to <a href="/fastrl/data.block.html#IterableTfmdDL"><code>IterableTfmdDL</code></a> would have fixed this.</p>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">sample</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> 
        <span class="k">return</span> <span class="p">(</span><span class="n">b</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">b</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__idxs</span><span class="p">)</span> <span class="k">if</span> <span class="n">i</span><span class="o">//</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bs</span> <span class="ow">or</span> <span class="mi">1</span><span class="p">)</span><span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">num_workers</span><span class="o">==</span><span class="bp">self</span><span class="o">.</span><span class="n">offs</span><span class="p">)</span>


    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">randomize</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">before_iter</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__idxs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_idxs</span><span class="p">()</span> <span class="c1"># called in context of main process (not workers/subprocesses)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fake_l</span><span class="o">.</span><span class="n">num_workers</span><span class="o">&gt;</span><span class="mi">0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">fake_l</span><span class="o">.</span><span class="n">persistent_workers</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_loader</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_loader</span><span class="o">=</span><span class="n">_loaders</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">fake_l</span><span class="o">.</span><span class="n">num_workers</span><span class="o">==</span><span class="mi">0</span><span class="p">](</span><span class="bp">self</span><span class="o">.</span><span class="n">fake_l</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">ifnone</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_loader</span><span class="p">,</span><span class="n">_loaders</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">fake_l</span><span class="o">.</span><span class="n">num_workers</span><span class="o">==</span><span class="mi">0</span><span class="p">](</span><span class="bp">self</span><span class="o">.</span><span class="n">fake_l</span><span class="p">)):</span>
<span class="c1">#         for b in _loaders[self.fake_l.num_workers==0](self.fake_l):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">b</span> <span class="o">=</span> <span class="n">to_device</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
            <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">after_batch</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">after_iter</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;it&#39;</span><span class="p">):</span> <span class="k">del</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">it</span><span class="p">)</span>
</pre></div>
<p>This doesn't fix the issue.</p>
<p>Per <a href="https://pytorch.org/docs/stable/data.html">https://pytorch.org/docs/stable/data.html</a>:</p>

<pre><code>persistent_workers (bool, optional) – If True, the data loader will not shutdown the 
                                      worker processes after a dataset has been consumed once. 
                                      This allows to maintain the workers Dataset instances 
                                      alive. (default: False)

</code></pre>
<p>Iterable datasets don't get "consumed" bsaed on if an environment is done. They can consumed
if the dataset reaches an arbitrary length. This means that an agent might be in the middle of 
executing an episode, and the dataset will end, and next epoch will start from scratch.</p>
<p>The is really bad <strong>unless</strong> the user does not use multiprocessing at all, or
we make "n" really really big, so that we can get a few full episodes completed.</p>
<p>Overall, it would be better to get workers to persist between epochs.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Learner-compat">Learner compat<a class="anchor-link" href="#Learner-compat"> </a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Let's try to plug this into a <code>Learner</code> then...</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">torch.nn</span> <span class="kn">import</span> <span class="n">Linear</span>

<span class="k">class</span> <span class="nc">FakeModel</span><span class="p">(</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fc</span><span class="o">=</span><span class="n">Linear</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">x</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;this&#39;</span><span class="p">]</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span>IterableDataBlock<span class="o">??</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea ">
<pre><span class="ansi-red-fg">Init signature:</span>
IterableDataBlock<span class="ansi-blue-fg">(</span>
    blocks<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">None</span><span class="ansi-blue-fg">,</span>
    datasets_type<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">None</span><span class="ansi-blue-fg">,</span>
    n_inp<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">None</span><span class="ansi-blue-fg">,</span>
    dl_type<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">None</span><span class="ansi-blue-fg">,</span>
    getters<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">None</span><span class="ansi-blue-fg">,</span>
    item_tfms<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">None</span><span class="ansi-blue-fg">,</span>
    batch_tfms<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">None</span><span class="ansi-blue-fg">,</span>
    <span class="ansi-blue-fg">*</span><span class="ansi-blue-fg">,</span>
    get_items<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">None</span><span class="ansi-blue-fg">,</span>
    splitter<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">None</span><span class="ansi-blue-fg">,</span>
    get_y<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">None</span><span class="ansi-blue-fg">,</span>
    get_x<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">None</span><span class="ansi-blue-fg">,</span>
<span class="ansi-blue-fg">)</span>
<span class="ansi-red-fg">Docstring:</span>      Generic container to quickly build `Datasets` and `DataLoaders`
<span class="ansi-red-fg">Type:</span>           type
<span class="ansi-red-fg">Subclasses:</span>     
</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span>TransformBlock<span class="o">??</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea ">
<pre><span class="ansi-red-fg">Init signature:</span>
TransformBlock<span class="ansi-blue-fg">(</span>
    type_tfms<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">None</span><span class="ansi-blue-fg">,</span>
    item_tfms<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">None</span><span class="ansi-blue-fg">,</span>
    batch_tfms<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">None</span><span class="ansi-blue-fg">,</span>
    dl_type<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">None</span><span class="ansi-blue-fg">,</span>
    dls_kwargs<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">None</span><span class="ansi-blue-fg">,</span>
    tl_type<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">None</span><span class="ansi-blue-fg">,</span>
<span class="ansi-blue-fg">)</span>
<span class="ansi-red-fg">Docstring:</span>      A basic wrapper that links defaults transforms for the data block API
<span class="ansi-red-fg">Type:</span>           type
<span class="ansi-red-fg">Subclasses:</span>     
</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="get_sources" class="doc_header"><code>get_sources</code><a href="https://github.com/josiahls/fastrl/tree/master/fastrl/data/block.py#L238" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>get_sources</code>(<strong><code>_</code></strong>, <strong><code>ls</code></strong>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="SourceDataBlock" class="doc_header"><code>class</code> <code>SourceDataBlock</code><a href="https://github.com/josiahls/fastrl/tree/master/fastrl/data/block.py#L240" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>SourceDataBlock</code>(<strong><code>blocks</code></strong>=<em><code>None</code></em>, <strong><code>datasets_type</code></strong>=<em><code>None</code></em>, <strong><code>n_inp</code></strong>=<em><code>None</code></em>, <strong><code>dl_type</code></strong>=<em><code>None</code></em>, <strong><code>getters</code></strong>=<em><code>None</code></em>, <strong><code>item_tfms</code></strong>=<em><code>None</code></em>, <strong><code>batch_tfms</code></strong>=<em><code>None</code></em>, <strong><code>get_items</code></strong>=<em><code>None</code></em>, <strong><code>splitter</code></strong>=<em><code>None</code></em>, <strong><code>get_y</code></strong>=<em><code>None</code></em>, <strong><code>get_x</code></strong>=<em><code>None</code></em>) :: <a href="/fastrl/data.block.html#IterableDataBlock"><code>IterableDataBlock</code></a></p>
</blockquote>
<p>Generic container to quickly build <code>Datasets</code> and <code>DataLoaders</code></p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">get_sources</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">ls</span><span class="p">):</span> <span class="k">return</span> <span class="p">[</span><span class="n">o</span><span class="o">.</span><span class="n">after_create</span><span class="p">()</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">ls</span><span class="p">]</span>

<span class="k">class</span> <span class="nc">SourceDataBlock</span><span class="p">(</span><span class="n">IterableDataBlock</span><span class="p">):</span>
    <span class="n">datasets_type</span><span class="o">=</span><span class="n">IterableDatasets</span>
    <span class="n">get_items</span><span class="o">=</span><span class="n">get_sources</span>
    <span class="n">blocks</span><span class="o">=</span><span class="n">TransformBlock</span><span class="p">(</span>
        <span class="n">type_tfms</span><span class="o">=</span><span class="p">[</span><span class="k">lambda</span> <span class="n">o</span><span class="p">:</span><span class="nb">iter</span><span class="p">(</span><span class="n">o</span><span class="p">)],</span>
        <span class="n">item_tfms</span><span class="o">=</span><span class="k">lambda</span> <span class="n">o</span><span class="p">:</span><span class="nb">next</span><span class="p">(</span><span class="n">o</span><span class="p">),</span>
        <span class="n">tl_type</span><span class="o">=</span><span class="n">IterableTfmdLists</span><span class="p">,</span>
        <span class="n">dl_type</span><span class="o">=</span><span class="n">IterableTfmdDL</span><span class="p">,</span>
        <span class="n">dls_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;indexed&#39;</span><span class="p">:</span><span class="kc">False</span><span class="p">,</span><span class="s1">&#39;shuffle&#39;</span><span class="p">:</span><span class="kc">False</span><span class="p">,</span><span class="s1">&#39;persistent_workers&#39;</span><span class="p">:</span><span class="kc">True</span><span class="p">})</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>In addition to above, we also don't want to run evaluation epochs since there isn't a simple
way to split envirnoments between those 2 phases. Maybe in the near future we can have this...</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Another augmentation we need to do is allow metrics to be run during training time...</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="Callback.after_create" class="doc_header"><code>Callback.after_create</code><a href="https://github.com/josiahls/fastrl/tree/master/fastrl/data/block.py#L255" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>Callback.after_create</code>()</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Since a lot of the learners will only have the <code>xb</code> field populated, we need look at
the len of xb also</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="Recorder.after_batch" class="doc_header"><code>Recorder.after_batch</code><a href="https://github.com/josiahls/fastrl/tree/master/fastrl/data/block.py#L262" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>Recorder.after_batch</code>()</p>
</blockquote>
<p>Update all metrics and records lr and smooth loss in training</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">source</span><span class="o">=</span><span class="n">Source</span><span class="p">(</span><span class="n">cbs</span><span class="o">=</span><span class="n">VerboseChecked</span><span class="p">)</span>
<span class="n">block</span><span class="o">=</span><span class="n">SourceDataBlock</span><span class="p">()</span>
<span class="n">dls</span><span class="o">=</span><span class="n">block</span><span class="o">.</span><span class="n">dataloaders</span><span class="p">([</span><span class="n">source</span><span class="p">],</span><span class="n">n</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span><span class="n">bs</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">num_workers</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Collecting items from [&lt;__main__.Source object at 0x7fcc4cc78cd0&gt;]
Worker id:  0
WalkerBase::__init__
init
Found 1 items
Setting up Pipeline: SourceDataBlock.&lt;lambda&gt;
Could not do one pass in your dataloader, there is something wrong in it
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learn</span><span class="o">=</span><span class="n">Learner</span><span class="p">(</span><span class="n">dls</span><span class="p">,</span><span class="n">FakeModel</span><span class="p">(),</span><span class="n">loss_func</span><span class="o">=</span><span class="k">lambda</span> <span class="n">o</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learn</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea ">
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: left;">
      <th>epoch</th>
      <th>train_loss</th>
      <th>valid_loss</th>
      <th>time</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>0.000000</td>
      <td>00:00</td>
    </tr>
    <tr>
      <td>1</td>
      <td>0.000000</td>
      <td>00:00</td>
    </tr>
    <tr>
      <td>2</td>
      <td>0.000000</td>
      <td>00:00</td>
    </tr>
    <tr>
      <td>3</td>
      <td>0.000000</td>
      <td>00:00</td>
    </tr>
  </tbody>
</table>
</div>

</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Env Id:  140515438200336
Env Id:  140515438200336
{&#39;this&#39;: tensor([[1, 1, 1, 1, 1],
        [2, 2, 2, 2, 2]], device=&#39;cuda:0&#39;)}
Env Id:  140515438200336
Env Id:  140515438200336
{&#39;this&#39;: tensor([[3, 3, 3, 3, 3],
        [4, 4, 4, 4, 4]], device=&#39;cuda:0&#39;)}
Env Id:  140515438200336
{&#39;this&#39;: tensor([[5, 5, 5, 5, 5]], device=&#39;cuda:0&#39;)}
Env Id:  140515438200336
Env Id:  140515438200336
{&#39;this&#39;: tensor([[6, 6, 6, 6, 6],
        [7, 7, 7, 7, 7]], device=&#39;cuda:0&#39;)}
Env Id:  140515438200336
Env Id:  140515438200336
{&#39;this&#39;: tensor([[8, 8, 8, 8, 8],
        [9, 9, 9, 9, 9]], device=&#39;cuda:0&#39;)}
Env Id:  140515438200336
{&#39;this&#39;: tensor([[10, 10, 10, 10, 10]], device=&#39;cuda:0&#39;)}
Env Id:  140515438200336
Env Id:  140515438200336
{&#39;this&#39;: tensor([[11, 11, 11, 11, 11],
        [12, 12, 12, 12, 12]], device=&#39;cuda:0&#39;)}
Env Id:  140515438200336
Env Id:  140515438200336
{&#39;this&#39;: tensor([[13, 13, 13, 13, 13],
        [14, 14, 14, 14, 14]], device=&#39;cuda:0&#39;)}
Env Id:  140515438200336
{&#39;this&#39;: tensor([[15, 15, 15, 15, 15]], device=&#39;cuda:0&#39;)}
Env Id:  140515438200336
Env Id:  140515438200336
{&#39;this&#39;: tensor([[16, 16, 16, 16, 16],
        [17, 17, 17, 17, 17]], device=&#39;cuda:0&#39;)}
Env Id:  140515438200336
Env Id:  140515438200336
{&#39;this&#39;: tensor([[18, 18, 18, 18, 18],
        [19, 19, 19, 19, 19]], device=&#39;cuda:0&#39;)}
Env Id:  140515438200336
{&#39;this&#39;: tensor([[20, 20, 20, 20, 20]], device=&#39;cuda:0&#39;)}
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>This looks good, however because of the <code>persistent worker's</code> issue, if we have <code>num_workers&gt;&gt;0</code>...</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">source</span><span class="o">=</span><span class="n">Source</span><span class="p">(</span><span class="n">cbs</span><span class="o">=</span><span class="n">VerboseChecked</span><span class="p">)</span>
<span class="n">dls</span><span class="o">=</span><span class="n">block</span><span class="o">.</span><span class="n">dataloaders</span><span class="p">([</span><span class="n">source</span><span class="p">],</span><span class="n">n</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span><span class="n">bs</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">num_workers</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">learn</span><span class="o">=</span><span class="n">Learner</span><span class="p">(</span><span class="n">dls</span><span class="p">,</span><span class="n">FakeModel</span><span class="p">(),</span><span class="n">loss_func</span><span class="o">=</span><span class="k">lambda</span> <span class="n">o</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">)</span>
<span class="n">learn</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Collecting items from [&lt;__main__.Source object at 0x7fcc3e910730&gt;]
Worker id:  0
WalkerBase::__init__
init
Found 1 items
Setting up Pipeline: SourceDataBlock.&lt;lambda&gt;
Could not do one pass in your dataloader, there is something wrong in it
</pre>
</div>
</div>

<div class="output_area">


<div class="output_html rendered_html output_subarea ">
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: left;">
      <th>epoch</th>
      <th>train_loss</th>
      <th>valid_loss</th>
      <th>time</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>0.000000</td>
      <td>00:00</td>
    </tr>
    <tr>
      <td>1</td>
      <td>0.000000</td>
      <td>00:00</td>
    </tr>
    <tr>
      <td>2</td>
      <td>0.000000</td>
      <td>00:00</td>
    </tr>
    <tr>
      <td>3</td>
      <td>0.000000</td>
      <td>00:00</td>
    </tr>
  </tbody>
</table>
</div>

</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Env Id:  140515425760160
Env Id: Env Id:   140515425760160
140515425760160Env Id: 
Env Id:  140515425760160
{&#39;this&#39;: tensor([[1, 1, 1, 1, 1],
        [2, 2, 2, 2, 2]], device=&#39;cuda:0&#39;)}
 140515425760160
{&#39;this&#39;: tensor([[1, 1, 1, 1, 1],
        [2, 2, 2, 2, 2]], device=&#39;cuda:0&#39;)}
{&#39;this&#39;: tensor([[3, 3, 3, 3, 3]], device=&#39;cuda:0&#39;)}
Env Id:  140515425760160
Env Id:  140515425760160
Env Id:  Env Id: 140515425760160 
140515425760160
{&#39;this&#39;: tensor([[1, 1, 1, 1, 1],
        [2, 2, 2, 2, 2]], device=&#39;cuda:0&#39;)}
Env Id:  140515425760160
{&#39;this&#39;: tensor([[1, 1, 1, 1, 1],
        [2, 2, 2, 2, 2]], device=&#39;cuda:0&#39;)}
{&#39;this&#39;: tensor([[3, 3, 3, 3, 3]], device=&#39;cuda:0&#39;)}
Env Id:  140515425760160
Env Id:  Env Id: 140515425760160
Env Id:   140515425760160140515425760160
Env Id:  140515425760160
{&#39;this&#39;: tensor([[1, 1, 1, 1, 1],
        [2, 2, 2, 2, 2]], device=&#39;cuda:0&#39;)}
{&#39;this&#39;: tensor([[1, 1, 1, 1, 1],
        [2, 2, 2, 2, 2]], device=&#39;cuda:0&#39;)}

{&#39;this&#39;: tensor([[3, 3, 3, 3, 3]], device=&#39;cuda:0&#39;)}
Env Id:  140515425760160
Env Id:  Env Id:  140515425760160140515425760160

Env Id:  Env Id: 140515425760160 
140515425760160
{&#39;this&#39;: tensor([[1, 1, 1, 1, 1],
        [2, 2, 2, 2, 2]], device=&#39;cuda:0&#39;)}
{&#39;this&#39;: tensor([[1, 1, 1, 1, 1],
        [2, 2, 2, 2, 2]], device=&#39;cuda:0&#39;)}
{&#39;this&#39;: tensor([[3, 3, 3, 3, 3]], device=&#39;cuda:0&#39;)}
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Yeah... so you will notice that the <code>source</code> object seems to be reset every epoch... This is because the workers
are being re-created between epochs.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Conclusion">Conclusion<a class="anchor-link" href="#Conclusion"> </a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Getting fastai API to work with RL environments isn't too bad. I am looking forward to v3.
The ultamate scary blocker is that fact persistent workers are not persistent for the dl's 
life cycle, but instead are persistent for a dl's iteration.</p>
<p>For now, the most efficient way to run an agent is with <code>num_workers==0</code>. I would be interested
in fixing this however.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Export">Export<a class="anchor-link" href="#Export"> </a></h2>
</div>
</div>
</div>
</div>
 

