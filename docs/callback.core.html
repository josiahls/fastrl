---

title: Callback Core


keywords: fastai
sidebar: home_sidebar

summary: "Exntensions of the fastai learner training loop API for Agents and Sources"
description: "Exntensions of the fastai learner training loop API for Agents and Sources"
nb_path: "nbs/03_callback.core.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: nbs/03_callback.core.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">fastai.learner</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">fastai.test_utils</span> <span class="kn">import</span> <span class="o">*</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The fastai learner has a training loop that looks like...</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">synth_learner</span><span class="p">()</span><span class="o">.</span><span class="n">show_training_loop</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Start Fit
   - before_fit     : [TrainEvalCallback, Recorder]
  Start Epoch Loop
     - before_epoch   : [Recorder]
    Start Train
       - before_train   : [TrainEvalCallback, Recorder]
      Start Batch Loop
         - before_batch   : []
         - after_pred     : []
         - after_loss     : []
         - before_backward: []
         - before_step    : []
         - after_step     : []
         - after_cancel_batch: []
         - after_batch    : [TrainEvalCallback, Recorder]
      End Batch Loop
    End Train
     - after_cancel_train: [Recorder]
     - after_train    : [Recorder]
    Start Valid
       - before_validate: [TrainEvalCallback, Recorder]
      Start Batch Loop
         - **CBs same as train batch**: []
      End Batch Loop
    End Valid
     - after_cancel_validate: [Recorder]
     - after_validate : [Recorder]
  End Epoch Loop
   - after_cancel_epoch: []
   - after_epoch    : [Recorder]
End Fit
 - after_cancel_fit: []
 - after_fit      : []
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>It would be great to have this as a generic object that other parts of fastrl can leverage.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="Loop" class="doc_header"><code>class</code> <code>Loop</code><a href="https://github.com/josiahls/fastrl/tree/master/fastrl/callback/core.py#L26" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>Loop</code>(<strong><code>cbs</code></strong>=<em><code>None</code></em>, <strong><code>persistent</code></strong>=<em><code>False</code></em>, <strong>**<code>kwargs</code></strong>) :: <code>GetAttr</code></p>
</blockquote>
<p>Inherit from this to have all attr accesses in <code>self._xtra</code> passed down to <code>self.default</code></p>
<p><strong>Parameters:</strong></p>
<ul>
<li><p><strong><code>cbs</code></strong> : <em><code>&lt;class 'NoneType'&gt;</code></em>, <em>optional</em></p>
</li>
<li><p><strong><code>persistent</code></strong> : <em><code>&lt;class 'bool'&gt;</code></em>, <em>optional</em></p>
</li>
<li><p><strong><code>kwargs</code></strong> : <em><code>&lt;class 'inspect._empty'&gt;</code></em></p>
</li>
</ul>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Ok so lets try about making a custom callback loop!</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">_events</span> <span class="o">=</span> <span class="n">L</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;create do_this then_this and_finally_this&#39;</span><span class="p">)</span>
<span class="n">_events</span> <span class="o">=</span> <span class="n">_events</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">s</span><span class="p">:</span><span class="s1">&#39;cancel_&#39;</span><span class="o">+</span><span class="n">s</span><span class="p">)</span><span class="o">+</span> <span class="n">_events</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">s</span><span class="p">:</span><span class="s1">&#39;before_&#39;</span><span class="o">+</span><span class="n">s</span><span class="p">)</span> <span class="o">+</span> <span class="n">_events</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">s</span><span class="p">:</span><span class="s1">&#39;after_&#39;</span><span class="o">+</span><span class="n">s</span><span class="p">)</span>
<span class="n">mk_class</span><span class="p">(</span><span class="s1">&#39;test_event&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">_events</span><span class="o">.</span><span class="n">map_dict</span><span class="p">(),</span>
         <span class="n">doc</span><span class="o">=</span><span class="s2">&quot;All possible events as attributes to get tab-completion and typo-proofing&quot;</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">TstLooper</span><span class="p">(</span><span class="n">Loop</span><span class="p">):</span>
    <span class="n">_events</span><span class="o">=</span><span class="n">test_event</span>
    <span class="n">_loop</span><span class="o">=</span><span class="n">L</span><span class="p">([</span><span class="s1">&#39;Start doing this&#39;</span><span class="p">,</span><span class="s1">&#39;before_do_this&#39;</span><span class="p">,</span><span class="s1">&#39;after_do_this&#39;</span><span class="p">,</span><span class="s1">&#39;End doing this&#39;</span><span class="p">,</span>
             <span class="s1">&#39;Start then doing this&#39;</span><span class="p">,</span><span class="s1">&#39;before_then_this&#39;</span><span class="p">,</span><span class="s1">&#39;after_then_this&#39;</span><span class="p">,</span>
             <span class="s1">&#39;Start finally this&#39;</span><span class="p">,</span><span class="s1">&#39;before_and_finally_this&#39;</span><span class="p">,</span><span class="s1">&#39;after_and_finally_this&#39;</span><span class="p">,</span>
             <span class="s1">&#39;End finally this&#39;</span><span class="p">,</span><span class="s1">&#39;End doing this&#39;</span><span class="p">])</span>
    <span class="k">def</span> <span class="nf">do_this</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>          <span class="k">return</span>
    <span class="k">def</span> <span class="nf">then_this</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>        <span class="k">return</span>
    <span class="k">def</span> <span class="nf">and_finally_this</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> 
    
    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_with_events</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">do_this</span><span class="p">,</span><span class="s1">&#39;do_this&#39;</span><span class="p">,</span><span class="ne">Exception</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_with_events</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">then_this</span><span class="p">,</span><span class="s1">&#39;then_this&#39;</span><span class="p">,</span><span class="ne">Exception</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_with_events</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">and_finally_this</span><span class="p">,</span><span class="s1">&#39;and_finally_this&#39;</span><span class="p">,</span><span class="ne">Exception</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">TstLooper</span><span class="p">()</span><span class="o">.</span><span class="n">show_loop</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Start doing this
   - before_do_this : []
   - after_do_this  : []
End doing this
Start then doing this
   - before_then_this: []
   - after_then_this: []
  Start finally this
     - before_and_finally_this: []
     - after_and_finally_this: []
  End finally this
End doing this
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Ok so we have a custom callback loop, now we want to have some callbacks that get executed!</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="LoopCallback" class="doc_header"><code>class</code> <code>LoopCallback</code><a href="https://github.com/josiahls/fastrl/tree/master/fastrl/callback/core.py#L105" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>LoopCallback</code>() :: <code>Stateful</code></p>
</blockquote>
<p>Basic class handling tweaks of a callback loop by changing a <code>obj</code> in various events</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>For a custom callback looper, we need 2 things: <code>_events</code> and <code>_inner_loop</code>.
If an event is in the <code>_inner_loop</code> then we want to skip executing it since it is going to be 
manually executed by some other event.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">_events</span> <span class="o">=</span> <span class="n">L</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;create do_this then_this and_finally_this&#39;</span><span class="p">)</span>
<span class="n">_events</span> <span class="o">=</span> <span class="n">_events</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">s</span><span class="p">:</span><span class="s1">&#39;cancel_&#39;</span><span class="o">+</span><span class="n">s</span><span class="p">)</span><span class="o">+</span> <span class="n">_events</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">s</span><span class="p">:</span><span class="s1">&#39;before_&#39;</span><span class="o">+</span><span class="n">s</span><span class="p">)</span> <span class="o">+</span> <span class="n">_events</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">s</span><span class="p">:</span><span class="s1">&#39;after_&#39;</span><span class="o">+</span><span class="n">s</span><span class="p">)</span>
<span class="n">mk_class</span><span class="p">(</span><span class="s1">&#39;event&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">_events</span><span class="o">.</span><span class="n">map_dict</span><span class="p">(),</span>
         <span class="n">doc</span><span class="o">=</span><span class="s2">&quot;All possible events as attributes to get tab-completion and typo-proofing&quot;</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">CustomCallback</span><span class="p">(</span><span class="n">LoopCallback</span><span class="p">):</span>
    <span class="n">_default</span><span class="p">,</span><span class="n">some_obj</span><span class="o">=</span><span class="s1">&#39;some_class&#39;</span><span class="p">,</span><span class="kc">None</span>
    <span class="n">_methods</span><span class="o">=</span><span class="n">_events</span>

<span class="c1">#     def do_this(self):          return print(&#39;do_this&#39;)</span>
<span class="c1">#     def then_this(self):        return print(&#39;then_this&#39;)</span>
<span class="c1">#     def and_finally_this(self): return print(&#39;and_finally_this&#39;)</span>
    <span class="k">def</span> <span class="nf">before_do_this</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>          <span class="k">return</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;before_do_this&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">before_then_this</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>        <span class="k">return</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;before_then_this&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">before_and_finally_this</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;before_and_finally_this&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">after_do_this</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>           <span class="k">return</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;after_do_this&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">after_then_this</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>         <span class="k">return</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;after_then_this&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">after_and_finally_this</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>  <span class="k">return</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;after_and_finally_this&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">CustomCallback</span><span class="p">()</span><span class="o">.</span><span class="n">_methods</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>(#12) [&#39;cancel_create&#39;,&#39;cancel_do_this&#39;,&#39;cancel_then_this&#39;,&#39;cancel_and_finally_this&#39;,&#39;before_create&#39;,&#39;before_do_this&#39;,&#39;before_then_this&#39;,&#39;before_and_finally_this&#39;,&#39;after_create&#39;,&#39;after_do_this&#39;...]</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">TstLooper</span><span class="p">()</span><span class="o">.</span><span class="n">do_this</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">looper</span><span class="o">=</span><span class="n">TstLooper</span><span class="p">(</span><span class="n">cbs</span><span class="o">=</span><span class="n">CustomCallback</span><span class="p">())</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">looper</span><span class="o">.</span><span class="n">show_loop</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Start doing this
   - before_do_this : [CustomCallback]
   - after_do_this  : [CustomCallback]
End doing this
Start then doing this
   - before_then_this: [CustomCallback]
   - after_then_this: [CustomCallback]
  Start finally this
     - before_and_finally_this: [CustomCallback]
     - after_and_finally_this: [CustomCallback]
  End finally this
End doing this
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">looper</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>before_do_this
after_do_this
before_then_this
after_then_this
before_and_finally_this
after_and_finally_this
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

</div>
 

